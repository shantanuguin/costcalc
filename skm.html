<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sidney Apparels - Operator Performance System v13</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --accent-color: #f72585;
            --success-color: #4cc9f0;
            --warning-color: #f8961e;
            --dark-bg: #0a0e17;
            --card-bg: rgba(255, 255, 255, 0.1);
            --card-border: rgba(255, 255, 255, 0.2);
            --text-primary: #ffffff;
            --text-secondary: #b0b7c3;
            --dropdown-bg: rgba(30, 35, 50, 0.95);
            --dropdown-hover: rgba(67, 97, 238, 0.5);
            --dropdown-text: #ffffff;
            --glow: 0 8px 32px rgba(67, 97, 238, 0.2);
            --transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #0a0e17 0%, #1a1f35 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(circle at 20% 80%, rgba(67, 97, 238, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(248, 37, 133, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(76, 201, 240, 0.1) 0%, transparent 50%);
            z-index: -1;
        }

        /* UPDATED: Container with left sidebar */
        .container {
            display: flex;
            max-width: 100%;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        /* NEW: Sidebar Navigation - UPDATED for mobile */
        .sidebar {
            width: 240px;
            background: rgba(10, 14, 23, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px 0;
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            z-index: 1000;
            overflow-y: auto;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            box-shadow: 0 4px 15px rgba(67, 97, 238, 0.4);
        }

        .logo-text h1 {
            font-size: 1.2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #ffffff, #b0b7c3);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 2px;
        }

        .logo-text h2 {
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 5px;
            flex: 1;
        }

        .nav-item {
            padding: 12px 20px;
            color: var(--text-secondary);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px;
            border-radius: 8px;
            margin: 0 10px;
            transition: var(--transition);
            cursor: pointer;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: auto;
        }

        .current-time {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 10px;
        }

        .last-updated {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-align: center;
        }

        /* Main content area */
        .main-content-area {
            flex: 1;
            margin-left: 240px;
            padding: 20px;
            overflow-x: auto;
            transition: var(--transition);
        }

        /* Updated Header - Simplified */
        .header {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--card-border);
            border-radius: 15px;
            padding: 15px 25px;
            margin-bottom: 20px;
            box-shadow: var(--glow);
            position: relative;
            overflow: hidden;
            animation: slideDown 0.6s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            border-radius: 15px 15px 0 0;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-info {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 16px;
            background: linear-gradient(135deg, rgba(67, 97, 238, 0.1), rgba(76, 201, 240, 0.05));
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            font-size: 0.85rem;
            min-width: 150px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transition: var(--transition);
        }

        .info-item:hover {
            background: linear-gradient(135deg, rgba(67, 97, 238, 0.15), rgba(76, 201, 240, 0.1));
            border-color: rgba(67, 97, 238, 0.3);
            transform: translateY(-2px);
        }

        .info-item i {
            color: var(--primary-color);
            font-size: 1rem;
            width: 20px;
        }

        .info-item-content {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .info-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .info-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        .realtime-clock {
            font-family: 'Courier New', monospace;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-color);
            letter-spacing: 1px;
        }

        .last-updated-time {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        /* Controls Panel */
        .controls-panel {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--card-border);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--glow);
        }

        .search-filter {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            position: relative;
            flex: 1;
            min-width: 300px;
        }

        .search-box i {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            z-index: 1;
        }

        .search-box input {
            width: 100%;
            padding: 12px 16px 12px 42px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 0.95rem;
            transition: var(--transition);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2), inset 0 2px 4px rgba(0, 0, 0, 0.1);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.03));
        }

        .filter-options {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .filter-options select {
            padding: 12px 16px;
            background: linear-gradient(135deg, rgba(30, 35, 50, 0.95), rgba(40, 45, 65, 0.95));
            color: var(--dropdown-text);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            font-size: 0.95rem;
            min-width: 180px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .filter-options select:focus {
            outline: none;
            border-color: var(--primary-color);
            background: var(--dropdown-hover);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        select option {
            background: var(--dropdown-bg);
            color: var(--dropdown-text);
            padding: 10px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .btn:active {
            transform: translateY(-1px);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #2a9d8f);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #e67e22);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-info {
            background: linear-gradient(135deg, #4361ee, #3a0ca3);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-secondary {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            color: var(--text-primary);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--accent-color), #b5179e);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Stats Dashboard */
        .stats-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .compact-stats {
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        }

        .stat-card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--card-border);
            border-radius: 15px;
            padding: 20px;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            animation: fadeIn 0.8s ease-out;
            cursor: pointer;
        }

        .stat-card.clickable:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            border-color: var(--primary-color);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(67, 97, 238, 0.1), rgba(76, 201, 240, 0.1));
            opacity: 0;
            transition: var(--transition);
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .stat-card.glow {
            border: 1px solid rgba(67, 97, 238, 0.3);
            box-shadow: 0 8px 32px rgba(67, 97, 238, 0.15);
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            box-shadow: 0 4px 15px rgba(67, 97, 238, 0.4);
        }

        .stat-change {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.85rem;
            font-weight: 600;
            padding: 6px 10px;
            border-radius: 12px;
            background: rgba(76, 201, 240, 0.1);
            color: var(--success-color);
        }

        .stat-change.negative {
            background: rgba(248, 37, 133, 0.1);
            color: var(--accent-color);
        }

        .stat-content h3 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #ffffff, var(--text-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-content p {
            color: var(--text-secondary);
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 10px;
        }

        /* Operator Distribution */
        .operator-distribution {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .operator-distribution.thinner {
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
        }

        .operator-distribution.thinner .count {
            font-size: 1.5rem !important;
        }

        .operator-distribution.thinner .label {
            font-size: 0.8rem !important;
        }

        .distribution-item {
            text-align: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: var(--transition);
            cursor: pointer;
        }

        .distribution-item:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .distribution-item.group-a {
            border-color: rgba(76, 201, 240, 0.3);
        }

        .distribution-item.group-b {
            border-color: rgba(67, 97, 238, 0.3);
        }

        .distribution-item.group-c {
            border-color: rgba(248, 150, 30, 0.3);
        }

        .distribution-item.group-d {
            border-color: rgba(183, 23, 158, 0.3);
        }

        .distribution-item .count {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .distribution-item.group-a .count {
            color: var(--success-color);
        }

        .distribution-item.group-b .count {
            color: var(--primary-color);
        }

        .distribution-item.group-c .count {
            color: var(--warning-color);
        }

        .distribution-item.group-d .count {
            color: var(--accent-color);
        }

        .distribution-item .label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .line-selector {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .line-selector select {
            width: 100%;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .line-selector select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .dashboard-card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--card-border);
            border-radius: 15px;
            padding: 25px;
            box-shadow: var(--glow);
            transition: var(--transition);
        }

        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
        }

        .dashboard-card h3 {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dashboard-card h3 i {
            color: var(--primary-color);
        }

        .skill-distribution-card .distribution-chart {
            height: 150px;
            margin: 15px 0;
        }

        .skill-distribution-card .distribution-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .skill-stat {
            text-align: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .skill-stat.group-a {
            border-color: rgba(76, 201, 240, 0.3);
        }

        .skill-stat.group-b {
            border-color: rgba(67, 97, 238, 0.3);
        }

        .skill-stat.group-c {
            border-color: rgba(248, 150, 30, 0.3);
        }

        .skill-stat.group-d {
            border-color: rgba(183, 23, 158, 0.3);
        }

        .skill-stat .count {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .skill-stat .label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .garment-smv-card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--card-border);
            border-radius: 15px;
            padding: 25px;
            box-shadow: var(--glow);
            transition: var(--transition);
        }

        .garment-smv-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
        }

        .garment-smv-selectors {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 15px 0;
        }

        .garment-smv-selectors select {
            width: 100%;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .garment-smv-selectors select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .garment-smv-value {
            font-size: 2.8rem;
            font-weight: 700;
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .garment-smv-card.standard .garment-smv-value {
            color: var(--success-color);
            border-color: rgba(76, 201, 240, 0.3);
            background: rgba(76, 201, 240, 0.1);
        }

        .garment-smv-card.working .garment-smv-value {
            color: var(--accent-color);
            border-color: rgba(248, 37, 133, 0.3);
            background: rgba(248, 37, 133, 0.1);
        }

        .garment-smv-label {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 10px;
        }

        .filter-card {
            background: linear-gradient(135deg, rgba(67, 97, 238, 0.15), rgba(58, 12, 163, 0.1));
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .filter-options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .filter-option {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-option label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .filter-option select {
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
            width: 100%;
        }

        .filter-option select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .metric-item {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .metric-item .value {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .metric-item .label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .metric-item.efficiency .value {
            color: var(--success-color);
        }

        .metric-item.smv .value {
            color: var(--primary-color);
        }

        .metric-item.working-smv .value {
            color: var(--accent-color);
        }

        .metric-item.operations .value {
            color: var(--warning-color);
        }

        .combined-smv-card {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .smv-values {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .smv-value {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: var(--transition);
        }

        .smv-value:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.08);
        }

        .smv-value.standard {
            border-color: rgba(76, 201, 240, 0.3);
        }

        .smv-value.working {
            border-color: rgba(248, 37, 133, 0.3);
        }

        .smv-value .value {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .smv-value.standard .value {
            color: var(--success-color);
        }

        .smv-value.working .value {
            color: var(--accent-color);
        }

        .machine-usage-card {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .machine-usage-stats {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 200px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .machine-usage-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .machine-usage-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(5px);
        }

        .machine-name {
            color: var(--text-secondary);
        }

        .machine-count {
            font-weight: 600;
            color: var(--primary-color);
        }

        /* UPDATED: Main Content with scrollable tables */
        .main-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }

        /* UPDATED: Table Container with scrollbars */
        .table-container {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--card-border);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: var(--glow);
            animation: slideUp 0.6s ease-out;
            max-height: 500px;
            display: flex;
            flex-direction: column;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .table-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
        }

        .table-header h3 {
            font-size: 1.3rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .table-header h3 i {
            color: var(--primary-color);
        }

        /* UPDATED: Data table with fixed height and scrollbars */
        .data-table-wrapper {
            flex: 1;
            overflow-y: auto;
            overflow-x: auto;
            max-height: calc(500px - 70px);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }

        .data-table thead {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
            position: sticky;
            top: 0;
            z-index: 10;
        }

        /* FIXED: Current Sew Line column alignment */
        .data-table th:nth-child(3),
        .data-table td:nth-child(3) {
            text-align: center;
        }

        .data-table th {
            padding: 16px 20px;
            text-align: left;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            white-space: nowrap;
        }

        .data-table tbody tr {
            transition: var(--transition);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .data-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .data-table td {
            padding: 16px 20px;
            color: var(--text-primary);
            vertical-align: middle;
        }

        .operator-id {
            font-weight: 600;
            color: var(--primary-color);
        }

        /* UPDATED: Multi-skill level classes with new logic */
        .skill-level {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.3);
            min-width: 80px;
            letter-spacing: 0.5px;
        }

        .skill-group-a {
            background: linear-gradient(135deg, rgba(76, 201, 240, 0.15), rgba(76, 201, 240, 0.1));
            color: var(--success-color);
            border-color: rgba(76, 201, 240, 0.3);
        }

        .skill-group-b {
            background: linear-gradient(135deg, rgba(67, 97, 238, 0.15), rgba(67, 97, 238, 0.1));
            color: var(--primary-color);
            border-color: rgba(67, 97, 238, 0.3);
        }

        .skill-group-c {
            background: linear-gradient(135deg, rgba(248, 150, 30, 0.15), rgba(248, 150, 30, 0.1));
            color: var(--warning-color);
            border-color: rgba(248, 150, 30, 0.3);
        }

        .skill-group-d {
            background: linear-gradient(135deg, rgba(183, 23, 158, 0.15), rgba(183, 23, 158, 0.1));
            color: var(--accent-color);
            border-color: rgba(183, 23, 158, 0.3);
        }

        /* UPDATED: Skill Score Display */
        .skill-score {
            font-weight: 700;
            padding: 6px 12px;
            border-radius: 8px;
            display: inline-block;
            min-width: 65px;
            text-align: center;
            font-family: 'Courier New', monospace;
            letter-spacing: 1px;
        }

        .skill-score.group-a {
            background: linear-gradient(135deg, rgba(76, 201, 240, 0.2), rgba(76, 201, 240, 0.1));
            color: var(--success-color);
            border: 1px solid rgba(76, 201, 240, 0.3);
        }

        .skill-score.group-b {
            background: linear-gradient(135deg, rgba(67, 97, 238, 0.2), rgba(67, 97, 238, 0.1));
            color: var(--primary-color);
            border: 1px solid rgba(67, 97, 238, 0.3);
        }

        .skill-score.group-c {
            background: linear-gradient(135deg, rgba(248, 150, 30, 0.2), rgba(248, 150, 30, 0.1));
            color: var(--warning-color);
            border: 1px solid rgba(248, 150, 30, 0.3);
        }

        .skill-score.group-d {
            background: linear-gradient(135deg, rgba(183, 23, 158, 0.2), rgba(183, 23, 158, 0.1));
            color: var(--accent-color);
            border: 1px solid rgba(183, 23, 158, 0.3);
        }

        .action-buttons-small {
            display: flex;
            gap: 6px;
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
            transition: var(--transition);
            cursor: pointer;
        }

        .btn-icon:hover {
            background: rgba(67, 97, 238, 0.2);
            color: var(--primary-color);
            border-color: rgba(67, 97, 238, 0.3);
            transform: translateY(-2px);
        }

        .btn-icon-timer {
            background: rgba(248, 150, 30, 0.1);
            border-color: rgba(248, 150, 30, 0.3);
            color: var(--warning-color);
        }

        .btn-icon-timer:hover {
            background: rgba(248, 150, 30, 0.2);
            color: var(--warning-color);
            border-color: rgba(248, 150, 30, 0.4);
        }

        .working-smv-cell {
            position: relative;
        }

        .working-smv-btn {
            background: rgba(67, 97, 238, 0.1);
            border: 1px solid rgba(67, 97, 238, 0.3);
            color: var(--primary-color);
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            font-size: 0.85rem;
            min-width: 60px;
        }

        .working-smv-btn:hover {
            background: rgba(67, 97, 238, 0.2);
            transform: translateY(-2px);
        }

        /* Time Study Styles */
        #time-study .stopwatch-container {
            background: linear-gradient(135deg, rgba(67, 97, 238, 0.1), rgba(58, 12, 163, 0.05));
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(67, 97, 238, 0.15);
            padding: 20px;
            margin-bottom: 25px;
        }

        #time-study .stopwatch-container > h3 {
            background: linear-gradient(135deg, rgba(67, 97, 238, 0.15), rgba(58, 12, 163, 0.1));
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            padding: 12px 16px;
            margin: -20px -20px 20px -20px;
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
        }

        #time-study .stopwatch-container > h3::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            border-radius: 10px 10px 0 0;
        }

        .subtitle {
            color: var(--text-secondary);
            margin: 6px 0 15px 0;
            font-size: 0.95rem;
        }

        .single-stopwatch {
            text-align: center;
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }

        .stopwatch-display-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .stopwatch-main {
            font-family: 'Courier New', monospace;
            font-size: 2.5rem;
            font-weight: 700;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            letter-spacing: 2px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            text-align: center;
            min-width: 280px;
        }

        .stopwatch-lap {
            font-family: 'Courier New', monospace;
            font-size: 1.3rem;
            color: var(--success-color);
            padding: 8px 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            min-width: 140px;
            text-align: center;
        }

        .stopwatch-controls {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .stopwatch-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 120px;
            font-size: 0.95rem;
        }

        .stopwatch-btn-start {
            background: linear-gradient(135deg, var(--success-color), #2a9d8f);
            color: white;
            border: none;
        }

        .stopwatch-btn-stop {
            background: linear-gradient(135deg, var(--accent-color), #b5179e);
            color: white;
            border: none;
        }

        .stopwatch-btn-lap {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
        }

        .cycle-options {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            background: rgba(255, 255,255, 0.05);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .cycle-options label {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-primary);
            font-weight: 500;
            font-size: 0.95rem;
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: var(--transition);
        }

        .cycle-options label:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .cycle-options input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--primary-color);
        }

        .manual-cycle-inputs {
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .manual-cycle-inputs h4 {
            color: var(--text-primary);
            margin-bottom: 15px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .cycle-input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }

        .cycle-input-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .cycle-input-group label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .cycle-input-group input {
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .cycle-input-group input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .laps-container {
            margin-top: 15px;
            max-height: 250px;
            overflow-y: auto;
        }

        .laps-header {
            display: flex;
            justify-content: space-between;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .lap-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            margin-bottom: 6px;
            font-size: 0.9rem;
        }

        .lap-item:last-child {
            border-bottom: none;
        }

        .lap-number {
            font-weight: 600;
            color: var(--primary-color);
        }

        .lap-time {
            font-family: 'Courier New', monospace;
            color: var(--success-color);
        }

        .cycle-results {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--card-border);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: var(--glow);
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .result-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: var(--transition);
        }

        .result-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-3px);
        }

        .result-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--primary-color), var(--success-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .efficiency-high {
            color: var(--success-color);
        }

        .efficiency-medium {
            color: var(--warning-color);
        }

        .efficiency-low {
            color: var(--accent-color);
        }

        .result-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Form Groups */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            background: linear-gradient(135deg, rgba(30, 35, 50, 0.95), rgba(40, 45, 65, 0.95));
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 0.95rem;
            transition: var(--transition);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
            background: rgba(67, 97, 238, 0.2);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .multi-select {
            position: relative;
        }

        .multi-select-display {
            padding: 12px 16px;
            background: linear-gradient(135deg, rgba(30, 35, 50, 0.95), rgba(40, 45, 65, 0.95));
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .multi-select-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--dropdown-bg);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            margin-top: 5px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            z-index: 100;
        }

        .multi-select-options.show {
            display: block;
        }

        .multi-select-option {
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: var(--transition);
        }

        .multi-select-option:hover {
            background: rgba(67, 97, 238, 0.2);
        }

        .multi-select-option input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--primary-color);
        }

        .selected-options {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }

        .selected-tag {
            background: rgba(67, 97, 238, 0.2);
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .selected-tag i {
            cursor: pointer;
            font-size: 0.7rem;
        }

        /* Performance Table */
        .performance-table-wrapper {
            max-height: 500px;
            overflow-y: auto;
            overflow-x: auto;
        }

        .performance-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }

        .performance-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .performance-table th {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
            padding: 16px 20px;
            text-align: left;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            white-space: nowrap;
        }

        .performance-table td {
            padding: 14px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            position: relative;
            font-size: 0.95rem;
        }

        .highlight-row {
            animation: highlightPulse 3s ease-out;
        }

        @keyframes highlightPulse {
            0% {
                background-color: rgba(67, 97, 238, 0.3);
                box-shadow: 0 0 0 0 rgba(67, 97, 238, 0.7);
            }
            50% {
                background-color: rgba(67, 97, 238, 0.6);
                box-shadow: 0 0 0 10px rgba(67, 97, 238, 0);
            }
            100% {
                background-color: rgba(67, 97, 238, 0);
                box-shadow: 0 0 0 0 rgba(67, 97, 238, 0);
            }
        }

        /* NEW: Gridding Criteria Tab */
        .gridding-criteria-content {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--card-border);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: var(--glow);
        }

        .criteria-section {
            margin-bottom: 30px;
        }

        .criteria-section:last-child {
            margin-bottom: 0;
        }

        .criteria-section h3 {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .criteria-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .criteria-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: var(--transition);
        }

        .criteria-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .criteria-card h4 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--success-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .criteria-details {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .criteria-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
        }

        .criteria-icon {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .criteria-icon.group-a {
            background: rgba(76, 201, 240, 0.2);
            color: var(--success-color);
        }

        .criteria-icon.group-b {
            background: rgba(67, 97, 238, 0.2);
            color: var(--primary-color);
        }

        .criteria-icon.group-c {
            background: rgba(248, 150, 30, 0.2);
            color: var(--warning-color);
        }

        .criteria-icon.group-d {
            background: rgba(183, 23, 158, 0.2);
            color: var(--accent-color);
        }

        .criteria-text {
            flex: 1;
        }

        .criteria-text strong {
            color: var(--text-primary);
            font-weight: 600;
            display: block;
            margin-bottom: 4px;
        }

        .criteria-text .description {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 25px;
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--card-border);
            border-radius: 15px;
            margin-top: 25px;
            box-shadow: var(--glow);
        }

        .footer p {
            color: var(--text-secondary);
            margin-bottom: 10px;
            font-size: 0.95rem;
        }

        .footer-credit {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 8px;
            margin-bottom: 20px;
        }

        .footer-stats {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .footer-stat {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .footer-stat i {
            color: var(--primary-color);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 14, 23, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.3s ease-out;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid var(--card-border);
            border-radius: 15px;
            width: 100%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            animation: modalSlideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        @keyframes modalSlideUp {
            from {
                opacity: 0;
                transform: translateY(40px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            padding: 20px 20px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }

        .modal-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            border-radius: 15px 15px 0 0;
        }

        .modal-header h3 {
            font-size: 1.3rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 20px;
            cursor: pointer;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
            transition: var(--transition);
            font-size: 1.2rem;
        }

        .close-modal:hover {
            background: rgba(248, 37, 133, 0.2);
            color: var(--accent-color);
            border-color: rgba(248, 37, 133, 0.3);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 20px;
        }

        .edit-info {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border-left: 3px solid var(--primary-color);
        }

        .score-slider {
            margin-top: 15px;
            width: 100%;
        }

        .score-slider input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
            -webkit-appearance: none;
        }

        .score-slider input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(67, 97, 238, 0.5);
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--card-border);
            padding: 15px 20px;
            border-radius: 12px;
            transform: translateY(100px) scale(0.9);
            opacity: 0;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s ease;
            z-index: 1001;
            min-width: 300px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .toast.show {
            transform: translateY(0) scale(1);
            opacity: 1;
        }

        .toast-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toast-content i {
            font-size: 1.3rem;
        }

        .toast-success i {
            color: var(--success-color);
        }

        .toast-error i {
            color: var(--accent-color);
        }

        /* Loading Animation */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 14, 23, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .loading-spinner {
            width: 70px;
            height: 70px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--text-secondary);
            letter-spacing: 2px;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Analysis Charts */
        .analysis-charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .chart-card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--card-border);
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--glow);
        }

        .chart-card h4 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Group Operators Modal */
        .group-operators-modal .modal-content {
            max-width: 800px;
        }

        .group-operators-list {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .group-operator-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin-bottom: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: var(--transition);
        }

        .group-operator-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(5px);
        }

        .group-operator-info {
            flex: 1;
        }

        .group-operator-id {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 1rem;
        }

        .group-operator-name {
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .group-operator-line {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .group-operator-stats {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .group-operator-efficiency {
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .group-operator-efficiency.high {
            background: rgba(76, 201, 240, 0.2);
            color: var(--success-color);
        }

        .group-operator-efficiency.medium {
            background: rgba(67, 97, 238, 0.2);
            color: var(--primary-color);
        }

        .group-operator-efficiency.low {
            background: rgba(248, 150, 30, 0.2);
            color: var(--warning-color);
        }

        /* Import Button Styles */
        .import-input {
            display: none;
        }

        /* Total Garment SMV Calculation */
        .total-garment-smv {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .total-smv-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .total-smv-header h4 {
            font-size: 1.1rem;
            color: var(--success-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .total-smv-values {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .total-smv-item {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .total-smv-item .value {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .total-smv-item .label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .total-smv-item.standard .value {
            color: var(--success-color);
        }

        .total-smv-item.working .value {
            color: var(--accent-color);
        }

        .smv-breakdown {
            margin: 20px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .smv-breakdown h4 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .breakdown-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .breakdown-item {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .breakdown-item .value {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .breakdown-item .label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .formula-display {
            margin-top: 20px;
            padding: 15px;
            background: rgba(76, 201, 240, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(76, 201, 240, 0.3);
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: var(--success-color);
        }

        .style-breakdown {
            margin-top: 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .style-breakdown h5 {
            color: var(--text-secondary);
            margin-bottom: 10px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .style-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .style-item:last-child {
            border-bottom: none;
        }

        /* Dashboard Scrollable Container */
        .dashboard-scrollable {
            overflow-x: auto;
            overflow-y: visible;
            padding-bottom: 20px;
        }

        .dashboard-scrollable::-webkit-scrollbar {
            height: 8px;
        }

        .dashboard-scrollable::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .dashboard-scrollable::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 10px;
        }

        /* NEW: Skill Groups Grid */
        .skill-groups-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .skill-group-card {
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            transition: var(--transition);
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
        }

        .skill-group-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .skill-group-card.group-a {
            border-color: rgba(76, 201, 240, 0.3);
            background: linear-gradient(135deg, rgba(76, 201, 240, 0.1), rgba(76, 201, 240, 0.05));
        }

        .skill-group-card.group-b {
            border-color: rgba(67, 97, 238, 0.3);
            background: linear-gradient(135deg, rgba(67, 97, 238, 0.1), rgba(67, 97, 238, 0.05));
        }

        .skill-group-card.group-c {
            border-color: rgba(248, 150, 30, 0.3);
            background: linear-gradient(135deg, rgba(248, 150, 30, 0.1), rgba(248, 150, 30, 0.05));
        }

        .skill-group-card.group-d {
            border-color: rgba(183, 23, 158, 0.3);
            background: linear-gradient(135deg, rgba(183, 23, 158, 0.1), rgba(183, 23, 158, 0.05));
        }

        .skill-group-card .count {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .skill-group-card.group-a .count {
            color: var(--success-color);
        }

        .skill-group-card.group-b .count {
            color: var(--primary-color);
        }

        .skill-group-card.group-c .count {
            color: var(--warning-color);
        }

        .skill-group-card.group-d .count {
            color: var(--accent-color);
        }

        .skill-group-card .label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .skill-group-card .description {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 8px;
            opacity: 0.8;
        }

        /* Updated Dashboard Grid */
        .dashboard-grid-v11 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .total-operators-card {
            grid-column: span 1;
        }

        .skill-groups-container-card {
            grid-column: span 1;
        }

        /* Responsive Design - UPDATED for mobile sidebar */
        @media (max-width: 1200px) {
            .main-content-area {
                padding: 15px;
            }
            
            .stats-dashboard {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            }
            
            .dashboard-grid-v11 {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            }
            
            .form-row {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
            
            .operator-distribution {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .sidebar {
                width: 200px;
            }
            
            .main-content-area {
                margin-left: 200px;
            }
        }

        @media (max-width: 900px) {
            .header-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .header-info {
                flex-direction: column;
                width: 100%;
                gap: 8px;
            }
            
            .info-item {
                min-width: 100%;
            }
            
            .operator-distribution {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .dashboard-grid-v11 {
                grid-template-columns: 1fr;
            }
            
            .skill-groups-grid {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                width: 60px;
                overflow: hidden;
            }
            
            .sidebar-header .logo-text,
            .nav-item span,
            .sidebar-footer .last-updated {
                display: none;
            }
            
            .nav-item {
                justify-content: center;
                padding: 12px;
            }
            
            .main-content-area {
                margin-left: 60px;
            }
        }

        @media (max-width: 768px) {
            /* UPDATED: Mobile sidebar fixes */
            .sidebar {
                width: 0;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                z-index: 1001;
                background: rgba(10, 14, 23, 0.98);
            }
            
            .sidebar.sidebar-open {
                width: 240px;
                transform: translateX(0);
            }
            
            .sidebar-header .logo-text,
            .nav-item span,
            .sidebar-footer {
                display: block;
            }
            
            .nav-item {
                justify-content: flex-start;
                padding: 12px 20px;
            }
            
            .main-content-area {
                margin-left: 0;
                padding: 12px;
            }
            
            .stats-dashboard {
                grid-template-columns: 1fr;
            }
            
            .compact-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .search-filter {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-box {
                min-width: 100%;
            }
            
            .filter-options {
                width: 100%;
            }
            
            .filter-options select {
                flex: 1;
                min-width: 0;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                margin: 8px;
                max-width: 95%;
            }
            
            .stopwatch-main {
                font-size: 2rem;
                min-width: 250px;
            }
            
            .stopwatch-controls {
                flex-wrap: wrap;
            }
            
            .stopwatch-btn {
                min-width: 100px;
            }
            
            .cycle-options {
                flex-direction: column;
                gap: 10px;
            }
            
            .analysis-charts {
                grid-template-columns: 1fr;
            }
            
            .skill-groups-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .skill-group-card {
                padding: 15px;
            }
            
            .skill-group-card .count {
                font-size: 2rem;
            }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-color);
        }

        /* Mobile Menu Toggle */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: var(--primary-color);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(67, 97, 238, 0.4);
            transition: var(--transition);
        }

        .mobile-menu-toggle:hover {
            transform: scale(1.1);
            background: var(--secondary-color);
        }

        .mobile-menu-toggle.active {
            left: 260px;
        }

        /* Overlay for mobile */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 1000;
        }

        .sidebar-overlay.active {
            display: block;
        }

        @media (max-width: 768px) {
            .mobile-menu-toggle {
                display: flex;
            }
            
            .sidebar-overlay.active {
                display: block;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">LOADING SYSTEM DATA</div>
        <div style="margin-top: 25px; text-align: center; max-width: 500px; padding: 0 20px;">
            <h3 style="color: var(--text-primary); margin-bottom: 15px;">Sidney Apparels OPS v13.0</h3>
            <p style="color: var(--text-secondary); font-size: 0.95rem; line-height: 1.6;">
                Welcome to the Operator Performance System. Track operator efficiency, conduct time studies, 
                and analyze manufacturing performance.
            </p>
        </div>
    </div>

    <!-- Mobile Menu Toggle -->
    <div class="mobile-menu-toggle" id="mobileMenuToggle">
        <i class="fas fa-bars"></i>
    </div>

    <!-- Mobile Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Sidebar Navigation -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-industry"></i>
                </div>
                <div class="logo-text">
                    <h1>SIDNEY APPARELS LLC</h1>
                    <h2>MANUFACTURING EXCELLENCE</h2>
                </div>
            </div>
        </div>
        
        <div class="sidebar-nav">
            <div class="nav-item active" data-tab="dashboard">
                <i class="fas fa-chart-line"></i>
                <span>Dashboard & Analysis</span>
            </div>
            <div class="nav-item" data-tab="operators">
                <i class="fas fa-users"></i>
                <span>Operators</span>
            </div>
            <div class="nav-item" data-tab="performance">
                <i class="fas fa-chart-bar"></i>
                <span>Performance Data</span>
            </div>
            <div class="nav-item" data-tab="time-study">
                <i class="fas fa-stopwatch"></i>
                <span>Time Study</span>
            </div>
            <div class="nav-item" data-tab="gridding-criteria">
                <i class="fas fa-grip"></i>
                <span>Gridding Criteria</span>
            </div>
        </div>
        
        <div class="sidebar-footer">
            <div class="current-time" id="sidebarCurrentTime">--:--:--</div>
            <div class="last-updated" id="sidebarLastUpdated">--/--/----</div>
        </div>
    </div>

    <!-- Main content area -->
    <div class="main-content-area">
        <!-- Simplified Header -->
        <header class="header">
            <div class="header-content">
                <div class="header-info">
                    <div class="info-item">
                        <i class="fas fa-database"></i>
                        <div class="info-item-content">
                            <div class="info-label">DATA VERSION</div>
                            <div class="info-value">v13.0</div>
                        </div>
                    </div>
                    <div class="info-item">
                        <i class="fas fa-sync-alt"></i>
                        <div class="info-item-content">
                            <div class="info-label">LAST SYNC</div>
                            <div class="info-value" id="headerLastSync">--:--:--</div>
                        </div>
                    </div>
                    <div class="info-item">
                        <i class="fas fa-users"></i>
                        <div class="info-item-content">
                            <div class="info-label">TOTAL OPERATORS</div>
                            <div class="info-value" id="headerTotalOps">0</div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Dashboard Tab - UPDATED v11 -->
        <div id="dashboard" class="tab-content active">
            <div class="controls-panel">
                <div class="search-filter">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="dashboardSearch" placeholder="Search across all data...">
                    </div>
                    <div class="filter-options">
                        <select id="dashboardLineFilter">
                            <option value="">All Lines</option>
                        </select>
                        <select id="dashboardDateRange">
                            <option value="today">Today</option>
                            <option value="week" selected>This Week</option>
                            <option value="month">This Month</option>
                            <option value="all">All Time</option>
                        </select>
                    </div>
                </div>
                <div class="action-buttons">
                    <button id="refreshDashboardBtn" class="btn btn-info">
                        <i class="fas fa-sync-alt"></i> Refresh Dashboard
                    </button>
                    <button id="exportDashboardBtn" class="btn btn-success">
                        <i class="fas fa-file-excel"></i> Export Dashboard
                    </button>
                    <button id="quickAnalysisBtn" class="btn btn-primary">
                        <i class="fas fa-chart-bar"></i> Quick Analysis
                    </button>
                </div>
            </div>

            <!-- Dashboard Scrollable Container -->
            <div class="dashboard-scrollable">
                <!-- UPDATED v11: New Dashboard Grid with separate Total Operators and Skill Groups -->
                <div class="dashboard-grid-v11">
                    <!-- Total Operators Card - Single card with line selection -->
                    <div class="dashboard-card total-operators-card clickable" id="dashboardTotalOperatorsCard">
                        <h3><i class="fas fa-users"></i> Total Operators</h3>
                        <div style="display: flex; align-items: center; gap: 20px;">
                            <div style="flex: 1;">
                                <div style="font-size: 3rem; font-weight: 700; margin-bottom: 10px; color: var(--primary-color);" id="dashboardTotalOperators">0</div>
                                <div style="color: var(--text-secondary); font-size: 0.9rem;">Active Operators</div>
                            </div>
                        </div>
                        <!-- Line selector works independently -->
                        <div class="line-selector">
                            <select id="dashboardLineSelect">
                                <option value="">All Lines</option>
                            </select>
                        </div>
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                            <div style="color: var(--text-secondary); font-size: 0.85rem;">
                                <i class="fas fa-info-circle" style="color: var(--primary-color);"></i>
                                Click to view all operators in the system
                            </div>
                        </div>
                    </div>

                    <!-- NEW: Skill Groups Container Card with 4 smaller cards -->
                    <div class="dashboard-card skill-groups-container-card">
                        <h3><i class="fas fa-layer-group"></i> Skill Groups Distribution</h3>
                        <div class="skill-groups-grid">
                            <div class="skill-group-card group-a" id="dashboardGroupACard">
                                <div class="count" id="dashboardGroupACount">0</div>
                                <div class="label">Group A</div>
                                <div class="description">Grade A Operators</div>
                            </div>
                            <div class="skill-group-card group-b" id="dashboardGroupBCard">
                                <div class="count" id="dashboardGroupBCount">0</div>
                                <div class="label">Group B</div>
                                <div class="description">Grade B Operators</div>
                            </div>
                            <div class="skill-group-card group-c" id="dashboardGroupCCard">
                                <div class="count" id="dashboardGroupCCount">0</div>
                                <div class="label">Group C</div>
                                <div class="description">Grade C Operators</div>
                            </div>
                            <div class="skill-group-card group-d" id="dashboardGroupDCard">
                                <div class="count" id="dashboardGroupDCount">0</div>
                                <div class="label">Group D</div>
                                <div class="description">Grade D Operators</div>
                            </div>
                        </div>
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                            <div style="color: var(--text-secondary); font-size: 0.85rem;">
                                <i class="fas fa-info-circle" style="color: var(--primary-color);"></i>
                                Click on any group to view operators
                            </div>
                        </div>
                    </div>

                    <!-- Performance Metrics Card -->
                    <div class="dashboard-card">
                        <h3><i class="fas fa-chart-line"></i> Performance Metrics</h3>
                        <div class="metrics-grid">
                            <div class="metric-item efficiency">
                                <div class="value" id="dashboardAvgEfficiency">0%</div>
                                <div class="label">Avg Efficiency</div>
                            </div>
                            <div class="metric-item smv">
                                <div class="value" id="dashboardAvgSMV">0.00</div>
                                <div class="label">Avg SMV</div>
                            </div>
                            <div class="metric-item working-smv">
                                <div class="value" id="dashboardAvgWorkingSMV">0.00</div>
                                <div class="label">Avg Working SMV</div>
                            </div>
                            <div class="metric-item operations">
                                <div class="value" id="dashboardTotalOperations">0</div>
                                <div class="label">Total Operations</div>
                            </div>
                        </div>
                        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                            <div style="display: flex; justify-content: space-between; font-size: 0.9rem;">
                                <span style="color: var(--text-secondary);">Active Lines:</span>
                                <span style="font-weight: 600; color: var(--primary-color);" id="dashboardActiveLines">0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Skill Distribution Card -->
                    <div class="dashboard-card skill-distribution-card">
                        <h3><i class="fas fa-star"></i> Skill Distribution</h3>
                        <div class="distribution-chart">
                            <canvas id="skillDistributionChart" height="150"></canvas>
                        </div>
                        <div class="distribution-stats">
                            <div class="skill-stat group-a">
                                <div class="count" id="skillGroupACount">0</div>
                                <div class="label">Group A</div>
                            </div>
                            <div class="skill-stat group-b">
                                <div class="count" id="skillGroupBCount">0</div>
                                <div class="label">Group B</div>
                            </div>
                            <div class="skill-stat group-c">
                                <div class="count" id="skillGroupCCount">0</div>
                                <div class="label">Group C</div>
                            </div>
                            <div class="skill-stat group-d">
                                <div class="count" id="skillGroupDCount">0</div>
                                <div class="label">Group D</div>
                            </div>
                        </div>
                    </div>

                    <!-- Machine Usage Card -->
                    <div class="dashboard-card machine-usage-card">
                        <h3><i class="fas fa-cogs"></i> Top Machines</h3>
                        <div class="machine-usage-stats" id="dashboardMachineUsage">
                            <div class="machine-usage-item">
                                <span class="machine-name">Loading...</span>
                                <span class="machine-count">0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Garment Standard SMV Card -->
                    <div class="garment-smv-card standard">
                        <h3><i class="fas fa-ruler"></i> Garment Standard SMV</h3>
                        <div class="garment-smv-selectors">
                            <select id="standardSMVLineSelect">
                                <option value="">Select Line</option>
                            </select>
                            <select id="standardSMVStyleSelect">
                                <option value="">Select Style</option>
                            </select>
                        </div>
                        <div class="garment-smv-value" id="totalStandardSMV">0.00</div>
                        <div class="garment-smv-label">Total Standard SMV (minutes)</div>
                    </div>

                    <!-- Garment Working SMV Card -->
                    <div class="garment-smv-card working">
                        <h3><i class="fas fa-ruler-combined"></i> Garment Working SMV</h3>
                        <div class="garment-smv-selectors">
                            <select id="workingSMVLineSelect">
                                <option value="">Select Line</option>
                            </select>
                            <select id="workingSMVStyleSelect">
                                <option value="">Select Style</option>
                            </select>
                        </div>
                        <div class="garment-smv-value" id="totalWorkingSMV">0.00</div>
                        <div class="garment-smv-label">Total Working SMV (minutes)</div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="analysis-charts">
                    <div class="chart-card">
                        <h4><i class="fas fa-chart-pie"></i> Efficiency Distribution</h4>
                        <canvas id="efficiencyChart" height="250"></canvas>
                    </div>
                    <div class="chart-card">
                        <h4><i class="fas fa-trend-up"></i> Weekly Performance Trend</h4>
                        <canvas id="weeklyTrendChart" height="250"></canvas>
                    </div>
                    <div class="chart-card">
                        <h4><i class="fas fa-industry"></i> Line Performance</h4>
                        <canvas id="linePerformanceChart" height="250"></canvas>
                    </div>
                    <div class="chart-card">
                        <h4><i class="fas fa-cogs"></i> Machine Performance</h4>
                        <canvas id="machinePerformanceChart" height="250"></canvas>
                    </div>
                </div>
            </div>

            <!-- Recent Activity Section -->
            <div class="dashboard-card" style="margin-top: 20px;">
                <h3><i class="fas fa-history"></i> Recent Activity</h3>
                <div style="max-height: 300px; overflow-y: auto; margin-top: 15px;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr>
                                <th style="padding: 12px; text-align: left; color: var(--text-secondary); font-weight: 600; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">Time</th>
                                <th style="padding: 12px; text-align: left; color: var(--text-secondary); font-weight: 600; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">Operator</th>
                                <th style="padding: 12px; text-align: left; color: var(--text-secondary); font-weight: 600; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">Operation</th>
                                <th style="padding: 12px; text-align: left; color: var(--text-secondary); font-weight: 600; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">Efficiency</th>
                                <th style="padding: 12px; text-align: left; color: var(--text-secondary); font-weight: 600; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recentActivity">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Operators Tab -->
        <div id="operators" class="tab-content">
            <!-- Compact Statistics Dashboard -->
            <div class="stats-dashboard compact-stats">
                <div class="stat-card glow clickable" id="operatorsTotalOperatorsCard">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-change">
                            <i class="fas fa-arrow-up"></i>
                            12%
                        </div>
                    </div>
                    <div class="stat-content">
                        <h3 id="totalOperators">0</h3>
                        <p>Total Operators</p>
                        <div class="operator-distribution">
                            <div class="distribution-item group-a" id="operatorsGroupAClickable">
                                <div class="count" id="operatorsGroupACount">0</div>
                                <div class="label">Group A</div>
                            </div>
                            <div class="distribution-item group-b" id="operatorsGroupBClickable">
                                <div class="count" id="operatorsGroupBCount">0</div>
                                <div class="label">Group B</div>
                            </div>
                            <div class="distribution-item group-c" id="operatorsGroupCClickable">
                                <div class="count" id="operatorsGroupCCount">0</div>
                                <div class="label">Group C</div>
                            </div>
                            <div class="distribution-item group-d" id="operatorsGroupDClickable">
                                <div class="count" id="operatorsGroupDCount">0</div>
                                <div class="label">Group D</div>
                            </div>
                        </div>
                        <!-- Line selector works independently -->
                        <div class="line-selector">
                            <select id="operatorsLineFilter">
                                <option value="">All Lines</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Performance Summary Card -->
                <div class="stat-card clickable" data-tab="performance">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="stat-change">
                            <i class="fas fa-external-link-alt"></i>
                        </div>
                    </div>
                    <div class="stat-content">
                        <h3 id="performanceRecords">0</h3>
                        <p>Performance Records</p>
                        <div style="margin-top: 12px; color: var(--text-secondary); font-size: 0.9rem;">
                            <div>Avg Efficiency: <span id="performanceAvgEfficiency" style="color: var(--success-color); font-weight: 600;">0%</span></div>
                            <div>Total Operations: <span id="performanceTotalOps" style="color: var(--primary-color); font-weight: 600;">0</span></div>
                        </div>
                    </div>
                </div>
                
                <!-- Time Study Summary Card -->
                <div class="stat-card clickable" data-tab="time-study">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-stopwatch"></i>
                        </div>
                        <div class="stat-change">
                            <i class="fas fa-external-link-alt"></i>
                        </div>
                    </div>
                    <div class="stat-content">
                        <h3 id="timeStudies">0</h3>
                        <p>Time Studies Today</p>
                        <div style="margin-top: 12px; color: var(--text-secondary); font-size: 0.9rem;">
                            <div>Avg Cycle Time: <span id="timeStudyAvgCycle" style="color: var(--warning-color); font-weight: 600;">0s</span></div>
                            <div>Completed: <span id="timeStudyCompleted" style="color: var(--success-color); font-weight: 600;">0</span></div>
                        </div>
                    </div>
                </div>
                
                <!-- Analysis Summary Card -->
                <div class="stat-card clickable" data-tab="dashboard">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-dashboard"></i>
                        </div>
                        <div class="stat-change">
                            <i class="fas fa-external-link-alt"></i>
                        </div>
                    </div>
                    <div class="stat-content">
                        <h3 id="analysisSummary">0</h3>
                        <p>Dashboard Insights</p>
                        <div style="margin-top: 12px; color: var(--text-secondary); font-size: 0.9rem;">
                            <div>Active Lines: <span id="activeLines" style="color: var(--primary-color); font-weight: 600;">0</span></div>
                            <div>Avg SMV Diff: <span id="avgSMVDiff" style="color: var(--accent-color); font-weight: 600;">0%</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="controls-panel">
                <div class="search-filter">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchInput" placeholder="Search by Operator ID or Name...">
                    </div>
                    <div class="filter-options">
                        <select id="skillFilter">
                            <option value="">Filter by Skill Level...</option>
                            <option value="Group A">Group A</option>
                            <option value="Group B">Group B</option>
                            <option value="Group C">Group C</option>
                            <option value="Group D">Group D</option>
                        </select>
                        <select id="lineFilter">
                            <option value="">Filter by Sew Line...</option>
                        </select>
                    </div>
                </div>
                <div class="action-buttons">
                    <button id="addOperatorBtn" class="btn btn-primary">
                        <i class="fas fa-user-plus"></i> Add Operator
                    </button>
                    <button id="importExcelBtn" class="btn btn-secondary">
                        <i class="fas fa-file-import"></i> Import Excel
                    </button>
                    <button id="exportBtn" class="btn btn-success">
                        <i class="fas fa-file-excel"></i> Export Excel
                    </button>
                    <button id="saveBtn" class="btn btn-warning">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                    <button id="refreshBtn" class="btn btn-info">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                <input type="file" id="importExcelInput" class="import-input" accept=".xlsx,.xls">
            </div>

            <!-- Scrollable operators list -->
            <div class="table-container">
                <div class="table-header">
                    <h3><i class="fas fa-table"></i> OPERATORS MASTER LIST</h3>
                </div>
                <div class="data-table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>OPERATOR ID</th>
                                <th>OPERATOR NAME</th>
                                <th>CURRENT SEW LINE</th>
                                <th>SKILL LEVEL</th>
                                <th>SKILL SCORE</th>
                                <th>ACTIONS</th>
                            </tr>
                        </thead>
                        <tbody id="operatorsBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Performance Data Tab -->
        <div id="performance" class="tab-content">
            <!-- Statistics Dashboard with 3 cards -->
            <div class="stats-dashboard">
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-bolt"></i>
                        </div>
                        <div class="stat-change">
                            <i class="fas fa-arrow-up"></i>
                            5%
                        </div>
                    </div>
                    <div class="stat-content">
                        <h3 id="avgEfficiency">0%</h3>
                        <p>Average Efficiency</p>
                        <div style="margin-top: 12px; color: var(--text-secondary); font-size: 0.9rem;">
                            <div>Total Operations: <span id="totalOperations" style="color: var(--primary-color); font-weight: 600;">0</span></div>
                        </div>
                    </div>
                </div>
                
                <!-- Combined SMV Card -->
                <div class="stat-card combined-smv-card">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-change">
                            <i class="fas fa-arrows-alt-v"></i>
                        </div>
                    </div>
                    <div class="stat-content">
                        <p>Standard vs Working SMV</p>
                        <div class="smv-values">
                            <div class="smv-value standard">
                                <div class="value" id="avgSMV">0.00</div>
                                <div class="label">Avg. Standard</div>
                            </div>
                            <div class="smv-value working">
                                <div class="value" id="avgWorkingSMV">0.00</div>
                                <div class="label">Avg. Working</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Machine Usage Statistics Card -->
                <div class="stat-card machine-usage-card">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-cogs"></i>
                        </div>
                    </div>
                    <div class="stat-content">
                        <p>Machine Usage Statistics</p>
                        <div class="machine-usage-stats" id="machineUsageStats">
                            <div class="machine-usage-item">
                                <span class="machine-name">No data available</span>
                                <span class="machine-count">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="controls-panel">
                <div class="search-filter">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchPerformance" placeholder="Search by Operator ID, Name or Style...">
                    </div>
                    <div class="filter-options">
                        <select id="perfLineFilter">
                            <option value="">Filter by Line...</option>
                        </select>
                        <select id="dateFilter">
                            <option value="">Filter by Date...</option>
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                        </select>
                    </div>
                </div>
                <div class="action-buttons">
                    <button id="addPerformanceBtn" class="btn btn-primary">
                        <i class="fas fa-plus-circle"></i> Add Performance Record
                    </button>
                    <button id="importPerformanceBtn" class="btn btn-secondary">
                        <i class="fas fa-file-import"></i> Import Excel
                    </button>
                    <button id="exportPerformanceBtn" class="btn btn-success">
                        <i class="fas fa-file-excel"></i> Export Excel
                    </button>
                    <button id="analyzeBtn" class="btn btn-info">
                        <i class="fas fa-chart-bar"></i> Quick Analysis
                    </button>
                </div>
                <input type="file" id="importPerformanceInput" class="import-input" accept=".xlsx,.xls">
            </div>

            <div class="table-container">
                <div class="table-header">
                    <h3><i class="fas fa-chart-line"></i> PERFORMANCE RECORDS</h3>
                </div>
                <div class="performance-table-wrapper">
                    <table class="performance-table">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Line No</th>
                                <th>Style No</th>
                                <th>Product Desc</th>
                                <th>Operator ID</th>
                                <th>Operator Name</th>
                                <th>Operation</th>
                                <th>Machine</th>
                                <th>Other Machines</th>
                                <th>Std SMV</th>
                                <th>Working SMV</th>
                                <th>Efficiency</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="performanceBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Time Study Tab -->
        <div id="time-study" class="tab-content">
            <div class="stopwatch-container">
                <h3><i class="fas fa-stopwatch"></i> Time Study & SAM Calculation</h3>
                <p class="subtitle">Record lap times to calculate average time and efficiency (includes machine-specific allowances)</p>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="studyOperatorId">Operator ID *</label>
                        <select id="studyOperatorId" required>
                            <option value="">Select Operator</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="studyLineNo">Line No *</label>
                        <!-- CHANGED: Line No changed from select to input with datalist -->
                        <input type="text" id="studyLineNo" list="lineNoList" required placeholder="Enter or select line number">
                        <datalist id="lineNoList">
                            <!-- Options will be populated dynamically -->
                        </datalist>
                    </div>
                    <div class="form-group">
                        <label for="studyStyleNo">Style No (Running) *</label>
                        <input type="text" id="studyStyleNo" required placeholder="Enter style number">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="studyProductDesc">Product Description *</label>
                        <input type="text" id="studyProductDesc" required placeholder="Enter product description">
                    </div>
                    <div class="form-group">
                        <label for="studyOperation">Operation Name *</label>
                        <input type="text" id="studyOperation" required placeholder="e.g., Hemming">
                    </div>
                    <div class="form-group">
                        <label for="studyMachine">Machine Name *</label>
                        <select id="studyMachine" required>
                            <option value="">Select Machine</option>
                            <option value="BARTACK">BARTACK</option>
                            <option value="BUTTON ATTACH">BUTTON ATTACH</option>
                            <option value="BUTTONHOLE">BUTTONHOLE</option>
                            <option value="DNLS">DNLS</option>
                            <option value="FLATLOCK">FLATLOCK</option>
                            <option value="FOA">FOA</option>
                            <option value="FS">FS</option>
                            <option value="KANSAI">KANSAI</option>
                            <option value="OVERLOCK">OVERLOCK</option>
                            <option value="SNLS">SNLS</option>
                            <option value="SNCS">SNCS</option>
                            <option value="Others">Others</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row" id="customMachineRow" style="display: none;">
                    <div class="form-group">
                        <label for="customMachineName">Custom Machine Name *</label>
                        <input type="text" id="customMachineName" placeholder="Enter custom machine name">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="standardSMV">Standard SMV (Minutes) *</label>
                        <input type="number" id="standardSMV" step="0.01" required placeholder="e.g., 0.45">
                    </div>
                    <div class="form-group">
                        <label for="studyOtherMachines">Other Machines Used</label>
                        <div class="multi-select" id="otherMachinesSelect">
                            <div class="multi-select-display">
                                <span>Select machines...</span>
                                <i class="fas fa-chevron-down"></i>
                            </div>
                            <div class="multi-select-options" id="otherMachinesOptions">
                            </div>
                            <div class="selected-options" id="selectedOtherMachines">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Allowance Information Display -->
                <div class="edit-info" id="allowanceInfo" style="margin-top: 15px; display: none;">
                    <h4 style="color: var(--primary-color); margin-bottom: 10px;"><i class="fas fa-calculator"></i> Allowance Breakdown</h4>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                        <div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">Personal Allowance</div>
                            <div style="font-weight: 600; color: var(--success-color);" id="personalAllowanceDisplay">11%</div>
                        </div>
                        <div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">Contingency Allowance</div>
                            <div style="font-weight: 600; color: var(--warning-color);" id="contingencyAllowanceDisplay">2%</div>
                        </div>
                        <div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">Machine Allowance</div>
                            <div style="font-weight: 600; color: var(--primary-color);" id="machineAllowanceDisplay">0%</div>
                        </div>
                    </div>
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                        <div style="display: flex; justify-content: space-between;">
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">Total Allowance:</div>
                            <div style="font-weight: 700; color: var(--accent-color);" id="totalAllowanceDisplay">13%</div>
                        </div>
                    </div>
                </div>
                
                <!-- Single Stopwatch with manual cycle input option -->
                <h4 style="margin-top: 20px; margin-bottom: 15px; color: var(--text-primary);">Cycle Time Measurement</h4>
                <div class="cycle-options">
                    <label>
                        <input type="radio" name="cycleCount" value="3" checked> 3 Cycles
                    </label>
                    <label>
                        <input type="radio" name="cycleCount" value="5"> 5 Cycles
                    </label>
                    <label>
                        <input type="radio" name="cycleCount" value="manual"> Manual Input
                    </label>
                </div>
                
                <div class="single-stopwatch">
                    <div class="stopwatch-display-container">
                        <div class="stopwatch-main" id="stopwatchDisplay">00:00:00.000</div>
                        <div class="stopwatch-lap" id="lapDisplay">Lap: 00:00:00.000</div>
                    </div>
                    
                    <div class="stopwatch-controls">
                        <button class="stopwatch-btn stopwatch-btn-start" id="startBtn">
                            <i class="fas fa-play"></i> Start
                        </button>
                        <button class="stopwatch-btn stopwatch-btn-stop" id="stopBtn" disabled>
                            <i class="fas fa-stop"></i> Stop
                        </button>
                        <button class="stopwatch-btn stopwatch-btn-lap" id="lapBtn" disabled>
                            <i class="fas fa-stopwatch"></i> Lap
                        </button>
                        <button class="stopwatch-btn stopwatch-btn-lap" id="resetBtn">
                            <i class="fas fa-redo"></i> Reset
                        </button>
                    </div>
                    
                    <!-- Manual Cycle Time Input -->
                    <div class="manual-cycle-inputs" id="manualCycleInputs" style="display: none;">
                        <h4><i class="fas fa-keyboard"></i> Enter Cycle Times Manually</h4>
                        <div class="cycle-input-grid" id="manualCycleGrid">
                            <div class="cycle-input-group">
                                <label>Cycle 1 (seconds)</label>
                                <input type="number" class="manual-cycle-time" step="0.001" placeholder="e.g., 25.345">
                            </div>
                            <div class="cycle-input-group">
                                <label>Cycle 2 (seconds)</label>
                                <input type="number" class="manual-cycle-time" step="0.001" placeholder="e.g., 26.123">
                            </div>
                            <div class="cycle-input-group">
                                <label>Cycle 3 (seconds)</label>
                                <input type="number" class="manual-cycle-time" step="0.001" placeholder="e.g., 24.987">
                            </div>
                        </div>
                        <div class="action-buttons">
                            <button id="addManualCycleBtn" class="btn btn-secondary">
                                <i class="fas fa-plus"></i> Add More Cycles
                            </button>
                            <button id="calculateManualBtn" class="btn btn-primary">
                                <i class="fas fa-calculator"></i> Calculate
                            </button>
                        </div>
                    </div>
                    
                    <div class="laps-container">
                        <div class="laps-header">
                            <div>Cycle #</div>
                            <div>Time (sec)</div>
                        </div>
                        <div id="lapsList">
                        </div>
                    </div>
                </div>
                
                <!-- Results with machine-specific allowance -->
                <div class="cycle-results">
                    <h4 style="color: var(--primary-color);"><i class="fas fa-calculator"></i> Calculation Results (with machine-specific allowances)</h4>
                    <div class="results-grid">
                        <div class="result-item">
                            <div class="result-value" id="avgCycleTime">0.00</div>
                            <div class="result-label">Avg Cycle Time (sec)</div>
                        </div>
                        <div class="result-item">
                            <div class="result-value" id="totalCycleTime">0.00</div>
                            <div class="result-label">Total Time (sec)</div>
                        </div>
                        <div class="result-item">
                            <div class="result-value" id="workingSMVResult">0.00</div>
                            <div class="result-label">Working SMV (min)</div>
                        </div>
                        <div class="result-item">
                            <div class="result-value" id="efficiencyResult">0%</div>
                            <div class="result-label">Efficiency</div>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button id="resetStopwatch" class="btn btn-danger">
                            <i class="fas fa-redo"></i> Reset All
                        </button>
                        <button id="savePerformanceData" class="btn btn-success">
                            <i class="fas fa-save"></i> Save Performance Record
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gridding Criteria Tab -->
        <div id="gridding-criteria" class="tab-content">
            <div class="gridding-criteria-content">
                <div class="criteria-section">
                    <h3><i class="fas fa-users"></i> Multi-Skills Classification</h3>
                    <div class="criteria-grid">
                        <div class="criteria-card">
                            <h4><i class="fas fa-star" style="color: var(--success-color);"></i> Grade A</h4>
                            <div class="criteria-details">
                                <div class="criteria-item">
                                    <div class="criteria-icon group-a">
                                        <i class="fas fa-check"></i>
                                    </div>
                                    <div class="criteria-text">
                                        <strong>3+ machine types</strong>
                                        <div class="description">With at least 1 machine at A grade, others at B or C</div>
                                    </div>
                                </div>
                                <div class="criteria-item">
                                    <div class="criteria-icon group-a">
                                        <i class="fas fa-user-check"></i>
                                    </div>
                                    <div class="criteria-text">
                                        <strong>Multi-skilled high performer</strong>
                                        <div class="description">Excellent versatility and efficiency across multiple operations</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="criteria-card">
                            <h4><i class="fas fa-star" style="color: var(--primary-color);"></i> Grade B</h4>
                            <div class="criteria-details">
                                <div class="criteria-item">
                                    <div class="criteria-icon group-b">
                                        <i class="fas fa-check"></i>
                                    </div>
                                    <div class="criteria-text">
                                        <strong>2+ machine types</strong>
                                        <div class="description">With at least 1 machine at B grade, the other at C</div>
                                    </div>
                                </div>
                                <div class="criteria-item">
                                    <div class="criteria-icon group-b">
                                        <i class="fas fa-user-check"></i>
                                    </div>
                                    <div class="criteria-text">
                                        <strong>Good performer with multiple skills</strong>
                                        <div class="description">Reliable performance across 2-3 operations</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="criteria-card">
                            <h4><i class="fas fa-star" style="color: var(--warning-color);"></i> Grade C</h4>
                            <div class="criteria-details">
                                <div class="criteria-item">
                                    <div class="criteria-icon group-c">
                                        <i class="fas fa-check"></i>
                                    </div>
                                    <div class="criteria-text">
                                        <strong>2 machine types</strong>
                                        <div class="description">Both machines at C grade</div>
                                    </div>
                                </div>
                                <div class="criteria-item">
                                    <div class="criteria-icon group-c">
                                        <i class="fas fa-user-check"></i>
                                    </div>
                                    <div class="criteria-text">
                                        <strong>Basic multi-skill operator</strong>
                                        <div class="description">Developing skills on 2 operations</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="criteria-card">
                            <h4><i class="fas fa-star" style="color: var(--accent-color);"></i> Grade D</h4>
                            <div class="criteria-details">
                                <div class="criteria-item">
                                    <div class="criteria-icon group-d">
                                        <i class="fas fa-check"></i>
                                    </div>
                                    <div class="criteria-text">
                                        <strong>1 machine type</strong>
                                        <div class="description">Only manual operations, but can handle 1 machine at D grade</div>
                                    </div>
                                </div>
                                <div class="criteria-item">
                                    <div class="criteria-icon group-d">
                                        <i class="fas fa-user-check"></i>
                                    </div>
                                    <div class="criteria-text">
                                        <strong>Developing skill set</strong>
                                        <div class="description">Entry-level operator learning basic operations</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="criteria-section">
                    <h3><i class="fas fa-chart-line"></i> Skills Index Criteria</h3>
                    <div class="criteria-grid">
                        <div class="criteria-card">
                            <h4><i class="fas fa-award" style="color: var(--success-color);"></i> Skill Level A</h4>
                            <div class="criteria-details">
                                <div class="criteria-item">
                                    <div class="criteria-icon group-a">
                                        <i class="fas fa-cogs"></i>
                                    </div>
                                    <div class="criteria-text">
                                        <strong>3 machines, 3 operations</strong>
                                        <div class="description">Versatile across multiple operations</div>
                                    </div>
                                </div>
                                <div class="criteria-item">
                                    <div class="criteria-icon group-a">
                                        <i class="fas fa-times-circle"></i>
                                    </div>
                                    <div class="criteria-text">
                                        <strong>0-2% WFT</strong>
                                        <div class="description">Wrong First Time (Quality metric)</div>
                                    </div>
                                </div>
                                <div class="criteria-item">
                                    <div class="criteria-icon group-a">
                                        <i class="fas fa-bolt"></i>
                                    </div>
                                    <div class="criteria-text">
                                        <strong>60%+ efficiency</strong>
                                        <div class="description">Excellent performance on machine</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="criteria-card">
                            <h4><i class="fas fa-award" style="color: var(--primary-color);"></i> Skill Level B</h4>
                            <div class="criteria-details">
                                <div class="criteria-item">
                                    <div class="criteria-icon group-b">
                                        <i class="fas fa-cogs"></i>
                                    </div>
                                    <div class="criteria-text">
                                        <strong>2 machines, 3 operations</strong>
                                        <div class="description">Good operational range</div>
                                    </div>
                                </div>
                                <div class="criteria-item">
                                    <div class="criteria-icon group-b">
                                        <i class="fas fa-times-circle"></i>
                                    </div>
                                    <div class="criteria-text">
                                        <strong>2.5-3% WFT</strong>
                                        <div class="description">Wrong First Time (Quality metric)</div>
                                    </div>
                                </div>
                                <div class="criteria-item">
                                    <div class="criteria-icon group-b">
                                        <i class="fas fa-bolt"></i>
                                    </div>
                                    <div class="criteria-text">
                                        <strong>55%+ efficiency</strong>
                                        <div class="description">Good performance on machine</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="criteria-card">
                            <h4><i class="fas fa-award" style="color: var(--warning-color);"></i> Skill Level C</h4>
                            <div class="criteria-details">
                                <div class="criteria-item">
                                    <div class="criteria-icon group-c">
                                        <i class="fas fa-cogs"></i>
                                    </div>
                                    <div class="criteria-text">
                                        <strong>2 machines, 2 operations</strong>
                                        <div class="description">Basic operational capability</div>
                                    </div>
                                </div>
                                <div class="criteria-item">
                                    <div class="criteria-icon group-c">
                                        <i class="fas fa-times-circle"></i>
                                    </div>
                                    <div class="criteria-text">
                                        <strong>3.5-5% WFT</strong>
                                        <div class="description">Wrong First Time (Quality metric)</div>
                                    </div>
                                </div>
                                <div class="criteria-item">
                                    <div class="criteria-icon group-c">
                                        <i class="fas fa-bolt"></i>
                                    </div>
                                    <div class="criteria-text">
                                        <strong>50%+ efficiency</strong>
                                        <div class="description">Basic performance on machine</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="criteria-card">
                            <h4><i class="fas fa-award" style="color: var(--accent-color);"></i> Skill Level D</h4>
                            <div class="criteria-details">
                                <div class="criteria-item">
                                    <div class="criteria-icon group-d">
                                        <i class="fas fa-cogs"></i>
                                    </div>
                                    <div class="criteria-text">
                                        <strong>1 machine, 2 operations</strong>
                                        <div class="description">Limited operational scope</div>
                                    </div>
                                </div>
                                <div class="criteria-item">
                                    <div class="criteria-icon group-d">
                                        <i class="fas fa-times-circle"></i>
                                    </div>
                                    <div class="criteria-text">
                                        <strong>5.5%+ WFT</strong>
                                        <div class="description">Wrong First Time (Quality metric)</div>
                                    </div>
                                </div>
                                <div class="criteria-item">
                                    <div class="criteria-icon group-d">
                                        <i class="fas fa-bolt"></i>
                                    </div>
                                    <div class="criteria-text">
                                        <strong>50% efficiency</strong>
                                        <div class="description">Entry level on machine</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="criteria-section">
                    <h3><i class="fas fa-chart-bar"></i> Efficiency Classification</h3>
                    <div class="criteria-grid">
                        <div class="criteria-card">
                            <h4><i class="fas fa-arrow-up" style="color: var(--success-color);"></i> High Efficiency</h4>
                            <div class="criteria-details">
                                <div class="criteria-item">
                                    <div class="criteria-icon group-a">
                                        <i class="fas fa-chart-line"></i>
                                    </div>
                                    <div class="criteria-text">
                                        <strong>85% Efficiency</strong>
                                        <div class="description">Exceeds expectations - Top performer</div>
                                    </div>
                                </div>
                                <div class="criteria-item">
                                    <div class="criteria-icon group-a">
                                        <i class="fas fa-trophy"></i>
                                    </div>
                                    <div class="criteria-text">
                                        <strong>Performance Rating</strong>
                                        <div class="description">Consistently exceeds targets</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="criteria-card">
                            <h4><i class="fas fa-equals" style="color: var(--primary-color);"></i> Medium Efficiency</h4>
                            <div class="criteria-details">
                                <div class="criteria-item">
                                    <div class="criteria-icon group-b">
                                        <i class="fas fa-chart-line"></i>
                                    </div>
                                    <div class="criteria-text">
                                        <strong>70-85% Efficiency</strong>
                                        <div class="description">Meets expectations - Reliable performer</div>
                                    </div>
                                </div>
                                <div class="criteria-item">
                                    <div class="criteria-icon group-b">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                    <div class="criteria-text">
                                        <strong>Performance Rating</strong>
                                        <div class="description">Consistently meets targets</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="criteria-card">
                            <h4><i class="fas fa-arrow-down" style="color: var(--warning-color);"></i> Low Efficiency</h4>
                            <div class="criteria-details">
                                <div class="criteria-item">
                                    <div class="criteria-icon group-c">
                                        <i class="fas fa-chart-line"></i>
                                    </div>
                                    <div class="criteria-text">
                                        <strong>&lt;70% Efficiency</strong>
                                        <div class="description">Needs improvement - Requires training</div>
                                    </div>
                                </div>
                                <div class="criteria-item">
                                    <div class="criteria-icon group-c">
                                        <i class="fas fa-exclamation-triangle"></i>
                                    </div>
                                    <div class="criteria-text">
                                        <strong>Performance Rating</strong>
                                        <div class="description">Below target, needs attention</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <p> 2025 Sidney Apparels LLC - Manufacturing Excellence</p>
            <div class="footer-credit">Made by Shantanu in HTML - Version 13.0</div>
            <div class="footer-stats">
                <div class="footer-stat">
                    <i class="fas fa-database"></i>
                    <span>Data Version: <strong id="dataVersion">13.0.0</strong></span>
                </div>
                <div class="footer-stat">
                    <i class="fas fa-sync-alt"></i>
                    <span>Last Sync: <strong id="lastSync">--:--:--</strong></span>
                </div>
                <div class="footer-stat">
                    <i class="fas fa-shield-alt"></i>
                    <span>Secure Connection: <strong>Active</strong></span>
                </div>
            </div>
        </footer>
    </div>

    <!-- Add Operator Modal -->
    <div id="addOperatorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus"></i> Add New Operator</h3>
                <span class="close-modal" data-modal="addOperatorModal">&times;</span>
            </div>
            <div class="modal-body">
                <form id="addOperatorForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="newOperatorId">Operator ID *</label>
                            <input type="text" id="newOperatorId" required placeholder="e.g., OP-435264">
                        </div>
                        <div class="form-group">
                            <label for="newOperatorName">Operator Name *</label>
                            <input type="text" id="newOperatorName" required placeholder="Full name">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="newSewLine">Current Sew Line</label>
                            <input type="text" id="newSewLine" placeholder="e.g., S-22, S-23">
                        </div>
                        <div class="form-group">
                            <label for="newSkillLevel">Initial Skill Level</label>
                            <select id="newSkillLevel">
                                <option value="">Select Level</option>
                                <option value="Group A">Group A</option>
                                <option value="Group B">Group B</option>
                                <option value="Group C">Group C</option>
                                <option value="Group D">Group D</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" data-modal="addOperatorModal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Operator</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Skill Score Modal -->
    <div id="editCellModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> Edit Operator Details</h3>
                <span class="close-modal" data-modal="editCellModal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="edit-info">
                    <p><strong>Operator ID:</strong> <span id="editOperatorId"></span></p>
                    <p><strong>Operator Name:</strong> <span id="editOperatorName"></span></p>
                </div>
                <form id="editCellForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editSewLine">Current Sew Line</label>
                            <input type="text" id="editSewLine" placeholder="e.g., S-22, S-23">
                        </div>
                        <div class="form-group">
                            <label for="editSkillLevel">Skill Level</label>
                            <select id="editSkillLevel">
                                <option value="Group A">Group A</option>
                                <option value="Group B">Group B</option>
                                <option value="Group C">Group C</option>
                                <option value="Group D">Group D</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editSkillScore">Skill Score (0.0 - 1.0)</label>
                        <input type="number" id="editSkillScore" min="0" max="1" step="0.05" required placeholder="e.g., 0.85">
                        <div class="score-slider">
                            <input type="range" id="scoreSlider" min="0" max="100" value="0">
                            <div class="slider-labels">
                                <span>0.0</span>
                                <span>0.5</span>
                                <span>1.0</span>
                            </div>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" data-modal="editCellModal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Group Operators Modal with search and sorting -->
    <div id="groupOperatorsModal" class="modal group-operators-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-users"></i> <span id="groupModalTitle">Group A Operators</span></h3>
                <span class="close-modal" data-modal="groupOperatorsModal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="edit-info">
                    <p><strong>Total Operators:</strong> <span id="groupOperatorCount">0</span></p>
                    <p><strong>Average Efficiency:</strong> <span id="groupAvgEfficiency">0%</span></p>
                    <p><strong>Skill Description:</strong> <span id="groupDescription"></span></p>
                </div>
                
                <div class="search-filter" style="margin-bottom: 15px;">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="groupSearchInput" placeholder="Search within group...">
                    </div>
                    <div class="filter-options">
                        <select id="groupSortBy">
                            <option value="skillScore">Sort by: Skill Score</option>
                            <option value="efficiency">Sort by: Efficiency</option>
                            <option value="name">Sort by: Name</option>
                            <option value="line">Sort by: Line</option>
                        </select>
                    </div>
                </div>
                
                <div class="group-operators-list" id="groupOperatorsList" style="max-height: 400px; overflow-y: auto;">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" data-modal="groupOperatorsModal">Close</button>
                    <button type="button" class="btn btn-primary" id="exportGroupBtn">
                        <i class="fas fa-file-excel"></i> Export to Excel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Performance Modal -->
    <div id="addPerformanceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-chart-line"></i> Add Performance Record</h3>
                <span class="close-modal" data-modal="addPerformanceModal">&times;</span>
            </div>
            <div class="modal-body">
                <form id="addPerformanceForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="perfOperatorId">Operator ID *</label>
                            <select id="perfOperatorId" required>
                                <option value="">Select Operator</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="perfLineNo">Line No *</label>
                            <input type="text" id="perfLineNo" required placeholder="Enter line number">
                        </div>
                        <div class="form-group">
                            <label for="perfStyleNo">Style No *</label>
                            <input type="text" id="perfStyleNo" required placeholder="Enter style number">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="perfProductDesc">Product Description *</label>
                            <input type="text" id="perfProductDesc" required placeholder="Enter product description">
                        </div>
                        <div class="form-group">
                            <label for="perfOperation">Operation Name *</label>
                            <input type="text" id="perfOperation" required placeholder="e.g., Hemming">
                        </div>
                        <div class="form-group">
                            <label for="perfMachine">Machine Name *</label>
                            <select id="perfMachine" required>
                                <option value="">Select Machine</option>
                                <option value="BARTACK">BARTACK</option>
                                <option value="BUTTON ATTACH">BUTTON ATTACH</option>
                                <option value="BUTTONHOLE">BUTTONHOLE</option>
                                <option value="DNLS">DNLS</option>
                                <option value="FLATLOCK">FLATLOCK</option>
                                <option value="FOA">FOA</option>
                                <option value="FS">FS</option>
                                <option value="KANSAI">KANSAI</option>
                                <option value="OVERLOCK">OVERLOCK</option>
                                <option value="SNLS">SNLS</option>
                                <option value="SNCS">SNCS</option>
                                <option value="Others">Others</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row" id="perfCustomMachineRow" style="display: none;">
                        <div class="form-group">
                            <label for="perfCustomMachineName">Custom Machine Name *</label>
                            <input type="text" id="perfCustomMachineName" placeholder="Enter custom machine name">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="perfStdSMV">Standard SMV (min) *</label>
                            <input type="number" id="perfStdSMV" step="0.01" required placeholder="e.g., 0.45">
                        </div>
                        <div class="form-group">
                            <label for="perfWorkingSMV">Operator Working SMV (min) *</label>
                            <input type="number" id="perfWorkingSMV" step="0.01" required placeholder="e.g., 0.52">
                        </div>
                        <div class="form-group">
                            <label for="perfOtherMachines">Other Machines Used</label>
                            <div class="multi-select" id="perfOtherMachinesSelect">
                                <div class="multi-select-display">
                                    <span>Select machines...</span>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div class="multi-select-options" id="perfOtherMachinesOptions">
                                </div>
                                <div class="selected-options" id="perfSelectedOtherMachines">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Cycle Times (seconds)</label>
                            <div id="manualCycleTimes">
                            </div>
                            <button type="button" class="btn btn-secondary" id="addCycleTimeBtn">
                                <i class="fas fa-plus"></i> Add Cycle Time
                            </button>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" data-modal="addPerformanceModal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Performance Data</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Enhanced Working SMV Detail Modal -->
    <div id="cycleDetailModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3><i class="fas fa-calculator"></i> Working SMV Breakdown</h3>
                <span class="close-modal" data-modal="cycleDetailModal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="cycle-info">
                    <h4 style="margin-bottom: 15px;">Performance Details</h4>
                    <div class="breakdown-grid">
                        <div class="breakdown-item">
                            <div class="value" id="detailOperatorName">-</div>
                            <div class="label">Operator</div>
                        </div>
                        <div class="breakdown-item">
                            <div class="value" id="detailOperation">-</div>
                            <div class="label">Operation</div>
                        </div>
                        <div class="breakdown-item">
                            <div class="value" id="detailStdSMV">0.00</div>
                            <div class="label">Standard SMV (min)</div>
                        </div>
                        <div class="breakdown-item">
                            <div class="value" id="detailWorkingSMV">0.00</div>
                            <div class="label">Working SMV (min)</div>
                        </div>
                    </div>
                    
                    <div class="smv-breakdown">
                        <h4><i class="fas fa-calculator"></i> Calculation Formula</h4>
                        <div class="formula-display">
                            Working SMV = (Average Cycle Time in seconds  60)  (1 + Allowance%)<br>
                            Where: Allowance = Personal (11%) + Contingency (2%) + Machine Allowance
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                        <div>
                            <h4 style="color: var(--success-color); margin-bottom: 10px;">Efficiency</h4>
                            <div style="font-size: 2rem; font-weight: 700; color: var(--success-color);" id="detailEfficiency">0%</div>
                        </div>
                        <div>
                            <h4 style="color: var(--primary-color); margin-bottom: 10px;">Variance</h4>
                            <div style="font-size: 2rem; font-weight: 700; color: var(--primary-color);" id="detailVariance">0%</div>
                        </div>
                    </div>
                </div>
                
                <h4 style="margin: 20px 0 10px 0;">Cycle Times (seconds)</h4>
                <div class="cycle-times-list" id="cycleTimesList" style="max-height: 200px; overflow-y: auto;">
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Performance Record Modal -->
    <div id="editPerformanceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> Edit Performance Record</h3>
                <span class="close-modal" data-modal="editPerformanceModal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="edit-info">
                    <p><strong>Record ID:</strong> <span id="editRecordId"></span></p>
                    <p><strong>Operator:</strong> <span id="editRecordOperator"></span></p>
                </div>
                <form id="editPerformanceForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editRecordStdSMV">Standard SMV (min)</label>
                            <input type="number" id="editRecordStdSMV" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="editRecordWorkingSMV">Working SMV (min)</label>
                            <input type="number" id="editRecordWorkingSMV" step="0.01" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editRecordCycleTimes">Cycle Times (seconds, comma-separated)</label>
                        <input type="text" id="editRecordCycleTimes" placeholder="e.g., 25.3, 26.1, 24.8">
                        <small style="color: var(--text-secondary); display: block; margin-top: 5px;">
                            Enter cycle times separated by commas. Changing these will recalculate Working SMV with machine-specific allowances.
                        </small>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" data-modal="editPerformanceModal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Update Record</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="notificationToast" class="toast">
        <div class="toast-content">
            <i class="fas fa-check-circle"></i>
            <span id="toastMessage">Operation completed successfully!</span>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDocs, updateDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp, Timestamp, where } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD-kUUKaIP5h6uXCiSYYCePf0pWmf6QcwY",
            authDomain: "skill-matrix-3be5a.firebaseapp.com",
            projectId: "skill-matrix-3be5a",
            storageBucket: "skill-matrix-3be5a.firebasestorage.app",
            messagingSenderId: "614498722664",
            appId: "1:614498722664:web:e2a602f71b0ecb59c4acdd",
            measurementId: "G-60LG5FH4WB"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Application state
        let operators = [];
        let performanceData = [];
        let selectedOperatorId = null;
        let lineDetails = JSON.parse(localStorage.getItem('lineDetails')) || {};
        let operatorMachineSkills = JSON.parse(localStorage.getItem('operatorMachineSkills')) || {};

        // Stopwatch variables
        let stopwatchRunning = false;
        let stopwatchStartTime = 0;
        let stopwatchTotalElapsed = 0;
        let lapStartTime = 0;
        let lapElapsed = 0;
        let lapCounter = 0;
        let lapTimes = [];
        let stopwatchInterval = null;
        let cycleCount = 3;

        // Dashboard charts
        let efficiencyChart = null;
        let linePerformanceChart = null;
        let machinePerformanceChart = null;
        let weeklyTrendChart = null;
        let skillDistributionChart = null;

        // CHANGED: Machine allowance mapping for v13
        const machineAllowances = {
            'SNLS': 7,
            'KANSAI': 18,
            'SNCS': 7,
            'BUTTONHOLE': 7,
            'BARTACK': 3,
            'FLATLOCK': 7,
            'OVERLOCK': 10,
            'FS': 14,
            'DNLS': 7,
            'FOA': 7,
            'BUTTON ATTACH': 7,
            'Others': 7 // Default for other machines
        };

        // Personal and contingency allowances (fixed)
        const PERSONAL_ALLOWANCE = 11;
        const CONTINGENCY_ALLOWANCE = 2;

        // DOM Elements
        const elements = {
            loadingOverlay: document.getElementById('loadingOverlay'),
            sidebarCurrentTime: document.getElementById('sidebarCurrentTime'),
            sidebarLastUpdated: document.getElementById('sidebarLastUpdated'),
            headerLastSync: document.getElementById('headerLastSync'),
            headerTotalOps: document.getElementById('headerTotalOps'),
            dataVersion: document.getElementById('dataVersion'),
            lastSync: document.getElementById('lastSync'),
            totalOperators: document.getElementById('totalOperators'),
            groupACount: document.getElementById('operatorsGroupACount'),
            groupBCount: document.getElementById('operatorsGroupBCount'),
            groupCCount: document.getElementById('operatorsGroupCCount'),
            groupDCount: document.getElementById('operatorsGroupDCount'),
            performanceRecords: document.getElementById('performanceRecords'),
            performanceAvgEfficiency: document.getElementById('performanceAvgEfficiency'),
            performanceTotalOps: document.getElementById('performanceTotalOps'),
            timeStudies: document.getElementById('timeStudies'),
            timeStudyAvgCycle: document.getElementById('timeStudyAvgCycle'),
            timeStudyCompleted: document.getElementById('timeStudyCompleted'),
            avgEfficiency: document.getElementById('avgEfficiency'),
            avgSMV: document.getElementById('avgSMV'),
            avgWorkingSMV: document.getElementById('avgWorkingSMV'),
            totalOperations: document.getElementById('totalOperations'),
            analysisSummary: document.getElementById('analysisSummary'),
            activeLines: document.getElementById('activeLines'),
            avgSMVDiff: document.getElementById('avgSMVDiff'),
            searchInput: document.getElementById('searchInput'),
            skillFilter: document.getElementById('skillFilter'),
            lineFilter: document.getElementById('lineFilter'),
            operatorsBody: document.getElementById('operatorsBody'),
            performanceBody: document.getElementById('performanceBody'),
            notificationToast: document.getElementById('notificationToast'),
            toastMessage: document.getElementById('toastMessage'),
            stopwatchDisplay: document.getElementById('stopwatchDisplay'),
            lapDisplay: document.getElementById('lapDisplay'),
            lapsList: document.getElementById('lapsList'),
            machineUsageStats: document.getElementById('machineUsageStats'),
            groupOperatorsList: document.getElementById('groupOperatorsList'),
            groupModalTitle: document.getElementById('groupModalTitle'),
            groupOperatorCount: document.getElementById('groupOperatorCount'),
            groupAvgEfficiency: document.getElementById('groupAvgEfficiency'),
            groupDescription: document.getElementById('groupDescription'),
            // Dashboard elements v11
            dashboardTotalOperators: document.getElementById('dashboardTotalOperators'),
            dashboardGroupACount: document.getElementById('dashboardGroupACount'),
            dashboardGroupBCount: document.getElementById('dashboardGroupBCount'),
            dashboardGroupCCount: document.getElementById('dashboardGroupCCount'),
            dashboardGroupDCount: document.getElementById('dashboardGroupDCount'),
            dashboardAvgEfficiency: document.getElementById('dashboardAvgEfficiency'),
            dashboardAvgSMV: document.getElementById('dashboardAvgSMV'),
            dashboardAvgWorkingSMV: document.getElementById('dashboardAvgWorkingSMV'),
            dashboardTotalOperations: document.getElementById('dashboardTotalOperations'),
            dashboardActiveLines: document.getElementById('dashboardActiveLines'),
            dashboardMachineUsage: document.getElementById('dashboardMachineUsage'),
            recentActivity: document.getElementById('recentActivity'),
            skillGroupACount: document.getElementById('skillGroupACount'),
            skillGroupBCount: document.getElementById('skillGroupBCount'),
            skillGroupCCount: document.getElementById('skillGroupCCount'),
            skillGroupDCount: document.getElementById('skillGroupDCount'),
            // Garment SMV elements
            totalStandardSMV: document.getElementById('totalStandardSMV'),
            totalWorkingSMV: document.getElementById('totalWorkingSMV'),
            standardSMVLineSelect: document.getElementById('standardSMVLineSelect'),
            standardSMVStyleSelect: document.getElementById('standardSMVStyleSelect'),
            workingSMVLineSelect: document.getElementById('workingSMVLineSelect'),
            workingSMVStyleSelect: document.getElementById('workingSMVStyleSelect'),
            // Time study elements
            studyLineNo: document.getElementById('studyLineNo'),
            studyStyleNo: document.getElementById('studyStyleNo'),
            studyProductDesc: document.getElementById('studyProductDesc'),
            // Allowance display elements
            allowanceInfo: document.getElementById('allowanceInfo'),
            personalAllowanceDisplay: document.getElementById('personalAllowanceDisplay'),
            contingencyAllowanceDisplay: document.getElementById('contingencyAllowanceDisplay'),
            machineAllowanceDisplay: document.getElementById('machineAllowanceDisplay'),
            totalAllowanceDisplay: document.getElementById('totalAllowanceDisplay'),
            // Mobile menu
            mobileMenuToggle: document.getElementById('mobileMenuToggle'),
            sidebar: document.getElementById('sidebar'),
            sidebarOverlay: document.getElementById('sidebarOverlay')
        };

        // Initialize application
        document.addEventListener('DOMContentLoaded', async () => {
            await loadData();
            setupEventListeners();
            setupSidebarNavigation();
            updateRealTimeClock();
            loadOperatorMachineSkills();
            
            // Start real-time clock
            setInterval(updateRealTimeClock, 1000);
            
            // Hide loading overlay
            setTimeout(() => {
                elements.loadingOverlay.style.display = 'none';
            }, 1500);
        });

        // Update real-time clock
        function updateRealTimeClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', {
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            const dateString = now.toLocaleDateString('en-US', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
            
            elements.sidebarCurrentTime.textContent = timeString;
            elements.sidebarLastUpdated.textContent = dateString;
            elements.headerLastSync.textContent = timeString;
            elements.lastSync.textContent = timeString;
            elements.dataVersion.textContent = '13.0.0';
        }

        // Setup sidebar navigation - UPDATED for mobile
        function setupSidebarNavigation() {
            const navItems = document.querySelectorAll('.nav-item');
            const tabContents = document.querySelectorAll('.tab-content');
            
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    const tabId = item.getAttribute('data-tab');
                    
                    // Update active nav item
                    navItems.forEach(nav => nav.classList.remove('active'));
                    item.classList.add('active');
                    
                    // Show active tab content
                    tabContents.forEach(content => {
                        content.classList.remove('active');
                        if (content.id === tabId) {
                            content.classList.add('active');
                            
                            // Load specific data for dashboard tab
                            if (tabId === 'dashboard') {
                                updateDashboard();
                                createDashboardCharts();
                                updateGarmentSMVSelectors();
                            } else if (tabId === 'performance') {
                                updateMachineUsageStats();
                            }
                        }
                    });
                    
                    // Close mobile sidebar if open
                    if (window.innerWidth <= 768) {
                        closeMobileSidebar();
                    }
                });
            });
            
            // Make summary cards clickable
            document.querySelectorAll('.stat-card.clickable').forEach(card => {
                if (!card.id.includes('TotalOperatorsCard')) {
                    card.addEventListener('click', () => {
                        const tab = card.getAttribute('data-tab');
                        document.querySelector(`.nav-item[data-tab="${tab}"]`).click();
                    });
                }
            });
        }

        // Setup mobile menu toggle - UPDATED for v12
        function setupMobileMenu() {
            elements.mobileMenuToggle.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleMobileSidebar();
            });
            
            elements.sidebarOverlay.addEventListener('click', () => {
                closeMobileSidebar();
            });
            
            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', (e) => {
                if (window.innerWidth <= 768) {
                    if (!elements.sidebar.contains(e.target) && !elements.mobileMenuToggle.contains(e.target)) {
                        closeMobileSidebar();
                    }
                }
            });
            
            // Handle window resize
            window.addEventListener('resize', function() {
                if (window.innerWidth > 768) {
                    // Reset sidebar for desktop
                    elements.sidebar.style.transform = 'translateX(0)';
                    elements.sidebar.style.width = '240px';
                    elements.sidebarOverlay.classList.remove('active');
                    elements.mobileMenuToggle.classList.remove('active');
                } else {
                    // Ensure sidebar is hidden on mobile initially
                    elements.sidebar.style.transform = 'translateX(-100%)';
                    elements.sidebar.style.width = '240px';
                }
            });
        }

        function toggleMobileSidebar() {
            if (elements.sidebar.style.transform === 'translateX(0px)' || elements.sidebar.style.transform === '') {
                openMobileSidebar();
            } else {
                closeMobileSidebar();
            }
        }

        function openMobileSidebar() {
            elements.sidebar.style.transform = 'translateX(0)';
            elements.sidebarOverlay.classList.add('active');
            elements.mobileMenuToggle.classList.add('active');
        }

        function closeMobileSidebar() {
            elements.sidebar.style.transform = 'translateX(-100%)';
            elements.sidebarOverlay.classList.remove('active');
            elements.mobileMenuToggle.classList.remove('active');
        }

        // Update Garment SMV selectors
        function updateGarmentSMVSelectors() {
            // Get unique lines from performance data
            const lines = new Set();
            const stylesByLine = {};
            
            performanceData.forEach(record => {
                if (record.lineNo) {
                    lines.add(record.lineNo);
                    if (!stylesByLine[record.lineNo]) {
                        stylesByLine[record.lineNo] = new Set();
                    }
                    if (record.styleNo) {
                        stylesByLine[record.lineNo].add(record.styleNo);
                    }
                }
            });
            
            // Populate line selectors
            const lineSelectors = [
                elements.standardSMVLineSelect,
                elements.workingSMVLineSelect,
                document.getElementById('dashboardLineSelect'),
                document.getElementById('operatorsLineFilter'),
                document.getElementById('lineFilter'),
                document.getElementById('perfLineFilter'),
                document.getElementById('dashboardLineFilter')
            ];
            
            lineSelectors.forEach(select => {
                if (select) {
                    // Clear existing options except the first one
                    const firstOption = select.options[0];
                    select.innerHTML = '';
                    if (firstOption) select.appendChild(firstOption);
                    
                    // Add line options
                    Array.from(lines).sort().forEach(line => {
                        const option = document.createElement('option');
                        option.value = line;
                        option.textContent = line;
                        select.appendChild(option);
                    });
                }
            });
            
            // Update line datalist for time study and performance forms
            const lineNoList = document.getElementById('lineNoList');
            lineNoList.innerHTML = '';
            Array.from(lines).sort().forEach(line => {
                const option = document.createElement('option');
                option.value = line;
                lineNoList.appendChild(option);
            });
            
            // Add operators' sew lines to datalist
            operators.forEach(operator => {
                if (operator.sewLine && !Array.from(lines).includes(operator.sewLine)) {
                    const option = document.createElement('option');
                    option.value = operator.sewLine;
                    lineNoList.appendChild(option);
                }
            });
            
            // Add event listeners for style dropdown updates
            elements.standardSMVLineSelect.addEventListener('change', function() {
                updateStyleDropdown(this.value, elements.standardSMVStyleSelect);
                calculateGarmentSMV('standard');
            });
            
            elements.workingSMVLineSelect.addEventListener('change', function() {
                updateStyleDropdown(this.value, elements.workingSMVStyleSelect);
                calculateGarmentSMV('working');
            });
            
            elements.standardSMVStyleSelect.addEventListener('change', () => calculateGarmentSMV('standard'));
            elements.workingSMVStyleSelect.addEventListener('change', () => calculateGarmentSMV('working'));
            
            // Initial calculation
            calculateGarmentSMV('standard');
            calculateGarmentSMV('working');
        }

// Auto-fill style and product from the latest record for the line
function autoFillStyleAndProduct(lineNo, type = 'study') {
    if (!lineNo) return;
    
    // Find ALL performance records for this line and sort by timestamp (newest first)
    const lineRecords = performanceData
        .filter(record => record.lineNo === lineNo)
        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    
    if (lineRecords.length > 0) {
        // Always use the latest record (most recent timestamp)
        const latestRecord = lineRecords[0];
        
        console.log(`Auto-filling from latest record for line ${lineNo}:`, {
            styleNo: latestRecord.styleNo,
            productDesc: latestRecord.productDesc,
            timestamp: latestRecord.timestamp
        });
        
        if (type === 'study') {
            elements.studyStyleNo.value = latestRecord.styleNo || '';
            elements.studyProductDesc.value = latestRecord.productDesc || '';
        } else {
            document.getElementById('perfStyleNo').value = latestRecord.styleNo || '';
            document.getElementById('perfProductDesc').value = latestRecord.productDesc || '';
        }
        
        // Show toast notification about auto-fill
        showToast(`Auto-filled Style & Description from latest record for Line ${lineNo}`);
    } else {
        console.log(`No previous records found for line ${lineNo}`);
        // Clear fields if no records found
        if (type === 'study') {
            elements.studyStyleNo.value = '';
            elements.studyProductDesc.value = '';
        } else {
            document.getElementById('perfStyleNo').value = '';
            document.getElementById('perfProductDesc').value = '';
        }
    }
}

        // Update style dropdown based on selected line
        function updateStyleDropdown(line, styleSelect) {
            // Clear existing options except the first one
            const firstOption = styleSelect.options[0];
            styleSelect.innerHTML = '';
            if (firstOption) styleSelect.appendChild(firstOption);
            
            if (!line) {
                styleSelect.disabled = true;
                return;
            }
            
            // Get styles for the selected line
            const styles = new Set();
            performanceData.forEach(record => {
                if (record.lineNo === line && record.styleNo) {
                    styles.add(record.styleNo);
                }
            });
            
            if (styles.size === 0) {
                styleSelect.disabled = true;
                return;
            }
            
            styleSelect.disabled = false;
            
            // Add style options
            Array.from(styles).sort().forEach(style => {
                const option = document.createElement('option');
                option.value = style;
                option.textContent = style;
                styleSelect.appendChild(option);
            });
        }

        // Calculate Garment SMV
        function calculateGarmentSMV(type) {
            const lineSelect = type === 'standard' ? elements.standardSMVLineSelect : elements.workingSMVLineSelect;
            const styleSelect = type === 'standard' ? elements.standardSMVStyleSelect : elements.workingSMVStyleSelect;
            const totalElement = type === 'standard' ? elements.totalStandardSMV : elements.totalWorkingSMV;
            
            const line = lineSelect.value;
            const style = styleSelect.value;
            
            if (!line) {
                totalElement.textContent = '0.00';
                return;
            }
            
            // Filter performance data by line and style
            let filteredData = performanceData.filter(record => record.lineNo === line);
            
            if (style) {
                filteredData = filteredData.filter(record => record.styleNo === style);
            }
            
            if (filteredData.length === 0) {
                totalElement.textContent = '0.00';
                return;
            }
            
            // Calculate total SMV
            let totalSMV = 0;
            filteredData.forEach(record => {
                if (type === 'standard') {
                    totalSMV += record.standardSMV || 0;
                } else {
                    totalSMV += record.workingSMV || 0;
                }
            });
            
            totalElement.textContent = totalSMV.toFixed(2);
            
            // Add description tooltip
            const description = style 
                ? `Total ${type === 'standard' ? 'Standard' : 'Working'} SMV for Line ${line}, Style ${style}`
                : `Total ${type === 'standard' ? 'Standard' : 'Working'} SMV for Line ${line}`;
            
            totalElement.title = description;
        }

        // Stopwatch functions with machine-specific allowance
        function formatTime(milliseconds) {
            const totalSeconds = milliseconds / 1000;
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = Math.floor(totalSeconds % 60);
            const ms = Math.floor((milliseconds % 1000) / 10);
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}.${ms.toString().padStart(2, '0')}`;
        }

        function startStopwatch() {
            if (!stopwatchRunning) {
                const now = Date.now();
                stopwatchStartTime = now - stopwatchTotalElapsed;
                lapStartTime = now - lapElapsed;
                
                stopwatchInterval = setInterval(() => {
                    const currentTime = Date.now();
                    stopwatchTotalElapsed = currentTime - stopwatchStartTime;
                    lapElapsed = currentTime - lapStartTime;
                    
                    elements.stopwatchDisplay.textContent = formatTime(stopwatchTotalElapsed);
                    elements.lapDisplay.textContent = `Lap: ${formatTime(lapElapsed)}`;
                }, 10);
                
                stopwatchRunning = true;
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('lapBtn').disabled = false;
                document.getElementById('resetBtn').disabled = true;
            }
        }

        function stopStopwatch() {
            if (stopwatchRunning) {
                clearInterval(stopwatchInterval);
                stopwatchRunning = false;
                document.getElementById('stopBtn').disabled = true;
                document.getElementById('lapBtn').disabled = true;
                document.getElementById('startBtn').disabled = false;
                document.getElementById('resetBtn').disabled = false;
                
                // Record final lap if we have a lap in progress
                if (lapElapsed > 0 && lapCounter < cycleCount) {
                    recordLap();
                }
            }
        }

        function recordLap() {
            if (lapCounter < cycleCount) {
                lapCounter++;
                const lapTimeSeconds = lapElapsed / 1000;
                lapTimes.push(lapTimeSeconds);
                
                // Add lap to display
                const lapItem = document.createElement('div');
                lapItem.className = 'lap-item';
                lapItem.innerHTML = `
                    <div class="lap-number">Cycle ${lapCounter}</div>
                    <div class="lap-time">${lapTimeSeconds.toFixed(3)} sec</div>
                `;
                elements.lapsList.appendChild(lapItem);
                
                // Reset lap timer for next lap
                lapStartTime = Date.now();
                lapElapsed = 0;
                elements.lapDisplay.textContent = 'Lap: 00:00:00.00';
                
                // Check if we've reached the maximum cycles
                if (lapCounter >= cycleCount) {
                    stopStopwatch();
                    calculateResults();
                }
            }
        }

        function resetStopwatch() {
            clearInterval(stopwatchInterval);
            stopwatchRunning = false;
            stopwatchTotalElapsed = 0;
            lapElapsed = 0;
            lapCounter = 0;
            lapTimes = [];
            
            elements.stopwatchDisplay.textContent = '00:00:00.000';
            elements.lapDisplay.textContent = 'Lap: 00:00:00.000';
            elements.lapsList.innerHTML = '';
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('lapBtn').disabled = true;
            document.getElementById('resetBtn').disabled = true;
            
            document.getElementById('avgCycleTime').textContent = '0.00';
            document.getElementById('totalCycleTime').textContent = '0.00';
            document.getElementById('workingSMVResult').textContent = '0.00';
            document.getElementById('efficiencyResult').textContent = '0%';
        }

        // Get machine allowance percentage
        function getMachineAllowance(machineName) {
            // Handle custom machine names
            if (machineName === 'Others') {
                const customMachine = document.getElementById('customMachineName').value;
                if (customMachine) {
                    // Check if custom machine name matches any known machine
                    const machineKey = Object.keys(machineAllowances).find(key => 
                        customMachine.toUpperCase().includes(key)
                    );
                    return machineKey ? machineAllowances[machineKey] : machineAllowances['Others'];
                }
                return machineAllowances['Others'];
            }
            
            return machineAllowances[machineName] || machineAllowances['Others'];
        }

        // Update allowance display
        function updateAllowanceDisplay(machineName) {
            if (!machineName) {
                elements.allowanceInfo.style.display = 'none';
                return;
            }
            
            const machineAllowance = getMachineAllowance(machineName);
            const totalAllowance = PERSONAL_ALLOWANCE + CONTINGENCY_ALLOWANCE + machineAllowance;
            
            // Update display elements
            elements.personalAllowanceDisplay.textContent = PERSONAL_ALLOWANCE + '%';
            elements.contingencyAllowanceDisplay.textContent = CONTINGENCY_ALLOWANCE + '%';
            elements.machineAllowanceDisplay.textContent = machineAllowance + '%';
            elements.totalAllowanceDisplay.textContent = totalAllowance + '%';
            
            // Show the allowance info
            elements.allowanceInfo.style.display = 'block';
        }

        // Calculate results with machine-specific allowance
        function calculateResults() {
            if (lapTimes.length === 0) return;
            
            const totalTime = lapTimes.reduce((a, b) => a + b, 0);
            const avgTime = totalTime / lapTimes.length;
            
            // Get machine allowance
            const machineName = document.getElementById('studyMachine').value;
            const machineAllowance = getMachineAllowance(machineName);
            const totalAllowance = PERSONAL_ALLOWANCE + CONTINGENCY_ALLOWANCE + machineAllowance;
            
            const workingSMV = (avgTime / 60) * (1 + totalAllowance/100);
            const standardSMV = parseFloat(document.getElementById('standardSMV').value) || 0;
            const efficiency = standardSMV > 0 ? (standardSMV / workingSMV) * 100 : 0;
            
            document.getElementById('avgCycleTime').textContent = avgTime.toFixed(2);
            document.getElementById('totalCycleTime').textContent = totalTime.toFixed(2);
            document.getElementById('workingSMVResult').textContent = workingSMV.toFixed(2);
            document.getElementById('efficiencyResult').textContent = efficiency.toFixed(1) + '%';
            
            // Color code efficiency
            const efficiencyElem = document.getElementById('efficiencyResult');
            efficiencyElem.className = 'result-value ';
            if (efficiency >= 85) {
                efficiencyElem.classList.add('efficiency-high');
            } else if (efficiency >= 70) {
                efficiencyElem.classList.add('efficiency-medium');
            } else {
                efficiencyElem.classList.add('efficiency-low');
            }
        }

        // Calculate manual cycle times with machine-specific allowance
        function calculateManualCycles() {
            const manualTimes = [];
            document.querySelectorAll('.manual-cycle-time').forEach(input => {
                const value = parseFloat(input.value);
                if (!isNaN(value) && value > 0) {
                    manualTimes.push(value);
                }
            });
            
            if (manualTimes.length === 0) {
                showToast('Please enter at least one valid cycle time', 'error');
                return;
            }
            
            lapTimes = manualTimes;
            lapCounter = manualTimes.length;
            
            // Update laps display
            elements.lapsList.innerHTML = '';
            manualTimes.forEach((time, index) => {
                const lapItem = document.createElement('div');
                lapItem.className = 'lap-item';
                lapItem.innerHTML = `
                    <div class="lap-number">Cycle ${index + 1}</div>
                    <div class="lap-time">${time.toFixed(3)} sec</div>
                `;
                elements.lapsList.appendChild(lapItem);
            });
            
            calculateResults();
            showToast(`Calculated ${manualTimes.length} manual cycle times`);
        }

        // Load data from Firestore
        async function loadData() {
            try {
                // Load operators with real-time updates
                const operatorsQuery = query(collection(db, 'operators'), orderBy('operatorId'));
                onSnapshot(operatorsQuery, (snapshot) => {
                    operators = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        operators.push({
                            id: doc.id,
                            operatorId: data.operatorId || '',
                            name: data.name || '',
                            sewLine: data.sewLine || '',
                            skillLevel: data.skillLevel || '',
                            skillScore: data.skillScore || 0,
                            createdAt: data.createdAt?.toDate() || new Date(),
                            lastUpdated: data.lastUpdated?.toDate() || new Date()
                        });
                    });
                    renderOperatorsTable();
                    updateStats();
                    updateDashboardStats();
                    populateOperatorDropdowns();
                    populateLineFilter();
                    populateDashboardLineSelect();
                    populateOperatorsLineFilter();
                    updateGarmentSMVSelectors();
                    elements.headerTotalOps.textContent = operators.length;
                    
                    showToast(`${operators.length} operators loaded successfully!`);
                });
                
                // Load performance data
                const performanceQuery = query(collection(db, 'performance'), orderBy('timestamp', 'desc'));
                onSnapshot(performanceQuery, (snapshot) => {
                    performanceData = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        performanceData.push({
                            id: doc.id,
                            operatorId: data.operatorId || '',
                            operatorName: data.operatorName || '',
                            lineNo: data.lineNo || '',
                            styleNo: data.styleNo || '',
                            productDesc: data.productDesc || '',
                            operation: data.operation || '',
                            machineName: data.machineName || '',
                            customMachineName: data.customMachineName || '',
                            standardSMV: data.standardSMV || 0,
                            workingSMV: data.workingSMV || 0,
                            efficiency: data.efficiency || 0,
                            cycleTimes: data.cycleTimes || [],
                            otherMachines: data.otherMachines || '',
                            allowance: data.allowance || 13, // Default to 13% for backward compatibility
                            timestamp: data.timestamp?.toDate() || new Date(),
                            lastUpdated: data.lastUpdated?.toDate() || new Date()
                        });
                    });
                    renderPerformanceTable();
                    updatePerformanceStats();
                    updateSummaryStats();
                    updateMachineUsageStats();
                    updateDashboardStats();
                    updateRecentActivity();
                    updateGarmentSMVSelectors();
                    
                    // Update dashboard if active
                    if (document.getElementById('dashboard').classList.contains('active')) {
                        updateDashboard();
                        createDashboardCharts();
                    }
                });
            } catch (error) {
                console.error('Error loading data:', error);
                showToast('Error loading data: ' + error.message, 'error');
                elements.loadingOverlay.style.display = 'none';
            }
        }

        // Load operator machine skills
        function loadOperatorMachineSkills() {
            const skills = localStorage.getItem('operatorMachineSkills');
            if (skills) {
                operatorMachineSkills = JSON.parse(skills);
            }
        }

        // Save operator machine skills
        function saveOperatorMachineSkills() {
            localStorage.setItem('operatorMachineSkills', JSON.stringify(operatorMachineSkills));
        }

        // Update operator machine skill based on performance
        function updateOperatorMachineSkill(operatorId, machineName, efficiency) {
            if (!operatorMachineSkills[operatorId]) {
                operatorMachineSkills[operatorId] = {};
            }
            
            if (!operatorMachineSkills[operatorId][machineName]) {
                operatorMachineSkills[operatorId][machineName] = {
                    operations: new Set(),
                    efficiencies: [],
                    lastUpdated: new Date()
                };
            }
            
            // Add operation to set (unique operations)
            const operation = document.getElementById('studyOperation')?.value || 
                            document.getElementById('perfOperation')?.value || 'Unknown';
            operatorMachineSkills[operatorId][machineName].operations.add(operation);
            
            // Add efficiency to array
            operatorMachineSkills[operatorId][machineName].efficiencies.push(efficiency);
            
            // Keep only last 10 efficiencies
            if (operatorMachineSkills[operatorId][machineName].efficiencies.length > 10) {
                operatorMachineSkills[operatorId][machineName].efficiencies.shift();
            }
            
            operatorMachineSkills[operatorId][machineName].lastUpdated = new Date();
            saveOperatorMachineSkills();
        }

        // Calculate skill level for a machine based on performance
        function calculateMachineSkillLevel(operatorId, machineName) {
            if (!operatorMachineSkills[operatorId] || !operatorMachineSkills[operatorId][machineName]) {
                return 'D';
            }
            
            const data = operatorMachineSkills[operatorId][machineName];
            const avgEfficiency = data.efficiencies.length > 0 ? 
                data.efficiencies.reduce((a, b) => a + b, 0) / data.efficiencies.length : 0;
            const operationCount = data.operations.size;
            
            // Determine skill level based on new logic
            if (operationCount >= 3 && avgEfficiency >= 85) {
                return 'A';
            } else if (operationCount >= 3 && avgEfficiency >= 70) {
                return 'B';
            } else if (operationCount >= 2 && avgEfficiency >= 50) {
                return 'C';
            } else {
                return 'D';
            }
        }

        // Calculate multi-skill grade based on new logic
        function calculateMultiSkillGrade(operatorId) {
            if (!operatorMachineSkills[operatorId]) {
                return 'Group D';
            }
            
            const machines = Object.keys(operatorMachineSkills[operatorId]);
            const machineCount = machines.length;
            
            if (machineCount === 0) {
                return 'Group D';
            }
            
            // Get skill levels for each machine
            const machineSkillLevels = machines.map(machine => 
                calculateMachineSkillLevel(operatorId, machine)
            );
            
            // Count machines by skill level
            const levelCounts = {
                'A': machineSkillLevels.filter(level => level === 'A').length,
                'B': machineSkillLevels.filter(level => level === 'B').length,
                'C': machineSkillLevels.filter(level => level === 'C').length,
                'D': machineSkillLevels.filter(level => level === 'D').length
            };
            
            // Apply new multi-skill logic
            if (machineCount >= 3 && levelCounts['A'] >= 1 && 
                (levelCounts['B'] >= 1 || levelCounts['C'] >= 1)) {
                return 'Group A';
            } else if (machineCount >= 2 && levelCounts['B'] >= 1 && 
                      (levelCounts['C'] >= 1 || machineCount === 2)) {
                return 'Group B';
            } else if (machineCount >= 2 && levelCounts['C'] >= 2) {
                return 'Group C';
            } else {
                return 'Group D';
            }
        }

        // Populate operator dropdowns - UPDATED for v13
        function populateOperatorDropdowns() {
            const studyOperatorId = document.getElementById('studyOperatorId');
            const perfOperatorId = document.getElementById('perfOperatorId');
            
            // Clear existing options except the first one
            studyOperatorId.innerHTML = '<option value="">Select Operator</option>';
            perfOperatorId.innerHTML = '<option value="">Select Operator</option>';
            
            operators.forEach(operator => {
                const option1 = document.createElement('option');
                option1.value = operator.operatorId;
                option1.textContent = `${operator.operatorId} - ${operator.name}`;
                studyOperatorId.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = operator.operatorId;
                option2.textContent = `${operator.operatorId} - ${operator.name}`;
                perfOperatorId.appendChild(option2);
            });
            
            // Update operator selection in time study
studyOperatorId.addEventListener('change', function() {
    const operatorId = this.value;
    if (operatorId) {
        const operator = operators.find(op => op.operatorId === operatorId);
        if (operator && operator.sewLine) {
            elements.studyLineNo.value = operator.sewLine;
            // Also trigger auto-fill for the line
            setTimeout(() => {
                autoFillStyleAndProduct(operator.sewLine, 'study');
            }, 100);
        }
    }
});
        }

        // Populate line filter
        function populateLineFilter() {
            const lineFilter = document.getElementById('lineFilter');
            const perfLineFilter = document.getElementById('perfLineFilter');
            const dashboardLineFilter = document.getElementById('dashboardLineFilter');
            
            // Clear and add default option
            lineFilter.innerHTML = '<option value="">Filter by Sew Line...</option>';
            perfLineFilter.innerHTML = '<option value="">Filter by Line...</option>';
            dashboardLineFilter.innerHTML = '<option value="">All Lines</option>';
            
            // Collect unique sew lines
            const sewLines = new Set();
            
            operators.forEach(operator => {
                if (operator.sewLine) {
                    sewLines.add(operator.sewLine);
                }
            });
            
            performanceData.forEach(record => {
                if (record.lineNo) {
                    sewLines.add(record.lineNo);
                }
            });
            
            // Add options
            sewLines.forEach(line => {
                const option1 = document.createElement('option');
                option1.value = line;
                option1.textContent = line;
                lineFilter.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = line;
                option2.textContent = line;
                perfLineFilter.appendChild(option2);
                
                const option3 = document.createElement('option');
                option3.value = line;
                option3.textContent = line;
                dashboardLineFilter.appendChild(option3);
            });
        }

        // Populate dashboard line select
        function populateDashboardLineSelect() {
            const dashboardLineSelect = document.getElementById('dashboardLineSelect');
            
            // Clear existing options
            dashboardLineSelect.innerHTML = '<option value="">All Lines</option>';
            
            // Collect unique lines
            const lines = new Set();
            operators.forEach(operator => {
                if (operator.sewLine) {
                    lines.add(operator.sewLine);
                }
            });
            
            performanceData.forEach(record => {
                if (record.lineNo) {
                    lines.add(record.lineNo);
                }
            });
            
            // Add options sorted
            Array.from(lines).sort().forEach(line => {
                const option = document.createElement('option');
                option.value = line;
                option.textContent = line;
                dashboardLineSelect.appendChild(option);
            });
        }

        // Populate operators line filter
        function populateOperatorsLineFilter() {
            const operatorsLineFilter = document.getElementById('operatorsLineFilter');
            
            // Clear existing options
            operatorsLineFilter.innerHTML = '<option value="">All Lines</option>';
            
            // Collect unique lines
            const lines = new Set();
            operators.forEach(operator => {
                if (operator.sewLine) {
                    lines.add(operator.sewLine);
                }
            });
            
            // Add options sorted
            Array.from(lines).sort().forEach(line => {
                const option = document.createElement('option');
                option.value = line;
                option.textContent = line;
                operatorsLineFilter.appendChild(option);
            });
        }

        // Update machine usage statistics
        function updateMachineUsageStats() {
            const machineUsage = {};
            
            performanceData.forEach(record => {
                let machineName = record.machineName || 'Unknown';
                if (record.machineName === 'Others' && record.customMachineName) {
                    machineName = record.customMachineName;
                }
                
                if (!machineUsage[machineName]) {
                    machineUsage[machineName] = 0;
                }
                machineUsage[machineName]++;
            });
            
            // Sort by count descending
            const sortedMachines = Object.entries(machineUsage)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            if (sortedMachines.length === 0) {
                elements.machineUsageStats.innerHTML = `
                    <div class="machine-usage-item">
                        <span class="machine-name">No data available</span>
                        <span class="machine-count">0</span>
                    </div>
                `;
                return;
            }
            
            let machineHTML = '';
            sortedMachines.forEach(([machine, count]) => {
                machineHTML += `
                    <div class="machine-usage-item">
                        <span class="machine-name">${machine}</span>
                        <span class="machine-count">${count}</span>
                    </div>
                `;
            });
            
            elements.machineUsageStats.innerHTML = machineHTML;
            
            // Update dashboard machine usage
            updateDashboardMachineUsage(sortedMachines);
        }

        // Update dashboard machine usage
        function updateDashboardMachineUsage(sortedMachines) {
            if (sortedMachines.length === 0) {
                elements.dashboardMachineUsage.innerHTML = `
                    <div class="machine-usage-item">
                        <span class="machine-name">No data available</span>
                        <span class="machine-count">0</span>
                    </div>
                `;
                return;
            }
            
            let machineHTML = '';
            sortedMachines.slice(0, 5).forEach(([machine, count]) => {
                machineHTML += `
                    <div class="machine-usage-item">
                        <span class="machine-name">${machine}</span>
                        <span class="machine-count">${count}</span>
                    </div>
                `;
            });
            
            elements.dashboardMachineUsage.innerHTML = machineHTML;
        }

        // Update dashboard v11 - Updated for new layout
        function updateDashboard() {
            updateDashboardStats();
            createDashboardCharts();
            updateRecentActivity();
            updateGarmentSMVSelectors();
        }

        // Update dashboard statistics v11 - Updated for new layout
        function updateDashboardStats() {
            // Total operators
            const selectedLine = document.getElementById('dashboardLineSelect').value;
            let filteredOperators = operators;
            
            if (selectedLine) {
                filteredOperators = filteredOperators.filter(op => op.sewLine === selectedLine);
            }
            
            elements.dashboardTotalOperators.textContent = filteredOperators.length;
            
            // Calculate groups using new multi-skill logic
            let groupACount = 0;
            let groupBCount = 0;
            let groupCCount = 0;
            let groupDCount = 0;
            
            filteredOperators.forEach(operator => {
                const multiSkillGrade = calculateMultiSkillGrade(operator.operatorId);
                
                if (multiSkillGrade === 'Group A') groupACount++;
                else if (multiSkillGrade === 'Group B') groupBCount++;
                else if (multiSkillGrade === 'Group C') groupCCount++;
                else if (multiSkillGrade === 'Group D') groupDCount++;
            });
            
            // Update group cards in the new layout
            elements.dashboardGroupACount.textContent = groupACount;
            elements.dashboardGroupBCount.textContent = groupBCount;
            elements.dashboardGroupCCount.textContent = groupCCount;
            elements.dashboardGroupDCount.textContent = groupDCount;
            
            // Update skill distribution card
            elements.skillGroupACount.textContent = groupACount;
            elements.skillGroupBCount.textContent = groupBCount;
            elements.skillGroupCCount.textContent = groupCCount;
            elements.skillGroupDCount.textContent = groupDCount;
            
            // Performance metrics
            let filteredPerformance = performanceData;
            const dateRange = document.getElementById('dashboardDateRange').value;
            const now = new Date();
            
            if (dateRange !== 'all') {
                filteredPerformance = filteredPerformance.filter(record => {
                    const recordDate = new Date(record.timestamp);
                    switch (dateRange) {
                        case 'today':
                            return recordDate.toDateString() === now.toDateString();
                        case 'week':
                            const weekStart = new Date(now.setDate(now.getDate() - now.getDay()));
                            return recordDate >= weekStart;
                        case 'month':
                            return recordDate.getMonth() === now.getMonth() &&
                                   recordDate.getFullYear() === now.getFullYear();
                        default:
                            return true;
                    }
                });
            }
            
            if (selectedLine) {
                filteredPerformance = filteredPerformance.filter(record => record.lineNo === selectedLine);
            }
            
            const totalOps = filteredPerformance.length;
            if (totalOps === 0) {
                elements.dashboardAvgEfficiency.textContent = '0%';
                elements.dashboardAvgSMV.textContent = '0.00';
                elements.dashboardAvgWorkingSMV.textContent = '0.00';
                elements.dashboardTotalOperations.textContent = '0';
                elements.dashboardActiveLines.textContent = '0';
                return;
            }
            
            const totalEfficiency = filteredPerformance.reduce((sum, record) => sum + (record.efficiency || 0), 0);
            const totalStdSMV = filteredPerformance.reduce((sum, record) => sum + (record.standardSMV || 0), 0);
            const totalWorkingSMV = filteredPerformance.reduce((sum, record) => sum + (record.workingSMV || 0), 0);
            
            elements.dashboardAvgEfficiency.textContent = (totalEfficiency / totalOps).toFixed(1) + '%';
            elements.dashboardAvgSMV.textContent = (totalStdSMV / totalOps).toFixed(2);
            elements.dashboardAvgWorkingSMV.textContent = (totalWorkingSMV / totalOps).toFixed(2);
            elements.dashboardTotalOperations.textContent = totalOps;
            
            // Count active lines
            const activeLines = new Set();
            filteredPerformance.forEach(record => {
                if (record.lineNo) activeLines.add(record.lineNo);
            });
            elements.dashboardActiveLines.textContent = activeLines.size;
        }

        // Create dashboard charts
        function createDashboardCharts() {
            // Destroy existing charts if they exist
            if (efficiencyChart) efficiencyChart.destroy();
            if (linePerformanceChart) linePerformanceChart.destroy();
            if (machinePerformanceChart) machinePerformanceChart.destroy();
            if (weeklyTrendChart) weeklyTrendChart.destroy();
            if (skillDistributionChart) skillDistributionChart.destroy();
            
            // 1. Efficiency Distribution Chart
            const efficiencyCtx = document.getElementById('efficiencyChart').getContext('2d');
            const efficiencyRanges = {
                'Below 70%': 0,
                '70-85%': 0,
                'Above 85%': 0
            };
            
            const selectedLine = document.getElementById('dashboardLineSelect').value;
            let filteredPerformance = performanceData;
            
            if (selectedLine) {
                filteredPerformance = filteredPerformance.filter(record => record.lineNo === selectedLine);
            }
            
            filteredPerformance.forEach(record => {
                const efficiency = record.efficiency || 0;
                if (efficiency < 70) efficiencyRanges['Below 70%']++;
                else if (efficiency < 85) efficiencyRanges['70-85%']++;
                else efficiencyRanges['Above 85%']++;
            });
            
            efficiencyChart = new Chart(efficiencyCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(efficiencyRanges),
                    datasets: [{
                        data: Object.values(efficiencyRanges),
                        backgroundColor: [
                            'rgba(248, 150, 30, 0.8)',
                            'rgba(67, 97, 238, 0.8)',
                            'rgba(76, 201, 240, 0.8)'
                        ],
                        borderColor: [
                            'rgba(248, 150, 30, 1)',
                            'rgba(67, 97, 238, 1)',
                            'rgba(76, 201, 240, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: 'white',
                                padding: 20
                            }
                        }
                    }
                }
            });
            
            // 2. Line Performance Chart
            const lineCtx = document.getElementById('linePerformanceChart').getContext('2d');
            const linePerformance = {};
            
            performanceData.forEach(record => {
                if (record.lineNo && record.efficiency) {
                    if (!linePerformance[record.lineNo]) {
                        linePerformance[record.lineNo] = { total: 0, count: 0 };
                    }
                    linePerformance[record.lineNo].total += record.efficiency || 0;
                    linePerformance[record.lineNo].count++;
                }
            });
            
            const linesArray = Object.entries(linePerformance).map(([line, data]) => ({
                line,
                avgEfficiency: data.total / data.count
            }));
            
            linesArray.sort((a, b) => b.avgEfficiency - a.avgEfficiency);
            const topLines = linesArray.slice(0, 8);
            
            linePerformanceChart = new Chart(lineCtx, {
                type: 'bar',
                data: {
                    labels: topLines.map(l => l.line),
                    datasets: [{
                        label: 'Average Efficiency %',
                        data: topLines.map(l => l.avgEfficiency),
                        backgroundColor: topLines.map(l => {
                            if (l.avgEfficiency >= 85) return 'rgba(76, 201, 240, 0.8)';
                            if (l.avgEfficiency >= 70) return 'rgba(67, 97, 238, 0.8)';
                            return 'rgba(248, 150, 30, 0.8)';
                        }),
                        borderColor: topLines.map(l => {
                            if (l.avgEfficiency >= 85) return 'rgba(76, 201, 240, 1)';
                            if (l.avgEfficiency >= 70) return 'rgba(67, 97, 238, 1)';
                            return 'rgba(248, 150, 30, 1)';
                        }),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                color: 'white'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: 'white'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: 'white'
                            }
                        }
                    }
                }
            });
            
            // 3. Machine Performance Chart
            const machineCtx = document.getElementById('machinePerformanceChart').getContext('2d');
            const machinePerformance = {};
            
            performanceData.forEach(record => {
                let machineName = record.machineName;
                if (record.machineName === 'Others' && record.customMachineName) {
                    machineName = record.customMachineName;
                }
                
                if (machineName && record.efficiency) {
                    if (!machinePerformance[machineName]) {
                        machinePerformance[machineName] = { total: 0, count: 0 };
                    }
                    machinePerformance[machineName].total += record.efficiency;
                    machinePerformance[machineName].count++;
                }
            });
            
            const machinesArray = Object.entries(machinePerformance).map(([name, data]) => ({
                name,
                avgEfficiency: data.total / data.count
            }));
            
            machinesArray.sort((a, b) => b.avgEfficiency - a.avgEfficiency);
            const topMachines = machinesArray.slice(0, 8);
            
            machinePerformanceChart = new Chart(machineCtx, {
                type: 'bar',
                data: {
                    labels: topMachines.map(m => m.name),
                    datasets: [{
                        label: 'Average Efficiency %',
                        data: topMachines.map(m => m.avgEfficiency),
                        backgroundColor: 'rgba(248, 37, 133, 0.8)',
                        borderColor: 'rgba(248, 37, 133, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                color: 'white'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            ticks: {
                                color: 'white'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: 'white'
                            }
                        }
                    }
                }
            });
            
            // 4. Weekly Trend Chart
            const weeklyCtx = document.getElementById('weeklyTrendChart').getContext('2d');
            const weeklyData = getWeeklyTrendData();
            
            weeklyTrendChart = new Chart(weeklyCtx, {
                type: 'line',
                data: {
                    labels: weeklyData.labels,
                    datasets: [{
                        label: 'Average Efficiency',
                        data: weeklyData.values,
                        borderColor: 'rgba(67, 97, 238, 1)',
                        backgroundColor: 'rgba(67, 97, 238, 0.1)',
                        tension: 0.3,
                        fill: true,
                        pointBackgroundColor: 'rgba(67, 97, 238, 1)',
                        pointBorderColor: '#fff',
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 50,
                            max: 100,
                            ticks: {
                                color: 'white'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: 'white'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: 'white'
                            }
                        }
                    }
                }
            });
            
            // 5. Skill Distribution Chart
            const skillCtx = document.getElementById('skillDistributionChart').getContext('2d');
            const skillDistribution = {
                'Group A': 0,
                'Group B': 0,
                'Group C': 0,
                'Group D': 0
            };
            
            operators.forEach(operator => {
                const multiSkillGrade = calculateMultiSkillGrade(operator.operatorId);
                skillDistribution[multiSkillGrade]++;
            });
            
            skillDistributionChart = new Chart(skillCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(skillDistribution),
                    datasets: [{
                        data: Object.values(skillDistribution),
                        backgroundColor: [
                            'rgba(76, 201, 240, 0.8)',
                            'rgba(67, 97, 238, 0.8)',
                            'rgba(248, 150, 30, 0.8)',
                            'rgba(183, 23, 158, 0.8)'
                        ],
                        borderColor: [
                            'rgba(76, 201, 240, 1)',
                            'rgba(67, 97, 238, 1)',
                            'rgba(248, 150, 30, 1)',
                            'rgba(183, 23, 158, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: 'white',
                                padding: 15,
                                font: {
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });
        }

        // Update recent activity
        function updateRecentActivity() {
            const recentRecords = performanceData.slice(0, 10);
            let activityHTML = '';
            
            if (recentRecords.length === 0) {
                activityHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 20px; color: var(--text-secondary);">
                            No recent activity
                        </td>
                    </tr>
                `;
            } else {
                recentRecords.forEach(record => {
                    const timeAgo = getTimeAgo(record.timestamp);
                    const efficiencyClass = record.efficiency >= 85 ? 'efficiency-high' :
                                          record.efficiency >= 70 ? 'efficiency-medium' : 'efficiency-low';
                    
                    activityHTML += `
                        <tr>
                            <td style="padding: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                                ${timeAgo}
                            </td>
                            <td style="padding: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                                ${record.operatorName || record.operatorId}
                            </td>
                            <td style="padding: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                                ${record.operation}
                            </td>
                            <td style="padding: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);" class="${efficiencyClass}">
                                ${record.efficiency ? record.efficiency.toFixed(1) + '%' : '-'}
                            </td>
                            <td style="padding: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                                <button class="btn-icon view-performance" data-id="${record.operatorId}" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
            }
            
            elements.recentActivity.innerHTML = activityHTML;
            
            // Add event listeners for view buttons
            document.querySelectorAll('#recentActivity .view-performance').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const operatorId = e.target.closest('button').getAttribute('data-id');
                    viewOperatorPerformance(operatorId);
                });
            });
        }

        // Helper: Get time ago string
        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - new Date(date);
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            return `${diffDays}d ago`;
        }

        // Get weekly trend data
        function getWeeklyTrendData() {
            const last7Days = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                last7Days.push(date.toISOString().split('T')[0]);
            }
            
            const dailyAverages = {};
            last7Days.forEach(day => {
                dailyAverages[day] = { total: 0, count: 0 };
            });
            
            performanceData.forEach(record => {
                if (record.timestamp) {
                    const recordDate = record.timestamp.toISOString().split('T')[0];
                    if (dailyAverages[recordDate]) {
                        dailyAverages[recordDate].total += record.efficiency || 0;
                        dailyAverages[recordDate].count++;
                    }
                }
            });
            
            const labels = last7Days.map(date => {
                const d = new Date(date);
                return d.toLocaleDateString('en-US', { weekday: 'short' });
            });
            
            const values = last7Days.map(date => {
                const data = dailyAverages[date];
                return data.count > 0 ? (data.total / data.count) : 0;
            });
            
            return { labels, values };
        }

        // Render operators table with new multi-skill logic - FIXED: Current Sew Line column alignment
        function renderOperatorsTable(filteredData = operators) {
            elements.operatorsBody.innerHTML = '';
            
            if (filteredData.length === 0) {
                elements.operatorsBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 50px;">
                            <i class="fas fa-users" style="font-size: 3rem; color: var(--text-secondary); margin-bottom: 15px; display: block;"></i>
                            <h3 style="color: var(--text-secondary); margin-bottom: 10px;">No Operators Found</h3>
                            <p style="color: var(--text-secondary);">Add your first operator to get started</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Show all operators with scroll
            filteredData.forEach(operator => {
                // Calculate multi-skill grade using new logic
                const multiSkillGrade = calculateMultiSkillGrade(operator.operatorId);
                const skillClass = `skill-group-${multiSkillGrade.charAt(multiSkillGrade.length - 1).toLowerCase()}`;
                
                // Calculate skill score based on overall efficiency
                const skillScore = calculateSkillScore(operator.operatorId);
                const skillScoreClass = getSkillScoreClass(skillScore);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="operator-id">${operator.operatorId || ''}</td>
                    <td>${operator.name || ''}</td>
                    <td style="text-align: center;">${operator.sewLine || '-'}</td>
                    <td>
                        ${multiSkillGrade ?
                            `<span class="skill-level ${skillClass}">${multiSkillGrade}</span>` :
                            '-'
                        }
                    </td>
                    <td>
                        <span class="skill-score ${skillScoreClass}">
                            ${skillScore > 0 ? skillScore.toFixed(2) : '0.00'}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons-small">
                            <button class="btn-icon edit-operator" data-id="${operator.operatorId}" title="Edit Operator">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-icon delete-operator" data-id="${operator.operatorId}" title="Delete Operator">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button class="btn-icon view-performance" data-id="${operator.operatorId}" title="View Performance Records">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn-icon btn-icon-timer time-study-operator" data-id="${operator.operatorId}" title="Start Time Study for this Operator">
                                <i class="fas fa-stopwatch"></i>
                            </button>
                        </div>
                    </td>
                `;
                elements.operatorsBody.appendChild(row);
            });
            
            // Add event listeners for action buttons
            document.querySelectorAll('.edit-operator').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const operatorId = e.target.closest('button').getAttribute('data-id');
                    openEditModal(operatorId);
                });
            });
            
            document.querySelectorAll('.delete-operator').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const operatorId = e.target.closest('button').getAttribute('data-id');
                    deleteOperator(operatorId);
                });
            });
            
            document.querySelectorAll('.view-performance').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const operatorId = e.target.closest('button').getAttribute('data-id');
                    viewOperatorPerformance(operatorId);
                });
            });
            
            document.querySelectorAll('.time-study-operator').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const operatorId = e.target.closest('button').getAttribute('data-id');
                    startTimeStudyForOperator(operatorId);
                });
            });
        }

        // Show group operators modal v11 - Updated for new layout
        function showGroupOperators(group, source = 'dashboard') {
            let filteredOperators = operators.filter(operator => {
                const multiSkillGrade = calculateMultiSkillGrade(operator.operatorId);
                return multiSkillGrade === group;
            });
            
            // Apply line filter if selected
            const lineFilterId = source === 'dashboard' ? 'dashboardLineSelect' : 'operatorsLineFilter';
            const selectedLine = document.getElementById(lineFilterId).value;
            
            if (selectedLine) {
                filteredOperators = filteredOperators.filter(op => op.sewLine === selectedLine);
            }
            
            if (filteredOperators.length === 0) {
                showToast(`No operators found in ${group}${selectedLine ? ` for line ${selectedLine}` : ''}`, 'error');
                return;
            }
            
            // Calculate average efficiency for the group
            let totalEfficiency = 0;
            let efficiencyCount = 0;
            
            filteredOperators.forEach(operator => {
                const operatorEfficiency = getOperatorAverageEfficiency(operator.operatorId);
                if (operatorEfficiency > 0) {
                    totalEfficiency += operatorEfficiency;
                    efficiencyCount++;
                }
            });
            
            const avgEfficiency = efficiencyCount > 0 ? (totalEfficiency / efficiencyCount) : 0;
            
            // Update modal title and info
            elements.groupModalTitle.textContent = `${group} Operators${selectedLine ? ` - Line ${selectedLine}` : ''}`;
            elements.groupOperatorCount.textContent = filteredOperators.length;
            elements.groupAvgEfficiency.textContent = avgEfficiency.toFixed(1) + '%';
            
            // Set group description
            let description = '';
            if (group === 'Group A') {
                description = 'Grade A: 3+ machine types, with at least 1 machine at A grade, others at B or C';
            } else if (group === 'Group B') {
                description = 'Grade B: 2+ machine types, with at least 1 machine at B grade, the other at C';
            } else if (group === 'Group C') {
                description = 'Grade C: 2 machine types, both at C grade';
            } else {
                description = 'Grade D: Only manual operations, but can handle 1 machine at D grade';
            }
            elements.groupDescription.textContent = description;
            
            // Render group operators
            renderGroupOperatorsList(filteredOperators, 'skillScore');
            
            // Show modal
            document.getElementById('groupOperatorsModal').classList.add('active');
        }

        // Render group operators list with sorting
        function renderGroupOperatorsList(operatorsList, sortBy = 'skillScore') {
            // Sort operators
            let sortedOperators = [...operatorsList];
            
            switch (sortBy) {
                case 'skillScore':
                    sortedOperators.sort((a, b) => {
                        const scoreA = calculateSkillScore(a.operatorId);
                        const scoreB = calculateSkillScore(b.operatorId);
                        return scoreB - scoreA;
                    });
                    break;
                case 'efficiency':
                    sortedOperators.sort((a, b) => {
                        const effA = getOperatorAverageEfficiency(a.operatorId);
                        const effB = getOperatorAverageEfficiency(b.operatorId);
                        return effB - effA;
                    });
                    break;
                case 'name':
                    sortedOperators.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                case 'line':
                    sortedOperators.sort((a, b) => (a.sewLine || '').localeCompare(b.sewLine || ''));
                    break;
            }
            
            // Apply search filter
            const searchTerm = document.getElementById('groupSearchInput').value.toLowerCase();
            if (searchTerm) {
                sortedOperators = sortedOperators.filter(operator =>
                    (operator.operatorId && operator.operatorId.toLowerCase().includes(searchTerm)) ||
                    (operator.name && operator.name.toLowerCase().includes(searchTerm)) ||
                    (operator.sewLine && operator.sewLine.toLowerCase().includes(searchTerm))
                );
            }
            
            // Populate operators list
            elements.groupOperatorsList.innerHTML = '';
            
            if (sortedOperators.length === 0) {
                elements.groupOperatorsList.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: var(--text-secondary);">
                        <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                        <p>No operators found matching your criteria</p>
                    </div>
                `;
                return;
            }
            
            sortedOperators.forEach(operator => {
                const operatorEfficiency = getOperatorAverageEfficiency(operator.operatorId);
                const efficiencyClass = operatorEfficiency >= 85 ? 'high' :
                                     operatorEfficiency >= 70 ? 'medium' : 'low';
                const skillScore = calculateSkillScore(operator.operatorId);
                
                const operatorItem = document.createElement('div');
                operatorItem.className = 'group-operator-item';
                operatorItem.innerHTML = `
                    <div class="group-operator-info">
                        <div class="group-operator-id">${operator.operatorId}</div>
                        <div class="group-operator-name">${operator.name}</div>
                        <div class="group-operator-line">${operator.sewLine || 'No line assigned'}</div>
                    </div>
                    <div class="group-operator-stats">
                        <div class="group-operator-efficiency ${efficiencyClass}">
                            ${operatorEfficiency.toFixed(1)}%
                        </div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">
                            Score: ${skillScore.toFixed(2)}
                        </div>
                        <button class="btn-icon time-study-operator" data-id="${operator.operatorId}" title="Start Time Study">
                            <i class="fas fa-stopwatch"></i>
                        </button>
                    </div>
                `;
                elements.groupOperatorsList.appendChild(operatorItem);
            });
            
            // Add event listeners for time study buttons
            document.querySelectorAll('#groupOperatorsList .time-study-operator').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const operatorId = e.target.closest('button').getAttribute('data-id');
                    closeModal('groupOperatorsModal');
                    startTimeStudyForOperator(operatorId);
                });
            });
        }

        // Get operator average efficiency
        function getOperatorAverageEfficiency(operatorId) {
            const operatorRecords = performanceData.filter(record => record.operatorId === operatorId);
            if (operatorRecords.length === 0) return 0;
            
            const totalEfficiency = operatorRecords.reduce((sum, record) => sum + (record.efficiency || 0), 0);
            return totalEfficiency / operatorRecords.length;
        }

        // Start time study for specific operator - FIXED for v13
        function startTimeStudyForOperator(operatorId) {
            const operator = operators.find(op => op.operatorId === operatorId);
            if (!operator) {
                showToast('Operator not found!', 'error');
                return;
            }
            
            // Switch to time study tab
            document.querySelector('.nav-item[data-tab="time-study"]').click();
            
            // Set the operator in the dropdown
            document.getElementById('studyOperatorId').value = operatorId;
            
            // Set the line number if operator has a sew line - FIXED: Now properly sets the line number
            if (operator.sewLine) {
                elements.studyLineNo.value = operator.sewLine;
            }
            
            // Focus on operation name field
            document.getElementById('studyOperation').focus();
            
            showToast(`Time study ready for ${operator.name}. Enter line number and operation details to begin.`, 'success');
        }

        // Calculate skill score based on overall efficiency
        function calculateSkillScore(operatorId) {
            const operatorPerformances = performanceData.filter(p => p.operatorId === operatorId);
            if (operatorPerformances.length === 0) return 0;
            
            let totalEfficiency = 0;
            let count = 0;
            
            operatorPerformances.forEach(perf => {
                if (perf.efficiency) {
                    totalEfficiency += perf.efficiency;
                    count++;
                }
            });
            
            const avgEfficiency = count > 0 ? totalEfficiency / count : 0;
            
            // Convert efficiency to skill score (0.0 - 1.0)
            if (avgEfficiency >= 90) return 0.9 + (avgEfficiency - 90) * 0.01;
            else if (avgEfficiency >= 80) return 0.7 + (avgEfficiency - 80) * 0.02;
            else if (avgEfficiency >= 70) return 0.4 + (avgEfficiency - 70) * 0.03;
            else if (avgEfficiency >= 60) return 0.2 + (avgEfficiency - 60) * 0.02;
            else return avgEfficiency * 0.0033;
        }

        // Get skill score class based on value
        function getSkillScoreClass(score) {
            if (score >= 0.67) return 'group-a';
            else if (score >= 0.34) return 'group-b';
            else if (score >= 0.1) return 'group-c';
            else return 'group-d';
        }

        // Update statistics with new multi-skill logic
        function updateStats() {
            const selectedLine = document.getElementById('operatorsLineFilter').value;
            let filteredOperators = operators;
            
            if (selectedLine) {
                filteredOperators = filteredOperators.filter(op => op.sewLine === selectedLine);
            }
            
            const totalOps = filteredOperators.length;
            
            // Count operators by group using new multi-skill logic
            let groupACount = 0;
            let groupBCount = 0;
            let groupCCount = 0;
            let groupDCount = 0;
            
            filteredOperators.forEach(operator => {
                const multiSkillGrade = calculateMultiSkillGrade(operator.operatorId);
                
                if (multiSkillGrade === 'Group A') groupACount++;
                else if (multiSkillGrade === 'Group B') groupBCount++;
                else if (multiSkillGrade === 'Group C') groupCCount++;
                else if (multiSkillGrade === 'Group D') groupDCount++;
            });
            
            elements.totalOperators.textContent = totalOps;
            elements.groupACount.textContent = groupACount;
            elements.groupBCount.textContent = groupBCount;
            elements.groupCCount.textContent = groupCCount;
            elements.groupDCount.textContent = groupDCount;
        }

        // Update summary stats
        function updateSummaryStats() {
            // Performance summary
            const totalRecords = performanceData.length;
            const totalEfficiency = performanceData.reduce((sum, record) => sum + (record.efficiency || 0), 0);
            const avgEfficiency = totalRecords > 0 ? (totalEfficiency / totalRecords) : 0;
            
            elements.performanceRecords.textContent = totalRecords;
            elements.performanceAvgEfficiency.textContent = avgEfficiency.toFixed(1) + '%';
            elements.performanceTotalOps.textContent = performanceData.length;
            
            // Time study summary (today)
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const timeStudiesToday = performanceData.filter(record => {
                const recordDate = new Date(record.timestamp);
                return recordDate >= today && record.cycleTimes && record.cycleTimes.length > 0;
            });
            
            let totalCycleTime = 0;
            let completedStudies = 0;
            
            timeStudiesToday.forEach(study => {
                if (study.cycleTimes && study.cycleTimes.length > 0) {
                    completedStudies++;
                    const avg = study.cycleTimes.reduce((a, b) => a + b, 0) / study.cycleTimes.length;
                    totalCycleTime += avg;
                }
            });
            
            elements.timeStudies.textContent = timeStudiesToday.length;
            elements.timeStudyCompleted.textContent = completedStudies;
            elements.timeStudyAvgCycle.textContent = completedStudies > 0 ? (totalCycleTime / completedStudies).toFixed(1) + 's' : '0s';
        }

        // Update performance statistics
        function updatePerformanceStats() {
            const totalOps = performanceData.length;
            if (totalOps === 0) {
                elements.avgEfficiency.textContent = '0%';
                elements.avgSMV.textContent = '0.00';
                elements.avgWorkingSMV.textContent = '0.00';
                elements.totalOperations.textContent = '0';
                return;
            }
            
            const totalEfficiency = performanceData.reduce((sum, record) => sum + (record.efficiency || 0), 0);
            const totalStdSMV = performanceData.reduce((sum, record) => sum + (record.standardSMV || 0), 0);
            const totalWorkingSMV = performanceData.reduce((sum, record) => sum + (record.workingSMV || 0), 0);
            
            elements.avgEfficiency.textContent = (totalEfficiency / totalOps).toFixed(1) + '%';
            elements.avgSMV.textContent = (totalStdSMV / totalOps).toFixed(2);
            elements.avgWorkingSMV.textContent = (totalWorkingSMV / totalOps).toFixed(2);
            elements.totalOperations.textContent = totalOps;
        }

        // Render performance table with edit button
        function renderPerformanceTable(filteredData = performanceData) {
            elements.performanceBody.innerHTML = '';
            
            if (filteredData.length === 0) {
                elements.performanceBody.innerHTML = `
                    <tr>
                        <td colspan="13" style="text-align: center; padding: 50px;">
                            <i class="fas fa-chart-line" style="font-size: 3rem; color: var(--text-secondary); margin-bottom: 15px; display: block;"></i>
                            <h3 style="color: var(--text-secondary); margin-bottom: 10px;">No Performance Data Found</h3>
                            <p style="color: var(--text-secondary);">Add your first performance record to get started</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Show all performance records with scroll
            filteredData.forEach(record => {
                const formattedDate = record.timestamp ? record.timestamp.toLocaleString() : 'N/A';
                const efficiency = record.efficiency || 0;
                const efficiencyClass = efficiency >= 85 ? 'efficiency-high' :
                                      efficiency >= 70 ? 'efficiency-medium' : 'efficiency-low';
                
                // Get machine name
                let machineName = record.machineName || '-';
                if (record.machineName === 'Others' && record.customMachineName) {
                    machineName = record.customMachineName;
                }
                
                // Get other machines
                const otherMachines = record.otherMachines || '-';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formattedDate}</td>
                    <td>${record.lineNo || '-'}</td>
                    <td>${record.styleNo || '-'}</td>
                    <td>${record.productDesc || '-'}</td>
                    <td>${record.operatorId || '-'}</td>
                    <td>${record.operatorName || '-'}</td>
                    <td>${record.operation || '-'}</td>
                    <td>${machineName}</td>
                    <td>${otherMachines}</td>
                    <td>${record.standardSMV ? record.standardSMV.toFixed(2) : '-'}</td>
                    <td class="working-smv-cell">
                        <button class="working-smv-btn" data-id="${record.id}">
                            ${record.workingSMV ? record.workingSMV.toFixed(2) : '0.00'}
                        </button>
                    </td>
                    <td class="${efficiencyClass}">${efficiency ? efficiency.toFixed(1) + '%' : '-'}</td>
                    <td>
                        <div class="action-buttons-small">
                            <button class="btn-icon delete-perf-btn" data-id="${record.id}" title="Delete Record">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button class="btn-icon edit-perf-btn" data-id="${record.id}" title="Edit Record">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </td>
                `;
                elements.performanceBody.appendChild(row);
            });
            
            // Add event listeners
            document.querySelectorAll('.working-smv-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const recordId = e.target.closest('button').getAttribute('data-id');
                    showCycleTimesDetail(recordId);
                });
            });
            
            document.querySelectorAll('.delete-perf-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const id = e.target.closest('button').getAttribute('data-id');
                    if (confirm('Are you sure you want to delete this performance record?')) {
                        await deletePerformanceRecord(id);
                    }
                });
            });
            
            document.querySelectorAll('.edit-perf-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const recordId = e.target.closest('button').getAttribute('data-id');
                    openEditPerformanceModal(recordId);
                });
            });
        }

        // Open edit performance modal
        function openEditPerformanceModal(recordId) {
            const record = performanceData.find(r => r.id === recordId);
            if (!record) return;
            
            document.getElementById('editRecordId').textContent = recordId;
            document.getElementById('editRecordOperator').textContent = `${record.operatorName} (${record.operatorId})`;
            document.getElementById('editRecordStdSMV').value = record.standardSMV || 0;
            document.getElementById('editRecordWorkingSMV').value = record.workingSMV || 0;
            document.getElementById('editRecordCycleTimes').value = record.cycleTimes ? record.cycleTimes.join(', ') : '';
            
            document.getElementById('editPerformanceModal').classList.add('active');
        }

        // Open edit modal
        function openEditModal(operatorId) {
            const operator = operators.find(op => op.operatorId === operatorId);
            if (!operator) {
                showToast('Operator not found!', 'error');
                return;
            }
            
            selectedOperatorId = operatorId;
            document.getElementById('editOperatorId').textContent = operatorId;
            document.getElementById('editOperatorName').textContent = operator.name || '';
            document.getElementById('editSewLine').value = operator.sewLine || '';
            
            // Calculate multi-skill grade
            const multiSkillGrade = calculateMultiSkillGrade(operatorId);
            document.getElementById('editSkillLevel').value = multiSkillGrade;
            
            // Calculate and set skill score
            const skillScore = calculateSkillScore(operatorId);
            document.getElementById('editSkillScore').value = skillScore.toFixed(2);
            document.getElementById('scoreSlider').value = Math.round(skillScore * 100);
            
            document.getElementById('editCellModal').classList.add('active');
        }

        // View operator performance records
        function viewOperatorPerformance(operatorId) {
            const operator = operators.find(op => op.operatorId === operatorId);
            if (!operator) {
                showToast('Operator not found!', 'error');
                return;
            }
            
            const operatorRecords = performanceData.filter(record => record.operatorId === operatorId);
            
            if (operatorRecords.length === 0) {
                showToast(`No performance records found for operator ${operator.name}. Create one in the time study tab.`, 'error');
                return;
            }
            
            // Switch to performance tab
            document.querySelector('.nav-item[data-tab="performance"]').click();
            
            // Filter by operator
            document.getElementById('searchPerformance').value = operatorId;
            filterPerformanceData();
            
            // Highlight the records
            setTimeout(() => {
                const rows = document.querySelectorAll('#performanceBody tr');
                rows.forEach((row, index) => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length > 4 && cells[4].textContent === operatorId) {
                        row.classList.add('highlight-row');
                        
                        // Remove highlight after 3 seconds
                        setTimeout(() => {
                            row.classList.remove('highlight-row');
                        }, 3000);
                    }
                });
                
                showToast(`Showing ${operatorRecords.length} performance records for ${operator.name}`, 'success');
            }, 500);
        }

        // Filter operators
        function filterOperators() {
            let filtered = operators;
            const searchTerm = elements.searchInput.value.toLowerCase();
            const selectedLine = document.getElementById('operatorsLineFilter').value;
            
            if (searchTerm) {
                filtered = filtered.filter(operator =>
                    (operator.operatorId && operator.operatorId.toLowerCase().includes(searchTerm)) ||
                    (operator.name && operator.name.toLowerCase().includes(searchTerm)) ||
                    (operator.sewLine && operator.sewLine.toLowerCase().includes(searchTerm))
                );
            }
            
            const skillLevel = elements.skillFilter.value;
            if (skillLevel) {
                filtered = filtered.filter(operator => {
                    const multiSkillGrade = calculateMultiSkillGrade(operator.operatorId);
                    return multiSkillGrade === skillLevel;
                });
            }
            
            const sewLine = elements.lineFilter.value;
            if (sewLine) {
                filtered = filtered.filter(operator =>
                    operator.sewLine && operator.sewLine.toLowerCase().includes(sewLine.toLowerCase())
                );
            }
            
            if (selectedLine) {
                filtered = filtered.filter(operator => operator.sewLine === selectedLine);
            }
            
            renderOperatorsTable(filtered);
        }

        // Filter performance data
        function filterPerformanceData() {
            const searchTerm = document.getElementById('searchPerformance').value.toLowerCase();
            const lineFilter = document.getElementById('perfLineFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;
            
            let filtered = performanceData;
            
            if (searchTerm) {
                filtered = filtered.filter(record =>
                    (record.operatorId && record.operatorId.toLowerCase().includes(searchTerm)) ||
                    (record.operatorName && record.operatorName.toLowerCase().includes(searchTerm)) ||
                    (record.styleNo && record.styleNo.toLowerCase().includes(searchTerm)) ||
                    (record.productDesc && record.productDesc.toLowerCase().includes(searchTerm))
                );
            }
            
            if (lineFilter) {
                filtered = filtered.filter(record => record.lineNo === lineFilter);
            }
            
            if (dateFilter) {
                const now = new Date();
                filtered = filtered.filter(record => {
                    const recordDate = new Date(record.timestamp);
                    switch (dateFilter) {
                        case 'today':
                            return recordDate.toDateString() === now.toDateString();
                        case 'week':
                            const weekStart = new Date(now.setDate(now.getDate() - now.getDay()));
                            return recordDate >= weekStart;
                        case 'month':
                            return recordDate.getMonth() === now.getMonth() &&
                                   recordDate.getFullYear() === now.getFullYear();
                        default:
                            return true;
                    }
                });
            }
            
            renderPerformanceTable(filtered);
        }

        // Save operator with skill score
        async function saveOperator(operatorData, isEdit = false) {
            try {
                let result;
                
                if (isEdit) {
                    // Find the operator document
                    const operator = operators.find(op => op.operatorId === selectedOperatorId);
                    if (!operator) {
                        throw new Error('Operator not found');
                    }
                    
                    const operatorRef = doc(db, 'operators', operator.id);
                    
                    // Calculate skill score from performance
                    const skillScore = calculateSkillScore(selectedOperatorId);
                    
                    result = await updateDoc(operatorRef, {
                        sewLine: operatorData.sewLine,
                        skillLevel: operatorData.skillLevel,
                        skillScore: skillScore,
                        lastUpdated: serverTimestamp()
                    });
                    
                    showToast('Operator updated successfully!');
                } else {
                    // Check if operator ID already exists
                    const existingOperator = operators.find(op => op.operatorId === operatorData.operatorId);
                    if (existingOperator) {
                        throw new Error('Operator ID already exists!');
                    }
                    
                    const docRef = doc(collection(db, 'operators'));
                    result = await setDoc(docRef, {
                        operatorId: operatorData.operatorId,
                        name: operatorData.name,
                        sewLine: operatorData.sewLine || null,
                        skillLevel: operatorData.skillLevel || null,
                        skillScore: 0,
                        createdAt: serverTimestamp(),
                        lastUpdated: serverTimestamp()
                    });
                    
                    showToast('Operator added successfully!');
                }
                
                return true;
            } catch (error) {
                console.error('Error saving operator:', error);
                showToast('Error: ' + error.message, 'error');
                return false;
            }
        }

        // Delete operator
        async function deleteOperator(operatorId) {
            if (!confirm(`Are you sure you want to delete operator ${operatorId}?`)) {
                return;
            }
            
            try {
                const operator = operators.find(op => op.operatorId === operatorId);
                if (!operator) {
                    throw new Error('Operator not found');
                }
                
                await deleteDoc(doc(db, 'operators', operator.id));
                showToast('Operator deleted successfully!');
            } catch (error) {
                console.error('Error deleting operator:', error);
                showToast('Error deleting operator: ' + error.message, 'error');
            }
        }

        // Import Excel data
        async function importExcelData(file, type) {
            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data);
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                
                let importedCount = 0;
                let errorCount = 0;
                
                if (type === 'operators') {
                    for (const row of jsonData) {
                        try {
                            // Try multiple possible column names
                            const operatorId = row['Operator ID'] || row['operatorId'] || row['ID'] || row['OperatorId'] || '';
                            const name = row['Operator Name'] || row['Name'] || row['operatorName'] || row['OperatorName'] || '';
                            const sewLine = row['Current Sew Line'] || row['Sew Line'] || row['sewLine'] || row['Line'] || null;
                            const skillLevel = row['Skill Level'] || row['skillLevel'] || row['Level'] || null;
                            const skillScore = parseFloat(row['Average Skill Score'] || row['skillScore'] || row['Score'] || 0);
                            
                            if (operatorId && name) {
                                // Check if operator already exists
                                const existingOperator = operators.find(op => op.operatorId === operatorId);
                                
                                if (existingOperator) {
                                    // Update existing operator
                                    const operatorRef = doc(db, 'operators', existingOperator.id);
                                    await updateDoc(operatorRef, {
                                        name: name,
                                        sewLine: sewLine,
                                        skillLevel: skillLevel,
                                        skillScore: skillScore,
                                        lastUpdated: serverTimestamp()
                                    });
                                    importedCount++;
                                } else {
                                    // Add new operator
                                    const docRef = doc(collection(db, 'operators'));
                                    await setDoc(docRef, {
                                        operatorId: operatorId,
                                        name: name,
                                        sewLine: sewLine,
                                        skillLevel: skillLevel,
                                        skillScore: skillScore,
                                        createdAt: serverTimestamp(),
                                        lastUpdated: serverTimestamp()
                                    });
                                    importedCount++;
                                }
                            } else {
                                console.warn('Skipping row missing operatorId or name:', row);
                                errorCount++;
                            }
                        } catch (error) {
                            console.error('Error importing row:', row, error);
                            errorCount++;
                        }
                    }
                    // Refresh operators list
                    await loadData();
                } else if (type === 'performance') {
                    for (const row of jsonData) {
                        try {
                            // Try multiple possible column names
                            const performanceData = {
                                timestamp: serverTimestamp(),
                                lineNo: row['Line No'] || row['Line'] || row['lineNo'] || row['LineNo'] || '',
                                styleNo: row['Style No'] || row['Style'] || row['styleNo'] || row['StyleNo'] || '',
                                productDesc: row['Product Description'] || row['Product'] || row['productDesc'] || row['Description'] || '',
                                operatorId: row['Operator ID'] || row['Operator'] || row['operatorId'] || row['OperatorId'] || '',
                                operatorName: row['Operator Name'] || row['Name'] || row['operatorName'] || row['OperatorName'] || '',
                                operation: row['Operation'] || row['operation'] || '',
                                machineName: row['Machine Name'] || row['Machine'] || row['machineName'] || row['MachineName'] || '',
                                standardSMV: parseFloat(row['Standard SMV'] || row['Std SMV'] || row['standardSMV'] || row['Standard'] || 0),
                                workingSMV: parseFloat(row['Working SMV'] || row['Working'] || row['workingSMV'] || row['Work SMV'] || 0),
                                efficiency: parseFloat(row['Efficiency'] || row['efficiency'] || 0),
                                otherMachines: row['Other Machines'] || row['Other'] || row['otherMachines'] || '',
                                allowance: 13 // Default for imported data
                            };
                            
                            if (performanceData.operatorId && performanceData.lineNo) {
                                const docRef = doc(collection(db, 'performance'));
                                await setDoc(docRef, performanceData);
                                importedCount++;
                            } else {
                                console.warn('Skipping row missing operatorId or lineNo:', row);
                                errorCount++;
                            }
                        } catch (error) {
                            console.error('Error importing row:', row, error);
                            errorCount++;
                        }
                    }
                }
                
                showToast(`Imported ${importedCount} records successfully${errorCount > 0 ? `, ${errorCount} errors` : ''}!`);
                return true;
            } catch (error) {
                console.error('Error importing Excel:', error);
                showToast('Error importing Excel: ' + error.message, 'error');
                return false;
            }
        }

        // Export to Excel
        function exportToExcel(type = 'operators') {
            try {
                let data = [];
                let filename = '';
                
                if (type === 'operators') {
                    operators.forEach(operator => {
                        const skillScore = operator.skillScore || calculateSkillScore(operator.operatorId);
                        const multiSkillGrade = calculateMultiSkillGrade(operator.operatorId);
                        
                        data.push({
                            'Operator ID': operator.operatorId,
                            'Operator Name': operator.name,
                            'Current Sew Line': operator.sewLine || '',
                            'Skill Level': multiSkillGrade,
                            'Average Skill Score': skillScore > 0 ? skillScore.toFixed(2) : ''
                        });
                    });
                    
                    filename = `Operators_List_${new Date().toISOString().split('T')[0]}.xlsx`;
                } else if (type === 'performance') {
                    performanceData.forEach(record => {
                        let machineName = record.machineName || '-';
                        if (record.machineName === 'Others' && record.customMachineName) {
                            machineName = record.customMachineName;
                        }
                        
                        let cycleTimesStr = '';
                        if (record.cycleTimes && Array.isArray(record.cycleTimes)) {
                            cycleTimesStr = record.cycleTimes.map((time, i) => `Cycle ${i+1}: ${time.toFixed(3)} sec`).join('; ');
                        }
                        
                        const row = {
                            'Timestamp': record.timestamp.toLocaleString(),
                            'Line No': record.lineNo || '',
                            'Style No': record.styleNo || '',
                            'Product Description': record.productDesc || '',
                            'Operator ID': record.operatorId || '',
                            'Operator Name': record.operatorName || '',
                            'Operation': record.operation || '',
                            'Machine Name': machineName,
                            'Other Machines': record.otherMachines || '',
                            'Standard SMV': record.standardSMV || '',
                            'Working SMV': record.workingSMV || '',
                            'Cycle Times': cycleTimesStr,
                            'Efficiency': record.efficiency ? record.efficiency.toFixed(1) + '%' : '',
                            'Allowance %': record.allowance || 13
                        };
                        data.push(row);
                    });
                    
                    filename = `Performance_Data_${new Date().toISOString().split('T')[0]}.xlsx`;
                } else if (type === 'dashboard') {
                    // Export dashboard data
                    const uniqueLines = new Set();
                    performanceData.forEach(record => {
                        if (record.lineNo) uniqueLines.add(record.lineNo);
                    });
                    
                    data.push({
                        'Dashboard Type': 'Summary',
                        'Total Operators': operators.length,
                        'Total Performance Records': performanceData.length,
                        'Active Lines': uniqueLines.size,
                        'Average Efficiency': performanceData.length > 0 ? 
                            (performanceData.reduce((sum, record) => sum + (record.efficiency || 0), 0) / performanceData.length).toFixed(1) + '%' : '0%'
                    });
                    
                    filename = `Dashboard_Report_${new Date().toISOString().split('T')[0]}.xlsx`;
                }
                
                const worksheet = XLSX.utils.json_to_sheet(data);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, type === 'operators' ? 'Operators' : 
                    type === 'performance' ? 'Performance' : 'Dashboard');
                
                XLSX.writeFile(workbook, filename);
                showToast('Excel file exported successfully!');
            } catch (error) {
                console.error('Error exporting Excel:', error);
                showToast('Error exporting Excel: ' + error.message, 'error');
            }
        }

        // Export group operators to Excel
        function exportGroupOperators(group) {
            const filteredOperators = operators.filter(operator => {
                const multiSkillGrade = calculateMultiSkillGrade(operator.operatorId);
                return multiSkillGrade === group;
            });
            
            const data = filteredOperators.map(operator => {
                const operatorEfficiency = getOperatorAverageEfficiency(operator.operatorId);
                const skillScore = calculateSkillScore(operator.operatorId);
                
                return {
                    'Operator ID': operator.operatorId,
                    'Operator Name': operator.name,
                    'Sew Line': operator.sewLine || '',
                    'Skill Level': group,
                    'Average Efficiency': operatorEfficiency.toFixed(1) + '%',
                    'Skill Score': skillScore.toFixed(2),
                    'Multi-Skill Grade': group
                };
            });
            
            const worksheet = XLSX.utils.json_to_sheet(data);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, group);
            
            const filename = `${group}_Operators_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(workbook, filename);
            showToast(`${group} operators exported successfully!`);
        }

// Reset time study form (keep auto-fill functionality)
function resetTimeStudyForm() {
    // Don't clear line number, style, and product desc
    // Let them be auto-filled when user enters line number
    
    document.getElementById('studyOperatorId').value = '';
    // Keep line number field for auto-fill
    document.getElementById('studyOperation').value = '';
    document.getElementById('studyMachine').value = '';
    document.getElementById('customMachineName').value = '';
    document.getElementById('customMachineRow').style.display = 'none';
    document.getElementById('standardSMV').value = '';
    
    // Clear other machines
    document.getElementById('selectedOtherMachines').innerHTML = '';
    
    // Reset stopwatch
    resetStopwatch();
    
    // Reset manual inputs
    document.getElementById('manualCycleInputs').style.display = 'none';
    document.querySelectorAll('.manual-cycle-time').forEach(input => {
        input.value = '';
    });
    
    // Hide allowance info
    elements.allowanceInfo.style.display = 'none';
}

        // Show toast notification
        function showToast(message, type = 'success') {
            elements.toastMessage.textContent = message;
            const toast = elements.notificationToast;
            const icon = toast.querySelector('i');
            
            toast.className = 'toast';
            if (type === 'error') {
                toast.classList.add('toast-error');
                icon.className = 'fas fa-exclamation-circle';
            } else {
                toast.classList.add('toast-success');
                icon.className = 'fas fa-check-circle';
            }
            
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 4000);
        }

        // Enhanced Working SMV breakdown modal
        function showCycleTimesDetail(recordId) {
            const record = performanceData.find(r => r.id === recordId);
            if (!record) return;
            
            // Populate modal with data
            document.getElementById('detailOperatorName').textContent = record.operatorName || 'Unknown';
            document.getElementById('detailOperation').textContent = record.operation || 'Unknown';
            document.getElementById('detailStdSMV').textContent = record.standardSMV ? record.standardSMV.toFixed(2) : '0.00';
            document.getElementById('detailWorkingSMV').textContent = record.workingSMV ? record.workingSMV.toFixed(2) : '0.00';
            document.getElementById('detailEfficiency').textContent = record.efficiency ? record.efficiency.toFixed(1) + '%' : '0%';
            
            // Calculate variance
            const variance = record.standardSMV > 0 ? 
                ((record.workingSMV - record.standardSMV) / record.standardSMV) * 100 : 0;
            document.getElementById('detailVariance').textContent = variance.toFixed(1) + '%';
            
            // Populate cycle times list
            const cycleTimesList = document.getElementById('cycleTimesList');
            cycleTimesList.innerHTML = '';
            
            if (record.cycleTimes && record.cycleTimes.length > 0) {
                let totalTime = 0;
                record.cycleTimes.forEach((time, index) => {
                    totalTime += time;
                    const row = document.createElement('div');
                    row.className = 'lap-item';
                    row.innerHTML = `
                        <div class="lap-number">Cycle ${index + 1}</div>
                        <div class="lap-time">${time.toFixed(3)} seconds</div>
                    `;
                    cycleTimesList.appendChild(row);
                });
                
                // Add average
                const avgRow = document.createElement('div');
                avgRow.className = 'lap-item';
                avgRow.style.backgroundColor = 'rgba(76, 201, 240, 0.1)';
                avgRow.innerHTML = `
                    <div class="lap-number"><strong>Average</strong></div>
                    <div class="lap-time"><strong>${(totalTime / record.cycleTimes.length).toFixed(3)} seconds</strong></div>
                `;
                cycleTimesList.appendChild(avgRow);
            } else {
                cycleTimesList.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">No cycle time data available</div>';
            }
            
            // Show modal
            document.getElementById('cycleDetailModal').classList.add('active');
        }

        // Setup multi-select for other machines
        function setupMultiSelect() {
            const machineOptions = [
                'BARTACK', 'BUTTON ATTACH', 'BUTTONHOLE', 'DNLS', 'FLATLOCK',
                'FOA', 'FS', 'KANSAI', 'OVERLOCK', 'SNLS', 'SNCS', 'Others'
            ];
            
            // Setup for time study
            const otherMachinesOptions = document.getElementById('otherMachinesOptions');
            const perfOtherMachinesOptions = document.getElementById('perfOtherMachinesOptions');
            
            machineOptions.forEach(machine => {
                // Time study options
                const option1 = document.createElement('div');
                option1.className = 'multi-select-option';
                option1.innerHTML = `
                    <input type="checkbox" value="${machine}">
                    <span>${machine}</span>
                `;
                otherMachinesOptions.appendChild(option1);
                
                // Performance modal options
                const option2 = document.createElement('div');
                option2.className = 'multi-select-option';
                option2.innerHTML = `
                    <input type="checkbox" value="${machine}">
                    <span>${machine}</span>
                `;
                perfOtherMachinesOptions.appendChild(option2);
            });
            
            // Add event listeners for multi-select
            setupMultiSelectEvents('otherMachinesSelect', 'otherMachinesOptions', 'selectedOtherMachines');
            setupMultiSelectEvents('perfOtherMachinesSelect', 'perfOtherMachinesOptions', 'perfSelectedOtherMachines');
        }

        function setupMultiSelectEvents(selectId, optionsId, selectedId) {
            const select = document.getElementById(selectId);
            const options = document.getElementById(optionsId);
            const selected = document.getElementById(selectedId);
            
            select.querySelector('.multi-select-display').addEventListener('click', () => {
                options.classList.toggle('show');
            });
            
            // Close when clicking outside
            document.addEventListener('click', (e) => {
                if (!select.contains(e.target)) {
                    options.classList.remove('show');
                }
            });
            
            // Handle checkbox changes
            options.addEventListener('change', (e) => {
                if (e.target.type === 'checkbox') {
                    const value = e.target.value;
                    const checked = e.target.checked;
                    
                    if (checked) {
                        // Add tag
                        const tag = document.createElement('div');
                        tag.className = 'selected-tag';
                        tag.innerHTML = `
                            ${value}
                            <i class="fas fa-times" data-value="${value}"></i>
                        `;
                        selected.appendChild(tag);
                    } else {
                        // Remove tag
                        const tag = selected.querySelector(`.selected-tag i[data-value="${value}"]`)?.parentElement;
                        if (tag) {
                            tag.remove();
                        }
                    }
                }
            });
            
            // Handle tag removal
            selected.addEventListener('click', (e) => {
                if (e.target.classList.contains('fa-times')) {
                    const value = e.target.getAttribute('data-value');
                    const checkbox = options.querySelector(`input[value="${value}"]`);
                    if (checkbox) {
                        checkbox.checked = false;
                    }
                    e.target.parentElement.remove();
                }
            });
        }

        // Modal close functions
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Setup event listeners v13 - Updated with machine-specific allowances and line number fixes
        function setupEventListeners() {
            // Setup mobile menu - UPDATED for v13
            setupMobileMenu();
            
            // Dashboard Tab v11 - Updated for new layout
            document.getElementById('dashboardLineSelect').addEventListener('change', () => {
                updateDashboard();
            });
            
            document.getElementById('dashboardDateRange').addEventListener('change', () => {
                updateDashboard();
            });
            
            document.getElementById('refreshDashboardBtn').addEventListener('click', () => {
                updateDashboard();
                showToast('Dashboard refreshed!');
            });
            
            document.getElementById('exportDashboardBtn').addEventListener('click', () => exportToExcel('dashboard'));
            document.getElementById('quickAnalysisBtn').addEventListener('click', analyzePerformance);
            
            // Clickable Total Operators card
            document.getElementById('dashboardTotalOperatorsCard').addEventListener('click', () => {
                showAllOperatorsModal('dashboard');
            });
            
            // Clickable Skill Group Cards v11
            document.getElementById('dashboardGroupACard').addEventListener('click', () => showGroupOperators('Group A', 'dashboard'));
            document.getElementById('dashboardGroupBCard').addEventListener('click', () => showGroupOperators('Group B', 'dashboard'));
            document.getElementById('dashboardGroupCCard').addEventListener('click', () => showGroupOperators('Group C', 'dashboard'));
            document.getElementById('dashboardGroupDCard').addEventListener('click', () => showGroupOperators('Group D', 'dashboard'));
            
            document.getElementById('operatorsTotalOperatorsCard').addEventListener('click', () => {
                showAllOperatorsModal('operators');
            });
            
            // Group clickable distribution items in operators tab
            document.getElementById('operatorsGroupAClickable').addEventListener('click', () => showGroupOperators('Group A', 'operators'));
            document.getElementById('operatorsGroupBClickable').addEventListener('click', () => showGroupOperators('Group B', 'operators'));
            document.getElementById('operatorsGroupCClickable').addEventListener('click', () => showGroupOperators('Group C', 'operators'));
            document.getElementById('operatorsGroupDClickable').addEventListener('click', () => showGroupOperators('Group D', 'operators'));
            
            // Operators Tab
            elements.searchInput.addEventListener('input', filterOperators);
            elements.skillFilter.addEventListener('change', filterOperators);
            elements.lineFilter.addEventListener('change', filterOperators);
            document.getElementById('operatorsLineFilter').addEventListener('change', () => {
                updateStats();
                filterOperators();
            });
            
            // Performance Tab
            document.getElementById('searchPerformance').addEventListener('input', filterPerformanceData);
            document.getElementById('perfLineFilter').addEventListener('change', filterPerformanceData);
            document.getElementById('dateFilter').addEventListener('change', filterPerformanceData);
            
            // Import Excel buttons
            document.getElementById('importExcelBtn').addEventListener('click', () => {
                document.getElementById('importExcelInput').click();
            });
            
            document.getElementById('importExcelInput').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    await importExcelData(file, 'operators');
                    e.target.value = '';
                }
            });
            
            document.getElementById('importPerformanceBtn').addEventListener('click', () => {
                document.getElementById('importPerformanceInput').click();
            });
            
            document.getElementById('importPerformanceInput').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    await importExcelData(file, 'performance');
                    e.target.value = '';
                }
            });
            
            // Action buttons
            document.getElementById('addOperatorBtn').addEventListener('click', () => {
                document.getElementById('addOperatorModal').classList.add('active');
                document.getElementById('newOperatorId').focus();
            });
            
            document.getElementById('exportBtn').addEventListener('click', () => exportToExcel('operators'));
            document.getElementById('exportPerformanceBtn').addEventListener('click', () => exportToExcel('performance'));
            document.getElementById('exportGroupBtn').addEventListener('click', () => {
                const group = document.getElementById('groupModalTitle').textContent.replace(' Operators', '').split(' - ')[0];
                exportGroupOperators(group);
            });
            
            document.getElementById('saveBtn').addEventListener('click', async () => {
                showToast('All changes saved to cloud!');
            });
            
            document.getElementById('refreshBtn').addEventListener('click', () => {
                loadData();
                showToast('Refreshing data...');
            });
            
            document.getElementById('addPerformanceBtn').addEventListener('click', () => {
                document.getElementById('addPerformanceModal').classList.add('active');
                document.getElementById('perfOperatorId').focus();
            });
            
            document.getElementById('analyzeBtn').addEventListener('click', analyzePerformance);
            
            // Stopwatch event listeners
            document.getElementById('startBtn').addEventListener('click', startStopwatch);
            document.getElementById('stopBtn').addEventListener('click', stopStopwatch);
            document.getElementById('lapBtn').addEventListener('click', recordLap);
            document.getElementById('resetBtn').addEventListener('click', resetStopwatch);
            
            document.getElementById('savePerformanceData').addEventListener('click', async () => {
                await saveTimeStudyData();
            });
            
            document.getElementById('resetStopwatch').addEventListener('click', () => {
                resetStopwatch();
                elements.lapsList.innerHTML = '';
                document.getElementById('avgCycleTime').textContent = '0.00';
                document.getElementById('totalCycleTime').textContent = '0.00';
                document.getElementById('workingSMVResult').textContent = '0.00';
                document.getElementById('efficiencyResult').textContent = '0%';
            });
            
            // Cycle count selection
            document.querySelectorAll('input[name="cycleCount"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const value = e.target.value;
                    cycleCount = value === 'manual' ? 0 : parseInt(value);
                    
                    if (value === 'manual') {
                        document.getElementById('manualCycleInputs').style.display = 'block';
                        // Set up manual inputs
                        setupManualCycleInputs(cycleCount);
                    } else {
                        document.getElementById('manualCycleInputs').style.display = 'none';
                        if (lapCounter > 0) {
                            if (confirm('Changing cycle count will reset the current measurements. Continue?')) {
                                resetStopwatch();
                            } else {
                                // Revert to previous selection
                                const previousValue = lapCounter >= 3 ? '3' : '5';
                                document.querySelector(`input[name="cycleCount"][value="${previousValue}"]`).checked = true;
                            }
                        }
                    }
                });
            });
            
            // Manual cycle calculation
            document.getElementById('calculateManualBtn').addEventListener('click', calculateManualCycles);
            
            document.getElementById('addManualCycleBtn').addEventListener('click', () => {
                const cycleNum = document.querySelectorAll('.manual-cycle-time').length + 1;
                const cycleDiv = document.createElement('div');
                cycleDiv.className = 'cycle-input-group';
                cycleDiv.innerHTML = `
                    <label>Cycle ${cycleNum} (seconds)</label>
                    <input type="number" class="manual-cycle-time" step="0.001" placeholder="e.g., 25.345">
                `;
                document.getElementById('manualCycleGrid').appendChild(cycleDiv);
            });
            
            // Machine dropdown with custom option - UPDATED for v13: Show allowance when machine is selected
            document.getElementById('studyMachine').addEventListener('change', (e) => {
                if (e.target.value === 'Others') {
                    document.getElementById('customMachineRow').style.display = 'block';
                } else {
                    document.getElementById('customMachineRow').style.display = 'none';
                    document.getElementById('customMachineName').value = '';
                }
                
                // Update allowance display when machine is selected
                updateAllowanceDisplay(e.target.value);
            });
            
            // Update allowance display when custom machine name is entered
            document.getElementById('customMachineName').addEventListener('input', () => {
                updateAllowanceDisplay('Others');
            });
            
            document.getElementById('perfMachine').addEventListener('change', (e) => {
                if (e.target.value === 'Others') {
                    document.getElementById('perfCustomMachineRow').style.display = 'block';
                } else {
                    document.getElementById('perfCustomMachineRow').style.display = 'none';
                    document.getElementById('perfCustomMachineName').value = '';
                }
            });
            
            // Group modal search and sort
            document.getElementById('groupSearchInput').addEventListener('input', () => {
                const sortBy = document.getElementById('groupSortBy').value;
                const currentGroup = document.getElementById('groupModalTitle').textContent.replace(' Operators', '').split(' - ')[0];
                showGroupOperators(currentGroup);
            });
            
            document.getElementById('groupSortBy').addEventListener('change', (e) => {
                const sortBy = e.target.value;
                const currentGroup = document.getElementById('groupModalTitle').textContent.replace(' Operators', '').split(' - ')[0];
                showGroupOperators(currentGroup);
            });
            
            // Add operator form
            document.getElementById('addOperatorForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const operatorData = {
                    operatorId: document.getElementById('newOperatorId').value.trim(),
                    name: document.getElementById('newOperatorName').value.trim(),
                    sewLine: document.getElementById('newSewLine').value.trim() || null,
                    skillLevel: document.getElementById('newSkillLevel').value || null
                };
                
                if (await saveOperator(operatorData, false)) {
                    document.getElementById('addOperatorForm').reset();
                    closeModal('addOperatorModal');
                    populateOperatorDropdowns();
                    populateLineFilter();
                    populateDashboardLineSelect();
                    populateOperatorsLineFilter();
                    updateGarmentSMVSelectors();
                }
            });
            
            // Edit operator form
            document.getElementById('editCellForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const operatorData = {
                    sewLine: document.getElementById('editSewLine').value.trim() || null,
                    skillLevel: document.getElementById('editSkillLevel').value || null
                };
                
                if (await saveOperator(operatorData, true)) {
                    closeModal('editCellModal');
                }
            });

            // Edit performance form with machine-specific allowance
            document.getElementById('editPerformanceForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const recordId = document.getElementById('editRecordId').textContent;
                const formData = {
                    standardSMV: parseFloat(document.getElementById('editRecordStdSMV').value),
                    workingSMV: parseFloat(document.getElementById('editRecordWorkingSMV').value),
                    cycleTimes: document.getElementById('editRecordCycleTimes').value
                };
                
                if (await updatePerformanceRecord(recordId, formData)) {
                    document.getElementById('editPerformanceForm').reset();
                    closeModal('editPerformanceModal');
                }
            });
            
            // Score slider sync
            const editSkillScoreInput = document.getElementById('editSkillScore');
            const scoreSlider = document.getElementById('scoreSlider');
            
            scoreSlider.addEventListener('input', (e) => {
                editSkillScoreInput.value = (e.target.value / 100).toFixed(2);
            });
            
            editSkillScoreInput.addEventListener('input', (e) => {
                const value = Math.min(1, Math.max(0, parseFloat(e.target.value) || 0));
                scoreSlider.value = Math.round(value * 100);
                editSkillScoreInput.value = value.toFixed(2);
            });
            
            // Close modals
            document.querySelectorAll('.close-modal, .btn-secondary[data-modal]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const modalId = e.target.getAttribute('data-modal') || 
                                   e.target.closest('.close-modal').getAttribute('data-modal');
                    if (modalId) {
                        closeModal(modalId);
                    }
                });
            });
            
            // Close modals on outside click
            window.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    e.target.classList.remove('active');
                }
            });
            
            // Setup multi-select after DOM is loaded
            setTimeout(() => {
                setupMultiSelect();
            }, 1000);
            
            // Escape key to close modals
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal.active').forEach(modal => {
                        modal.classList.remove('active');
                    });
                }
            });
        }

        // Show all operators modal
        function showAllOperatorsModal(source) {
            const totalOperators = operators.length;
            const avgEfficiency = performanceData.length > 0 ? 
                (performanceData.reduce((sum, record) => sum + (record.efficiency || 0), 0) / performanceData.length).toFixed(1) : 0;
            
            // Update modal title and info
            elements.groupModalTitle.textContent = `All Operators (${source})`;
            elements.groupOperatorCount.textContent = totalOperators;
            elements.groupAvgEfficiency.textContent = avgEfficiency + '%';
            elements.groupDescription.textContent = `Complete list of all ${totalOperators} operators in the system`;
            
            // Render all operators
            renderGroupOperatorsList(operators, 'skillScore');
            
            // Show modal
            document.getElementById('groupOperatorsModal').classList.add('active');
        }

        // Setup manual cycle inputs
        function setupManualCycleInputs(count) {
            const manualCycleGrid = document.getElementById('manualCycleGrid');
            manualCycleGrid.innerHTML = '';
            
            for (let i = 1; i <= count; i++) {
                const cycleDiv = document.createElement('div');
                cycleDiv.className = 'cycle-input-group';
                cycleDiv.innerHTML = `
                    <label>Cycle ${i} (seconds)</label>
                    <input type="number" class="manual-cycle-time" step="0.001" placeholder="e.g., 25.345">
                `;
                manualCycleGrid.appendChild(cycleDiv);
            }
        }

        // Save performance data from time study WITH MACHINE-SPECIFIC ALLOWANCE
        async function saveTimeStudyData() {
            try {
                const operatorId = document.getElementById('studyOperatorId').value;
                const operator = operators.find(op => op.operatorId === operatorId);
                if (!operator) {
                    showToast('Please select a valid operator', 'error');
                    return false;
                }
                
                if (lapTimes.length === 0) {
                    showToast('Please record at least one cycle time', 'error');
                    return false;
                }
                
                const avgTime = lapTimes.reduce((a, b) => a + b, 0) / lapTimes.length;
                
                // Get machine allowance
                const machineName = document.getElementById('studyMachine').value;
                const machineAllowance = getMachineAllowance(machineName);
                const totalAllowance = PERSONAL_ALLOWANCE + CONTINGENCY_ALLOWANCE + machineAllowance;
                
                const workingSMV = (avgTime / 60) * (1 + totalAllowance/100);
                const standardSMV = parseFloat(document.getElementById('standardSMV').value);
                
                if (!standardSMV || standardSMV <= 0) {
                    showToast('Please enter a valid Standard SMV', 'error');
                    return false;
                }
                
                const efficiency = (standardSMV / workingSMV) * 100;
                
                // Get custom machine name if applicable
                let customMachineName = '';
                if (machineName === 'Others') {
                    customMachineName = document.getElementById('customMachineName').value.trim();
                    if (!customMachineName) {
                        showToast('Please enter a custom machine name', 'error');
                        return false;
                    }
                }
                
                // Get other machines
                const otherMachines = [];
                document.querySelectorAll('#selectedOtherMachines .selected-tag').forEach(tag => {
                    otherMachines.push(tag.textContent.trim().replace('', ''));
                });
                
                // Update operator machine skill
                updateOperatorMachineSkill(operatorId, machineName === 'Others' ? customMachineName : machineName, efficiency);
                
                // Save performance record
                const docRef = doc(collection(db, 'performance'));
                await setDoc(docRef, {
                    timestamp: serverTimestamp(),
                    lineNo: elements.studyLineNo.value,
                    styleNo: elements.studyStyleNo.value,
                    productDesc: elements.studyProductDesc.value,
                    operatorId: operatorId,
                    operatorName: operator.name,
                    operation: document.getElementById('studyOperation').value,
                    machineName: machineName,
                    customMachineName: customMachineName,
                    standardSMV: standardSMV,
                    workingSMV: workingSMV,
                    efficiency: efficiency,
                    otherMachines: otherMachines.join(', '),
                    cycleTimes: lapTimes,
                    avgCycleTime: avgTime,
                    personalAllowance: PERSONAL_ALLOWANCE,
                    contingencyAllowance: CONTINGENCY_ALLOWANCE,
                    machineAllowance: machineAllowance,
                    totalAllowance: totalAllowance
                });
                
                showToast('Performance data saved successfully!');
                resetTimeStudyForm();
                return true;
            } catch (error) {
                console.error('Error saving performance data:', error);
                showToast('Error saving data: ' + error.message, 'error');
                return false;
            }
        }

        // Update performance record with machine-specific allowance
        async function updatePerformanceRecord(recordId, formData) {
            try {
                const recordRef = doc(db, 'performance', recordId);
                const record = performanceData.find(r => r.id === recordId);
                
                if (!record) {
                    throw new Error('Record not found');
                }
                
                // Parse cycle times
                const cycleTimes = formData.cycleTimes
                    .split(',')
                    .map(time => parseFloat(time.trim()))
                    .filter(time => !isNaN(time));
                
                // Calculate machine allowance
                const machineName = record.machineName || '';
                let machineAllowance = record.machineAllowance || getMachineAllowance(machineName);
                
                // If it's a custom machine, try to get allowance
                if (machineName === 'Others' && record.customMachineName) {
                    machineAllowance = getMachineAllowance('Others');
                }
                
                // Recalculate working SMV and efficiency with machine-specific allowance
                const avgTime = cycleTimes.length > 0 ? 
                    cycleTimes.reduce((a, b) => a + b, 0) / cycleTimes.length : 0;
                const totalAllowance = PERSONAL_ALLOWANCE + CONTINGENCY_ALLOWANCE + machineAllowance;
                const workingSMV = (avgTime / 60) * (1 + totalAllowance/100);
                const efficiency = formData.standardSMV > 0 ? 
                    (formData.standardSMV / workingSMV) * 100 : 0;
                
                await updateDoc(recordRef, {
                    standardSMV: formData.standardSMV,
                    workingSMV: workingSMV,
                    efficiency: efficiency,
                    cycleTimes: cycleTimes,
                    avgCycleTime: avgTime,
                    personalAllowance: PERSONAL_ALLOWANCE,
                    contingencyAllowance: CONTINGENCY_ALLOWANCE,
                    machineAllowance: machineAllowance,
                    totalAllowance: totalAllowance,
                    lastUpdated: serverTimestamp()
                });
                
                showToast('Performance record updated successfully!');
                return true;
            } catch (error) {
                console.error('Error updating record:', error);
                showToast('Error updating record: ' + error.message, 'error');
                return false;
            }
        }

        // Delete performance record
        async function deletePerformanceRecord(id) {
            try {
                await deleteDoc(doc(db, 'performance', id));
                showToast('Performance record deleted successfully!');
            } catch (error) {
                console.error('Error deleting record:', error);
                showToast('Error deleting record: ' + error.message, 'error');
            }
        }

        // Analyze Performance
        function analyzePerformance() {
            if (performanceData.length === 0) {
                showToast('No performance data available for analysis', 'error');
                return;
            }
            
            // Calculate overall statistics
            const totalEfficiency = performanceData.reduce((sum, record) => sum + (record.efficiency || 0), 0);
            const avgEfficiency = totalEfficiency / performanceData.length;
            
            showToast(`Overall Efficiency: ${avgEfficiency.toFixed(1)}% | Total Records: ${performanceData.length}`, 'success');

            // Switch to dashboard tab
            document.querySelector('.nav-item[data-tab="dashboard"]').click();
        }
    </script>
</body>
</html>
