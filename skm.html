<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sidney Apparels - Operator Performance System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --accent-color: #f72585;
            --success-color: #4cc9f0;
            --warning-color: #f8961e;
            --dark-bg: #0a0e17;
            --card-bg: rgba(255, 255, 255, 0.1);
            --card-border: rgba(255, 255, 255, 0.2);
            --text-primary: #ffffff;
            --text-secondary: #b0b7c3;
            --dropdown-bg: rgba(30, 35, 50, 0.95);
            --dropdown-hover: rgba(67, 97, 238, 0.5);
            --dropdown-text: #ffffff;
            --glow: 0 8px 32px rgba(67, 97, 238, 0.2);
            --transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #0a0e17 0%, #1a1f35 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(circle at 20% 80%, rgba(67, 97, 238, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(248, 37, 133, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(76, 201, 240, 0.1) 0%, transparent 50%);
            z-index: -1;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 30px;
        }

        /* Header */
        .header {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--card-border);
            border-radius: 24px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--glow);
            position: relative;
            overflow: hidden;
            animation: slideDown 0.6s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            border-radius: 24px 24px 0 0;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            box-shadow: 0 4px 20px rgba(67, 97, 238, 0.4);
        }

        .logo-text h1 {
            font-size: 2.4rem;
            font-weight: 700;
            background: linear-gradient(135deg, #ffffff, #b0b7c3);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 5px;
        }

        .logo-text h2 {
            font-size: 1.2rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .header-info {
            display: flex;
            gap: 30px;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .info-item i {
            color: var(--primary-color);
            font-size: 1.2rem;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 18px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .tab-btn {
            padding: 14px 28px;
            border: none;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 14px;
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tab-btn.active {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 20px rgba(67, 97, 238, 0.25);
        }

        .tab-btn:hover:not(.active) {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
        }

        /* Controls Panel */
        .controls-panel {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--card-border);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--glow);
        }

        .search-filter {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            position: relative;
            flex: 1;
            min-width: 300px;
        }

        .search-box i {
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            z-index: 1;
        }

        .search-box input {
            width: 100%;
            padding: 14px 20px 14px 48px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 14px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: var(--transition);
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
            background: rgba(255, 255, 255, 0.08);
        }

        .filter-options {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .filter-options select {
            padding: 14px 20px;
            background: var(--dropdown-bg);
            color: var(--dropdown-text);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 14px;
            font-size: 1rem;
            min-width: 220px;
            cursor: pointer;
            transition: var(--transition);
        }

        .filter-options select:focus {
            outline: none;
            border-color: var(--primary-color);
            background: var(--dropdown-hover);
        }

        select option {
            background: var(--dropdown-bg);
            color: var(--dropdown-text);
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 14px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 10px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .btn:active {
            transform: translateY(-1px);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #2a9d8f);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #e67e22);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-info {
            background: linear-gradient(135deg, #4361ee, #3a0ca3);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--accent-color), #b5179e);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Stats Dashboard */
        .stats-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--card-border);
            border-radius: 20px;
            padding: 30px;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            animation: fadeIn 0.8s ease-out;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(67, 97, 238, 0.1), rgba(76, 201, 240, 0.1));
            opacity: 0;
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .stat-card.glow {
            border: 1px solid rgba(67, 97, 238, 0.3);
            box-shadow: 0 8px 32px rgba(67, 97, 238, 0.15);
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .stat-icon {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 20px rgba(67, 97, 238, 0.4);
        }

        .stat-change {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 20px;
            background: rgba(76, 201, 240, 0.1);
            color: var(--success-color);
        }

        .stat-change.negative {
            background: rgba(248, 37, 133, 0.1);
            color: var(--accent-color);
        }

        .stat-content h3 {
            font-size: 2.8rem;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #ffffff, var(--text-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-content p {
            color: var(--text-secondary);
            font-size: 1rem;
            font-weight: 500;
        }

        /* Updated: Skill Group Stats */
        .skill-group-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 10px;
        }

        .skill-group-stat {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .skill-group-stat.group-a {
            border-color: rgba(76, 201, 240, 0.3);
        }

        .skill-group-stat.group-b {
            border-color: rgba(67, 97, 238, 0.3);
        }

        .skill-group-stat.group-c {
            border-color: rgba(248, 150, 30, 0.3);
        }

        .skill-group-stat .count {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .skill-group-stat.group-a .count {
            color: var(--success-color);
        }

        .skill-group-stat.group-b .count {
            color: var(--primary-color);
        }

        .skill-group-stat.group-c .count {
            color: var(--warning-color);
        }

        /* Main Content */
        .main-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        /* Table Container */
        .table-container {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--card-border);
            border-radius: 24px;
            overflow: hidden;
            box-shadow: var(--glow);
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .table-header {
            padding: 25px 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .table-header h3 {
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .table-header h3 i {
            color: var(--primary-color);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table thead {
            background: rgba(255, 255, 255, 0.05);
        }

        .data-table th {
            padding: 20px 25px;
            text-align: left;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .data-table tbody tr {
            transition: var(--transition);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .data-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .data-table td {
            padding: 20px 25px;
            color: var(--text-primary);
        }

        .operator-id {
            font-weight: 600;
            color: var(--primary-color);
        }

        /* Skill level classes */
        .skill-level {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .skill-group-a {
            background: rgba(76, 201, 240, 0.15);
            color: var(--success-color);
        }

        .skill-group-b {
            background: rgba(67, 97, 238, 0.15);
            color: var(--primary-color);
        }

        .skill-group-c {
            background: rgba(248, 150, 30, 0.15);
            color: var(--warning-color);
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
            transition: var(--transition);
        }

        .btn-icon:hover {
            background: rgba(67, 97, 238, 0.2);
            color: var(--primary-color);
            border-color: rgba(67, 97, 238, 0.3);
        }

        /* Updated: Working SMV Button */
        .working-smv-cell {
            position: relative;
        }

        .working-smv-btn {
            background: rgba(67, 97, 238, 0.1);
            border: 1px solid rgba(67, 97, 238, 0.3);
            color: var(--primary-color);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .working-smv-btn:hover {
            background: rgba(67, 97, 238, 0.2);
            transform: translateY(-2px);
        }

        /* Stopwatch Styles - UPDATED */
        .stopwatch-container {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--card-border);
            border-radius: 24px;
            overflow: hidden;
            box-shadow: var(--glow);
            padding: 25px;
            margin-bottom: 30px;
        }

        .subtitle {
            color: var(--text-secondary);
            margin: 8px 0 20px 0;
            font-size: 1.1rem;
        }

        .single-stopwatch {
            text-align: center;
            background: rgba(255, 255, 255, 0.05);
            padding: 30px;
            border-radius: 18px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }

        /* Updated Stopwatch Display */
        .stopwatch-display-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .stopwatch-main {
            font-family: 'Courier New', monospace;
            font-size: 3rem;
            font-weight: 700;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 14px;
            letter-spacing: 2px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            text-align: center;
            min-width: 300px;
        }

        .stopwatch-lap {
            font-family: 'Courier New', monospace;
            font-size: 1.5rem;
            color: var(--success-color);
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            min-width: 150px;
            text-align: center;
        }

        .stopwatch-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }

        .stopwatch-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 120px;
            font-size: 1rem;
        }

        .stopwatch-btn-start {
            background: linear-gradient(135deg, var(--success-color), #2a9d8f);
            color: white;
            border: none;
        }

        .stopwatch-btn-stop {
            background: linear-gradient(135deg, var(--accent-color), #b5179e);
            color: white;
            border: none;
        }

        .stopwatch-btn-lap {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
        }

        .cycle-options {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }

        .cycle-options label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .cycle-options input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .laps-container {
            margin-top: 25px;
            max-height: 300px;
            overflow-y: auto;
        }

        .laps-header {
            display: flex;
            justify-content: space-between;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .lap-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .lap-item:last-child {
            border-bottom: none;
        }

        .lap-number {
            font-weight: 600;
            color: var(--primary-color);
        }

        .lap-time {
            font-family: 'Courier New', monospace;
            color: var(--success-color);
        }

        .cycle-results {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--card-border);
            border-radius: 24px;
            padding: 25px;
            margin-top: 30px;
            box-shadow: var(--glow);
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .result-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: var(--transition);
        }

        .result-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-3px);
        }

        .result-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--primary-color), var(--success-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .efficiency-high {
            color: var(--success-color);
        }

        .efficiency-medium {
            color: var(--warning-color);
        }

        .efficiency-low {
            color: var(--accent-color);
        }

        .result-label {
            font-size: 0.95rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Image Upload */
        .image-upload-container {
            margin: 25px 0;
        }

        .image-preview {
            width: 100%;
            max-width: 300px;
            height: 200px;
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            margin-bottom: 20px;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.05);
            transition: var(--transition);
        }

        .image-preview:hover {
            border-color: var(--primary-color);
        }

        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }

        .image-preview i {
            font-size: 4rem;
            color: var(--text-secondary);
        }

        .image-preview.has-image i {
            display: none;
        }

        .image-preview.has-image img {
            display: block;
        }

        /* Form Groups */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 16px 20px;
            background: var(--dropdown-bg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 14px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: var(--transition);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
            background: rgba(67, 97, 238, 0.2);
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-group input::placeholder,
        .form-group select::placeholder {
            color: var(--text-secondary);
        }

        /* Performance Table */
        .performance-table {
            width: 100%;
            border-collapse: collapse;
        }

        .performance-table th {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px 25px;
            text-align: left;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .performance-table td {
            padding: 15px 25px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            position: relative;
        }

        /* Legend */
        .legend {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--card-border);
            border-radius: 24px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: var(--glow);
        }

        .legend-title {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .legend-items {
            display: flex;
            flex-wrap: wrap;
            gap: 25px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .legend-color {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 30px;
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--card-border);
            border-radius: 24px;
            margin-top: 30px;
            box-shadow: var(--glow);
        }

        .footer p {
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .footer-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .footer-stat {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .footer-stat i {
            color: var(--primary-color);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 14, 23, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.3s ease-out;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid var(--card-border);
            border-radius: 24px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        @keyframes modalSlideUp {
            from {
                opacity: 0;
                transform: translateY(40px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            padding: 30px 30px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }

        .modal-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            border-radius: 24px 24px 0 0;
        }

        .modal-header h3 {
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .close-modal {
            position: absolute;
            top: 30px;
            right: 30px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
            transition: var(--transition);
        }

        .close-modal:hover {
            background: rgba(248, 37, 133, 0.2);
            color: var(--accent-color);
            border-color: rgba(248, 37, 133, 0.3);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 30px;
        }

        .edit-info {
            margin-bottom: 25px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 14px;
            border-left: 3px solid var(--primary-color);
        }

        .score-slider {
            margin-top: 15px;
            width: 100%;
        }

        .score-slider input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
            -webkit-appearance: none;
        }

        .score-slider input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(67, 97, 238, 0.5);
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 25px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--card-border);
            padding: 20px;
            border-radius: 16px;
            transform: translateY(100px) scale(0.9);
            opacity: 0;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s ease;
            z-index: 1001;
            min-width: 300px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .toast.show {
            transform: translateY(0) scale(1);
            opacity: 1;
        }

        .toast-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .toast-content i {
            font-size: 1.5rem;
        }

        .toast-success i {
            color: var(--success-color);
        }

        .toast-error i {
            color: var(--accent-color);
        }

        /* Loading Animation */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 14, 23, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .loading-spinner {
            width: 80px;
            height: 80px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 25px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.2rem;
            font-weight: 500;
            color: var(--text-secondary);
            letter-spacing: 2px;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* NEW: Analysis Modal Styles */
        .analysis-modal-content {
            max-width: 90%;
            width: 1200px;
            height: 85vh;
        }

        .analysis-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 15px;
        }

        .analysis-tab-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: none;
            border-radius: 10px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
        }

        .analysis-tab-btn.active {
            background: var(--primary-color);
            color: white;
        }

        .analysis-charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 25px;
            margin-bottom: 25px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-height: 300px;
        }

        .chart-container h4 {
            margin-bottom: 15px;
            color: var(--text-primary);
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .analysis-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }

        .summary-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .summary-card h4 {
            color: var(--text-secondary);
            margin-bottom: 15px;
            font-size: 1rem;
        }

        .summary-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        /* NEW: Cycle Times Detail Modal */
        .cycle-detail-modal {
            max-width: 500px;
        }

        .cycle-detail-content {
            padding: 20px;
        }

        .cycle-info {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .cycle-info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .cycle-info-item:last-child {
            border-bottom: none;
        }

        .cycle-times-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .cycle-time-row {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .calculation-steps {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .calculation-step {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .calculation-step:last-child {
            border-bottom: none;
        }

        .calculation-step h5 {
            color: var(--primary-color);
            margin-bottom: 8px;
        }

        .calculation-formula {
            font-family: 'Courier New', monospace;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }

        /* Analysis Tab Content */
        .analysis-tab-content {
            display: none;
        }

        .analysis-tab-content.active {
            display: block;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .container {
                padding: 20px;
            }
            
            .stats-dashboard {
                grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            }
            
            .form-row {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
            
            .analysis-charts-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 900px) {
            .header-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 20px;
            }
            
            .header-info {
                flex-direction: column;
                width: 100%;
                gap: 10px;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .skill-group-stats {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .stats-dashboard {
                grid-template-columns: 1fr;
            }
            
            .search-filter {
                flex-direction: column;
                align-items: stretch;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                margin: 15px;
                max-width: 95%;
            }
            
            .table-container {
                overflow-x: auto;
            }
            
            .data-table {
                min-width: 800px;
            }
            
            .stopwatch-main {
                font-size: 2rem;
                min-width: 250px;
            }
            
            .stopwatch-controls {
                flex-wrap: wrap;
            }
            
            .stopwatch-btn {
                min-width: 100px;
            }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-color);
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">LOADING SYSTEM DATA</div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-industry"></i>
                    </div>
                    <div class="logo-text">
                        <h1>SIDNEY APPARELS LLC</h1>
                        <h2>OPERATOR PERFORMANCE SYSTEM</h2>
                    </div>
                </div>
                <div class="header-info">
                    <div class="info-item">
                        <i class="fas fa-calendar-alt"></i>
                        <div>
                            <div class="label">LAST UPDATED</div>
                            <div class="value" id="lastUpdated">--/--/----</div>
                        </div>
                    </div>
                    <div class="info-item">
                        <i class="fas fa-user-tie"></i>
                        <div>
                            <div class="label">MANUFACTURING EXCELLENCE</div>
                            <div class="value">VERSION 3.0</div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-btn active" data-tab="operators">
                <i class="fas fa-users"></i> Operators
            </button>
            <button class="tab-btn" data-tab="performance">
                <i class="fas fa-chart-line"></i> Performance Data
            </button>
            <button class="tab-btn" data-tab="time-study">
                <i class="fas fa-stopwatch"></i> Time Study
            </button>
        </div>

        <!-- Tab Contents -->
        <!-- Operators Tab -->
        <div id="operators" class="tab-content active">
            <div class="stats-dashboard">
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-change">
                            <i class="fas fa-arrow-up"></i>
                            12%
                        </div>
                    </div>
                    <div class="stat-content">
                        <h3 id="totalOperators">0</h3>
                        <p>Total Operators</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-star"></i>
                        </div>
                        <div class="stat-change">
                            <i class="fas fa-arrow-up"></i>
                            8%
                        </div>
                    </div>
                    <div class="stat-content">
                        <h3 id="avgSkillScore">0.00</h3>
                        <p>Avg. Skill Score</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-cogs"></i>
                        </div>
                        <div class="stat-change negative">
                            <i class="fas fa-arrow-down"></i>
                            2%
                        </div>
                    </div>
                    <div class="stat-content">
                        <h3 id="totalSkills">0</h3>
                        <p>Total Skills Tracked</p>
                    </div>
                </div>
                <!-- UPDATED: Skill Group Stats Card -->
                <div class="stat-card glow">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-layer-group"></i>
                        </div>
                        <div class="stat-change">
                            <i class="fas fa-chart-pie"></i>
                        </div>
                    </div>
                    <div class="stat-content">
                        <div class="skill-group-stats">
                            <div class="skill-group-stat group-a">
                                <div class="count" id="groupACount">0</div>
                                <div>Group A</div>
                            </div>
                            <div class="skill-group-stat group-b">
                                <div class="count" id="groupBCount">0</div>
                                <div>Group B</div>
                            </div>
                            <div class="skill-group-stat group-c">
                                <div class="count" id="groupCCount">0</div>
                                <div>Group C</div>
                            </div>
                        </div>
                        <p style="margin-top: 15px;">Operator Distribution</p>
                    </div>
                </div>
            </div>

            <div class="controls-panel">
                <div class="search-filter">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchInput" placeholder="Search by Operator ID or Name...">
                    </div>
                    <div class="filter-options">
                        <select id="skillFilter">
                            <option value="">Filter by Skill Level...</option>
                            <option value="Group A">Group A</option>
                            <option value="Group B">Group B</option>
                            <option value="Group C">Group C</option>
                        </select>
                        <select id="lineFilter">
                            <option value="">Filter by Sew Line...</option>
                        </select>
                    </div>
                </div>
                <div class="action-buttons">
                    <button id="addOperatorBtn" class="btn btn-primary">
                        <i class="fas fa-user-plus"></i> Add Operator
                    </button>
                    <button id="exportBtn" class="btn btn-success">
                        <i class="fas fa-file-excel"></i> Export Excel
                    </button>
                    <button id="saveBtn" class="btn btn-warning">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                    <button id="refreshBtn" class="btn btn-info">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>

            <div class="table-container">
                <div class="table-header">
                    <h3><i class="fas fa-table"></i> OPERATORS MASTER LIST</h3>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>OPERATOR ID</th>
                            <th>OPERATOR NAME</th>
                            <th>CURRENT SEW LINE</th>
                            <th>SKILL LEVEL</th>
                            <th>SKILL SCORE</th>
                            <th>ACTIONS</th>
                        </tr>
                    </thead>
                    <tbody id="operatorsBody">
                        <!-- Operators will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Performance Data Tab -->
        <div id="performance" class="tab-content">
            <div class="stats-dashboard">
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-bolt"></i>
                        </div>
                        <div class="stat-change">
                            <i class="fas fa-arrow-up"></i>
                            5%
                        </div>
                    </div>
                    <div class="stat-content">
                        <h3 id="avgEfficiency">0%</h3>
                        <p>Average Efficiency</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-change">
                            <i class="fas fa-arrow-up"></i>
                            3%
                        </div>
                    </div>
                    <div class="stat-content">
                        <h3 id="avgSMV">0.00</h3>
                        <p>Avg. Standard SMV</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-tachometer-alt"></i>
                        </div>
                        <div class="stat-change negative">
                            <i class="fas fa-arrow-down"></i>
                            2%
                        </div>
                    </div>
                    <div class="stat-content">
                        <h3 id="avgWorkingSMV">0.00</h3>
                        <p>Avg. Working SMV</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-cogs"></i>
                        </div>
                        <div class="stat-change">
                            <i class="fas fa-arrow-up"></i>
                            8%
                        </div>
                    </div>
                    <div class="stat-content">
                        <h3 id="totalOperations">0</h3>
                        <p>Total Operations</p>
                    </div>
                </div>
            </div>

            <div class="controls-panel">
                <div class="search-filter">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchPerformance" placeholder="Search by Operator ID, Name or Style...">
                    </div>
                    <div class="filter-options">
                        <select id="perfLineFilter">
                            <option value="">Filter by Line...</option>
                        </select>
                        <select id="dateFilter">
                            <option value="">Filter by Date...</option>
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                        </select>
                    </div>
                </div>
                <div class="action-buttons">
                    <button id="addPerformanceBtn" class="btn btn-primary">
                        <i class="fas fa-plus-circle"></i> Add Performance Record
                    </button>
                    <button id="exportPerformanceBtn" class="btn btn-success">
                        <i class="fas fa-file-excel"></i> Export Performance Data
                    </button>
                    <button id="analyzeBtn" class="btn btn-info">
                        <i class="fas fa-chart-bar"></i> Analyze Performance
                    </button>
                </div>
            </div>

            <div class="table-container">
                <table class="performance-table">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Line No</th>
                            <th>Style No</th>
                            <th>Product Desc</th>
                            <th>Operator ID</th>
                            <th>Operator Name</th>
                            <th>Operation</th>
                            <th>Machine</th>
                            <th>Std SMV</th>
                            <th>Working SMV</th>
                            <th>Efficiency</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="performanceBody">
                        <!-- Performance data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Time Study Tab - UPDATED STOPWATCH -->
        <div id="time-study" class="tab-content">
            <div class="stopwatch-container">
                <h3><i class="fas fa-stopwatch"></i> Time Study & SAM Calculation</h3>
                <p class="subtitle">Record lap times to calculate average time and efficiency</p>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="studyOperatorId">Operator ID *</label>
                        <select id="studyOperatorId" required>
                            <option value="">Select Operator</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="studyLineNo">Line No *</label>
                        <input type="text" id="studyLineNo" required placeholder="e.g., S-22">
                    </div>
                    <div class="form-group">
                        <label for="studyStyleNo">Style No (Running) *</label>
                        <input type="text" id="studyStyleNo" required placeholder="e.g., T-SHIRT-2024">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="studyProductDesc">Product Description *</label>
                        <input type="text" id="studyProductDesc" required placeholder="e.g., Men's Cotton T-Shirt">
                    </div>
                    <div class="form-group">
                        <label for="studyOperation">Operation Name *</label>
                        <input type="text" id="studyOperation" required placeholder="e.g., Hemming">
                    </div>
                    <div class="form-group">
                        <label for="studyMachine">Machine Name *</label>
                        <select id="studyMachine" required>
                            <option value="">Select Machine</option>
                            <option value="BARTACK">BARTACK</option>
                            <option value="BUTTON ATTACH">BUTTON ATTACH</option>
                            <option value="BUTTONHOLE">BUTTONHOLE</option>
                            <option value="DNLS">DNLS</option>
                            <option value="FLATLOCK">FLATLOCK</option>
                            <option value="FOA">FOA</option>
                            <option value="FS">FS</option>
                            <option value="KANSAI">KANSAI</option>
                            <option value="OVERLOCK">OVERLOCK</option>
                            <option value="SNLS">SNLS</option>
                            <option value="Others">Others</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row" id="customMachineRow" style="display: none;">
                    <div class="form-group">
                        <label for="customMachineName">Custom Machine Name *</label>
                        <input type="text" id="customMachineName" placeholder="Enter custom machine name">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="standardSMV">Standard SMV (Minutes) *</label>
                        <input type="number" id="standardSMV" step="0.01" required placeholder="e.g., 0.45">
                    </div>
                    <div class="form-group">
                        <label for="studyOtherMachines">Other Machines Used</label>
                        <textarea id="studyOtherMachines" placeholder="List other machines the operator has experience with"></textarea>
                    </div>
                </div>
                
                <!-- Image Upload -->
                <div class="form-group image-upload-container">
                    <label>Product Image (Optional)</label>
                    <div class="image-preview" id="imagePreview">
                        <i class="fas fa-image"></i>
                        <img id="previewImage" alt="Preview">
                    </div>
                    <input type="file" id="productImage" accept="image/*" style="display: none;">
                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('productImage').click()">
                        <i class="fas fa-upload"></i> Upload Image
                    </button>
                </div>
                
                <!-- UPDATED: Single Stopwatch with New Lap System -->
                <h4 style="margin-top: 30px; margin-bottom: 20px; color: var(--text-primary);">Cycle Time Measurement</h4>
                <div class="cycle-options">
                    <label>
                        <input type="radio" name="cycleCount" value="3" checked> 3 Cycles
                    </label>
                    <label>
                        <input type="radio" name="cycleCount" value="5"> 5 Cycles
                    </label>
                </div>
                
                <div class="single-stopwatch">
                    <!-- Updated Stopwatch Display -->
                    <div class="stopwatch-display-container">
                        <div class="stopwatch-main" id="stopwatchDisplay">00:00:00.000</div>
                        <div class="stopwatch-lap" id="lapDisplay">Lap: 00:00:00.000</div>
                    </div>
                    
                    <div class="stopwatch-controls">
                        <button class="stopwatch-btn stopwatch-btn-start" id="startBtn">
                            <i class="fas fa-play"></i> Start
                        </button>
                        <button class="stopwatch-btn stopwatch-btn-stop" id="stopBtn" disabled>
                            <i class="fas fa-stop"></i> Stop
                        </button>
                        <button class="stopwatch-btn stopwatch-btn-lap" id="lapBtn" disabled>
                            <i class="fas fa-stopwatch"></i> Lap
                        </button>
                        <button class="stopwatch-btn stopwatch-btn-lap" id="resetBtn">
                            <i class="fas fa-redo"></i> Reset
                        </button>
                    </div>
                    
                    <div class="laps-container">
                        <div class="laps-header">
                            <div>Cycle #</div>
                            <div>Time (sec)</div>
                        </div>
                        <div id="lapsList">
                            <!-- Laps will be added here -->
                        </div>
                    </div>
                </div>
                
                <!-- Results -->
                <div class="cycle-results">
                    <h4 style="color: var(--primary-color);"><i class="fas fa-calculator"></i> Calculation Results</h4>
                    <div class="results-grid">
                        <div class="result-item">
                            <div class="result-value" id="avgCycleTime">0.00</div>
                            <div class="result-label">Avg Cycle Time (sec)</div>
                        </div>
                        <div class="result-item">
                            <div class="result-value" id="totalCycleTime">0.00</div>
                            <div class="result-label">Total Time (sec)</div>
                        </div>
                        <div class="result-item">
                            <div class="result-value" id="workingSMVResult">0.00</div>
                            <div class="result-label">Working SMV (min)</div>
                        </div>
                        <div class="result-item">
                            <div class="result-value" id="efficiencyResult">0%</div>
                            <div class="result-label">Efficiency</div>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button id="resetStopwatch" class="btn btn-danger">
                            <i class="fas fa-redo"></i> Reset All
                        </button>
                        <button id="savePerformanceData" class="btn btn-success">
                            <i class="fas fa-save"></i> Save Performance Record
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Legend -->
        <div class="legend">
            <div class="legend-title"><i class="fas fa-info-circle"></i> Skill Score & Efficiency Legend:</div>
            <div class="legend-items">
                <div class="legend-item">
                    <span class="legend-color" style="background-color: #4cc9f0;"></span>
                    <span>Group A Skill Level / Efficiency > 85%</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background-color: #4361ee;"></span>
                    <span>Group B Skill Level / Efficiency 70-85%</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background-color: #f8961e;"></span>
                    <span>Group C Skill Level / Efficiency < 70%</span>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <p> 2024 Sidney Apparels LLC - Manufacturing Excellence</p>
            <p>Advanced Operator Management System | Real-time Performance Tracking</p>
            <div class="footer-stats">
                <div class="footer-stat">
                    <i class="fas fa-database"></i>
                    <span>Data Version: <strong id="dataVersion">3.0.0</strong></span>
                </div>
                <div class="footer-stat">
                    <i class="fas fa-sync-alt"></i>
                    <span>Last Sync: <strong id="lastSync">--:--:--</strong></span>
                </div>
                <div class="footer-stat">
                    <i class="fas fa-shield-alt"></i>
                    <span>Secure Connection: <strong>Active</strong></span>
                </div>
            </div>
        </footer>
    </div>

    <!-- Add Operator Modal -->
    <div id="addOperatorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus"></i> Add New Operator</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <form id="addOperatorForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="newOperatorId">Operator ID *</label>
                            <input type="text" id="newOperatorId" required placeholder="e.g., OP-435264">
                        </div>
                        <div class="form-group">
                            <label for="newOperatorName">Operator Name *</label>
                            <input type="text" id="newOperatorName" required placeholder="Full name">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="newSewLine">Current Sew Line</label>
                            <input type="text" id="newSewLine" placeholder="e.g., S-22, S-23">
                        </div>
                        <div class="form-group">
                            <label for="newSkillLevel">Skill Level</label>
                            <select id="newSkillLevel">
                                <option value="">Select Level</option>
                                <option value="Group A">Group A</option>
                                <option value="Group B">Group B</option>
                                <option value="Group C">Group C</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary close-modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Operator</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Skill Score Modal -->
    <div id="editCellModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> Edit Operator Details</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="edit-info">
                    <p><strong>Operator ID:</strong> <span id="editOperatorId"></span></p>
                    <p><strong>Operator Name:</strong> <span id="editOperatorName"></span></p>
                </div>
                <form id="editCellForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editSewLine">Current Sew Line</label>
                            <input type="text" id="editSewLine" placeholder="e.g., S-22, S-23">
                        </div>
                        <div class="form-group">
                            <label for="editSkillLevel">Skill Level</label>
                            <select id="editSkillLevel">
                                <option value="Group A">Group A</option>
                                <option value="Group B">Group B</option>
                                <option value="Group C">Group C</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editSkillScore">Skill Score (0.0 - 1.0)</label>
                        <input type="number" id="editSkillScore" min="0" max="1" step="0.05" required placeholder="e.g., 0.85">
                        <div class="score-slider">
                            <input type="range" id="scoreSlider" min="0" max="100" value="0">
                            <div class="slider-labels">
                                <span>0.0</span>
                                <span>0.5</span>
                                <span>1.0</span>
                            </div>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary close-modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Performance Modal -->
    <div id="addPerformanceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-chart-line"></i> Add Performance Record</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <form id="addPerformanceForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="perfOperatorId">Operator ID *</label>
                            <select id="perfOperatorId" required>
                                <option value="">Select Operator</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="perfLineNo">Line No *</label>
                            <input type="text" id="perfLineNo" required placeholder="e.g., S-22">
                        </div>
                        <div class="form-group">
                            <label for="perfStyleNo">Style No *</label>
                            <input type="text" id="perfStyleNo" required placeholder="e.g., T-SHIRT-2024">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="perfProductDesc">Product Description *</label>
                            <input type="text" id="perfProductDesc" required placeholder="e.g., Men's Cotton T-Shirt">
                        </div>
                        <div class="form-group">
                            <label for="perfOperation">Operation Name *</label>
                            <input type="text" id="perfOperation" required placeholder="e.g., Hemming">
                        </div>
                        <div class="form-group">
                            <label for="perfMachine">Machine Name *</label>
                            <select id="perfMachine" required>
                                <option value="">Select Machine</option>
                                <option value="BARTACK">BARTACK</option>
                                <option value="BUTTON ATTACH">BUTTON ATTACH</option>
                                <option value="BUTTONHOLE">BUTTONHOLE</option>
                                <option value="DNLS">DNLS</option>
                                <option value="FLATLOCK">FLATLOCK</option>
                                <option value="FOA">FOA</option>
                                <option value="FS">FS</option>
                                <option value="KANSAI">KANSAI</option>
                                <option value="OVERLOCK">OVERLOCK</option>
                                <option value="SNLS">SNLS</option>
                                <option value="Others">Others</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row" id="perfCustomMachineRow" style="display: none;">
                        <div class="form-group">
                            <label for="perfCustomMachineName">Custom Machine Name *</label>
                            <input type="text" id="perfCustomMachineName" placeholder="Enter custom machine name">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="perfStdSMV">Standard SMV (min) *</label>
                            <input type="number" id="perfStdSMV" step="0.01" required placeholder="e.g., 0.45">
                        </div>
                        <div class="form-group">
                            <label for="perfWorkingSMV">Operator Working SMV (min) *</label>
                            <input type="number" id="perfWorkingSMV" step="0.01" required placeholder="e.g., 0.52">
                        </div>
                        <div class="form-group">
                            <label for="perfOtherMachines">Other Machines Used</label>
                            <textarea id="perfOtherMachines" placeholder="List other machines the operator has experience with"></textarea>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Cycle Times (seconds)</label>
                            <div id="manualCycleTimes">
                                <!-- Manual cycle times will be added here -->
                            </div>
                            <button type="button" class="btn btn-secondary" id="addCycleTimeBtn">
                                <i class="fas fa-plus"></i> Add Cycle Time
                            </button>
                        </div>
                    </div>
                    <div class="form-group image-upload-container">
                        <label>Product Image (Optional)</label>
                        <div class="image-preview" id="perfImagePreview">
                            <i class="fas fa-image"></i>
                            <img id="perfPreviewImage" alt="Preview">
                        </div>
                        <input type="file" id="perfProductImage" accept="image/*" style="display: none;">
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('perfProductImage').click()">
                            <i class="fas fa-upload"></i> Upload Image
                        </button>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary close-modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Performance Data</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- NEW: Analysis Modal -->
    <div id="analysisModal" class="modal">
        <div class="modal-content analysis-modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-chart-bar"></i> Performance Analysis</h3>
                <span class="close-modal" onclick="closeAnalysisModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="analysis-tabs">
                    <button class="analysis-tab-btn active" data-analysis-tab="overview">Overview</button>
                    <button class="analysis-tab-btn" data-analysis-tab="efficiency">Efficiency Analysis</button>
                    <button class="analysis-tab-btn" data-analysis-tab="operator">Operator Performance</button>
                    <button class="analysis-tab-btn" data-analysis-tab="line">Line Performance</button>
                </div>
                
                <div id="analysisOverview" class="analysis-tab-content active">
                    <div class="analysis-charts-grid">
                        <div class="chart-container">
                            <h4><i class="fas fa-chart-pie"></i> Efficiency Distribution</h4>
                            <canvas id="efficiencyDistributionChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h4><i class="fas fa-chart-line"></i> Weekly Performance Trend</h4>
                            <canvas id="weeklyTrendChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h4><i class="fas fa-users"></i> Top 10 Operators</h4>
                            <canvas id="topOperatorsChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h4><i class="fas fa-cogs"></i> Machine Performance</h4>
                            <canvas id="machinePerformanceChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="analysis-summary">
                        <div class="summary-card">
                            <h4>Overall Efficiency</h4>
                            <div class="summary-value" id="analysisOverallEfficiency">0%</div>
                            <div id="efficiencyChange">vs last week: 0%</div>
                        </div>
                        <div class="summary-card">
                            <h4>Best Performing Line</h4>
                            <div class="summary-value" id="bestLine">-</div>
                            <div id="bestLineEfficiency">Efficiency: 0%</div>
                        </div>
                        <div class="summary-card">
                            <h4>Most Efficient Operator</h4>
                            <div class="summary-value" id="bestOperator">-</div>
                            <div id="bestOperatorEfficiency">Avg: 0%</div>
                        </div>
                        <div class="summary-card">
                            <h4>Total Output</h4>
                            <div class="summary-value" id="totalOutput">0</div>
                            <div>operations recorded</div>
                        </div>
                    </div>
                </div>
                
                <div id="analysisEfficiency" class="analysis-tab-content">
                    <div class="analysis-charts-grid">
                        <div class="chart-container">
                            <h4><i class="fas fa-chart-bar"></i> Efficiency by Machine Type</h4>
                            <canvas id="efficiencyByMachineChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h4><i class="fas fa-calendar-alt"></i> Daily Efficiency Trend</h4>
                            <canvas id="dailyEfficiencyChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div id="analysisOperator" class="analysis-tab-content">
                    <div class="chart-container">
                        <h4><i class="fas fa-trophy"></i> Operator Rankings</h4>
                        <canvas id="operatorRankingsChart"></canvas>
                    </div>
                </div>
                
                <div id="analysisLine" class="analysis-tab-content">
                    <div class="chart-container">
                        <h4><i class="fas fa-industry"></i> Line-wise Performance</h4>
                        <canvas id="linePerformanceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW: Cycle Times Detail Modal -->
    <div id="cycleDetailModal" class="modal">
        <div class="modal-content cycle-detail-modal">
            <div class="modal-header">
                <h3><i class="fas fa-calculator"></i> Cycle Time Details</h3>
                <span class="close-modal" onclick="closeCycleDetailModal()">&times;</span>
            </div>
            <div class="modal-body cycle-detail-content">
                <div class="cycle-info">
                    <h4 style="margin-bottom: 15px;">Performance Details</h4>
                    <div class="cycle-info-item">
                        <span>Operator:</span>
                        <span id="detailOperatorName">-</span>
                    </div>
                    <div class="cycle-info-item">
                        <span>Operation:</span>
                        <span id="detailOperation">-</span>
                    </div>
                    <div class="cycle-info-item">
                        <span>Standard SMV:</span>
                        <span id="detailStdSMV">0.00 min</span>
                    </div>
                    <div class="cycle-info-item">
                        <span>Working SMV:</span>
                        <span id="detailWorkingSMV">0.00 min</span>
                    </div>
                    <div class="cycle-info-item">
                        <span>Efficiency:</span>
                        <span id="detailEfficiency">0%</span>
                    </div>
                </div>
                
                <h4>Cycle Times (seconds)</h4>
                <div class="cycle-times-list" id="cycleTimesList">
                    <!-- Cycle times will be listed here -->
                </div>
                
                <div class="calculation-steps">
                    <h4>Calculation Breakdown</h4>
                    <div class="calculation-step">
                        <h5>1. Average Cycle Time</h5>
                        <div class="calculation-formula" id="avgCycleTimeFormula">
                            Sum of all cycle times  Number of cycles
                        </div>
                        <div id="avgCycleTimeCalc">Calculating...</div>
                    </div>
                    <div class="calculation-step">
                        <h5>2. Working SMV (Minutes)</h5>
                        <div class="calculation-formula">
                            Average cycle time (seconds)  60
                        </div>
                        <div id="workingSMVCalc">Calculating...</div>
                    </div>
                    <div class="calculation-step">
                        <h5>3. Efficiency</h5>
                        <div class="calculation-formula">
                            (Standard SMV  Working SMV)  100
                        </div>
                        <div id="efficiencyCalc">Calculating...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="notificationToast" class="toast">
        <div class="toast-content">
            <i class="fas fa-check-circle"></i>
            <span id="toastMessage">Operation completed successfully!</span>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDocs, updateDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp, Timestamp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-storage.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD-kUUKaIP5h6uXCiSYYCePf0pWmf6QcwY",
            authDomain: "skill-matrix-3be5a.firebaseapp.com",
            projectId: "skill-matrix-3be5a",
            storageBucket: "skill-matrix-3be5a.firebasestorage.app",
            messagingSenderId: "614498722664",
            appId: "1:614498722664:web:e2a602f71b0ecb59c4acdd",
            measurementId: "G-60LG5FH4WB"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Application state
        let operators = [];
        let performanceData = [];
        let selectedOperatorId = null;
        let currentImageFile = null;
        let currentPerfImageFile = null;

        // UPDATED: Stopwatch variables for new lap system
        let stopwatchRunning = false;
        let stopwatchStartTime = 0;
        let stopwatchTotalElapsed = 0;
        let lapStartTime = 0;
        let lapElapsed = 0;
        let lapCounter = 0;
        let lapTimes = [];
        let stopwatchInterval = null;
        let cycleCount = 3;

        // Analysis charts
        let efficiencyDistributionChart = null;
        let weeklyTrendChart = null;
        let topOperatorsChart = null;
        let machinePerformanceChart = null;
        let efficiencyByMachineChart = null;
        let dailyEfficiencyChart = null;
        let operatorRankingsChart = null;
        let linePerformanceChart = null;

        // DOM Elements
        const elements = {
            loadingOverlay: document.getElementById('loadingOverlay'),
            lastUpdated: document.getElementById('lastUpdated'),
            lastSync: document.getElementById('lastSync'),
            dataVersion: document.getElementById('dataVersion'),
            totalOperators: document.getElementById('totalOperators'),
            avgSkillScore: document.getElementById('avgSkillScore'),
            totalSkills: document.getElementById('totalSkills'),
            groupACount: document.getElementById('groupACount'),
            groupBCount: document.getElementById('groupBCount'),
            groupCCount: document.getElementById('groupCCount'),
            avgEfficiency: document.getElementById('avgEfficiency'),
            avgSMV: document.getElementById('avgSMV'),
            avgWorkingSMV: document.getElementById('avgWorkingSMV'),
            totalOperations: document.getElementById('totalOperations'),
            searchInput: document.getElementById('searchInput'),
            skillFilter: document.getElementById('skillFilter'),
            lineFilter: document.getElementById('lineFilter'),
            operatorsBody: document.getElementById('operatorsBody'),
            performanceBody: document.getElementById('performanceBody'),
            notificationToast: document.getElementById('notificationToast'),
            toastMessage: document.getElementById('toastMessage'),
            stopwatchDisplay: document.getElementById('stopwatchDisplay'),
            lapDisplay: document.getElementById('lapDisplay'),
            lapsList: document.getElementById('lapsList')
        };

        // Initialize application
        document.addEventListener('DOMContentLoaded', async () => {
            await loadData();
            setupEventListeners();
            setupTabs();
            updateLastUpdated();
            
            // Simulate loading animation
            setTimeout(() => {
                elements.loadingOverlay.style.display = 'none';
            }, 1500);
        });

        // Setup tabs
        function setupTabs() {
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const tabId = btn.getAttribute('data-tab');
                    
                    // Update active tab button
                    tabBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    // Show active tab content
                    tabContents.forEach(content => {
                        content.classList.remove('active');
                        if (content.id === tabId) {
                            content.classList.add('active');
                        }
                    });
                });
            });
            
            // Setup analysis tabs
            const analysisTabs = document.querySelectorAll('.analysis-tab-btn');
            analysisTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-analysis-tab');
                    
                    // Update active tab
                    analysisTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Show active content
                    document.querySelectorAll('.analysis-tab-content').forEach(content => {
                        content.style.display = 'none';
                    });
                    
                    const activeContent = document.getElementById('analysis' + tabId.charAt(0).toUpperCase() + tabId.slice(1));
                    if (activeContent) {
                        activeContent.style.display = 'block';
                    }
                });
            });
        }

        // UPDATED: Stopwatch functions with new lap system
        function formatTime(milliseconds) {
            const totalSeconds = milliseconds / 1000;
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = Math.floor(totalSeconds % 60);
            const ms = Math.floor((milliseconds % 1000) / 10);
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}.${ms.toString().padStart(2, '0')}`;
        }

        function startStopwatch() {
            if (!stopwatchRunning) {
                const now = Date.now();
                stopwatchStartTime = now - stopwatchTotalElapsed;
                lapStartTime = now - lapElapsed;
                
                stopwatchInterval = setInterval(() => {
                    const currentTime = Date.now();
                    stopwatchTotalElapsed = currentTime - stopwatchStartTime;
                    lapElapsed = currentTime - lapStartTime;
                    
                    elements.stopwatchDisplay.textContent = formatTime(stopwatchTotalElapsed);
                    elements.lapDisplay.textContent = `Lap: ${formatTime(lapElapsed)}`;
                }, 10);
                
                stopwatchRunning = true;
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('lapBtn').disabled = false;
                document.getElementById('resetBtn').disabled = true;
            }
        }

        function stopStopwatch() {
            if (stopwatchRunning) {
                clearInterval(stopwatchInterval);
                stopwatchRunning = false;
                document.getElementById('stopBtn').disabled = true;
                document.getElementById('lapBtn').disabled = true;
                document.getElementById('startBtn').disabled = false;
                document.getElementById('resetBtn').disabled = false;
                
                // Record final lap if we have a lap in progress
                if (lapElapsed > 0 && lapCounter < cycleCount) {
                    recordLap();
                }
            }
        }

        function recordLap() {
            if (lapCounter < cycleCount) {
                lapCounter++;
                const lapTimeSeconds = lapElapsed / 1000;
                lapTimes.push(lapTimeSeconds);
                
                // Add lap to display
                const lapItem = document.createElement('div');
                lapItem.className = 'lap-item';
                lapItem.innerHTML = `
                    <div class="lap-number">Cycle ${lapCounter}</div>
                    <div class="lap-time">${lapTimeSeconds.toFixed(3)} sec</div>
                `;
                elements.lapsList.appendChild(lapItem);
                
                // Reset lap timer for next lap
                lapStartTime = Date.now();
                lapElapsed = 0;
                elements.lapDisplay.textContent = 'Lap: 00:00:00.00';
                
                // Check if we've reached the maximum cycles
                if (lapCounter >= cycleCount) {
                    stopStopwatch();
                    calculateResults();
                }
            }
        }

        function resetStopwatch() {
            clearInterval(stopwatchInterval);
            stopwatchRunning = false;
            stopwatchTotalElapsed = 0;
            lapElapsed = 0;
            lapCounter = 0;
            lapTimes = [];
            
            elements.stopwatchDisplay.textContent = '00:00:00.000';
            elements.lapDisplay.textContent = 'Lap: 00:00:00.000';
            elements.lapsList.innerHTML = '';
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('lapBtn').disabled = true;
            document.getElementById('resetBtn').disabled = true;
            
            document.getElementById('avgCycleTime').textContent = '0.00';
            document.getElementById('totalCycleTime').textContent = '0.00';
            document.getElementById('workingSMVResult').textContent = '0.00';
            document.getElementById('efficiencyResult').textContent = '0%';
        }

        // Calculate results from lap times
        function calculateResults() {
            if (lapTimes.length === 0) return;
            
            const totalTime = lapTimes.reduce((a, b) => a + b, 0);
            const avgTime = totalTime / lapTimes.length;
            const workingSMV = avgTime / 60; // Convert seconds to minutes
            const standardSMV = parseFloat(document.getElementById('standardSMV').value) || 0;
            const efficiency = standardSMV > 0 ? (standardSMV / workingSMV) * 100 : 0;
            
            document.getElementById('avgCycleTime').textContent = avgTime.toFixed(2);
            document.getElementById('totalCycleTime').textContent = totalTime.toFixed(2);
            document.getElementById('workingSMVResult').textContent = workingSMV.toFixed(2);
            document.getElementById('efficiencyResult').textContent = efficiency.toFixed(1) + '%';
            
            // Color code efficiency
            const efficiencyElem = document.getElementById('efficiencyResult');
            efficiencyElem.className = 'result-value ';
            if (efficiency >= 85) {
                efficiencyElem.classList.add('efficiency-high');
            } else if (efficiency >= 70) {
                efficiencyElem.classList.add('efficiency-medium');
            } else {
                efficiencyElem.classList.add('efficiency-low');
            }
        }

        // Load data from Firestore
        async function loadData() {
            try {
                // Load operators with real-time updates
                const operatorsQuery = query(collection(db, 'operators'), orderBy('operatorId'));
                onSnapshot(operatorsQuery, (snapshot) => {
                    operators = [];
                    snapshot.forEach(doc => {
                        operators.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    renderOperatorsTable();
                    updateStats();
                    populateOperatorDropdowns();
                    populateLineFilter();
                    
                    // Update sync time
                    const now = new Date();
                    elements.lastSync.textContent = now.toLocaleTimeString('en-US', {
                        hour12: true,
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                    
                    showToast(`${operators.length} operators loaded successfully!`);
                });
                
                // Load performance data
                const performanceQuery = query(collection(db, 'performance'), orderBy('timestamp', 'desc'));
                onSnapshot(performanceQuery, (snapshot) => {
                    performanceData = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        performanceData.push({
                            id: doc.id,
                            ...data,
                            timestamp: data.timestamp?.toDate() || new Date()
                        });
                    });
                    renderPerformanceTable();
                    updatePerformanceStats();
                });
            } catch (error) {
                console.error('Error loading data:', error);
                showToast('Error loading data: ' + error.message, 'error');
                elements.loadingOverlay.style.display = 'none';
            }
        }

        // Populate operator dropdowns
        function populateOperatorDropdowns() {
            const studyOperatorId = document.getElementById('studyOperatorId');
            const perfOperatorId = document.getElementById('perfOperatorId');
            
            // Clear existing options except the first one
            studyOperatorId.innerHTML = '<option value="">Select Operator</option>';
            perfOperatorId.innerHTML = '<option value="">Select Operator</option>';
            
            operators.forEach(operator => {
                const option1 = document.createElement('option');
                option1.value = operator.operatorId;
                option1.textContent = `${operator.operatorId} - ${operator.name}`;
                studyOperatorId.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = operator.operatorId;
                option2.textContent = `${operator.operatorId} - ${operator.name}`;
                perfOperatorId.appendChild(option2);
            });
        }

        // Populate line filter
        function populateLineFilter() {
            const lineFilter = document.getElementById('lineFilter');
            const perfLineFilter = document.getElementById('perfLineFilter');
            const sewLines = new Set();
            
            // Clear and add default option
            lineFilter.innerHTML = '<option value="">Filter by Sew Line...</option>';
            perfLineFilter.innerHTML = '<option value="">Filter by Line...</option>';
            
            // Collect unique sew lines
            operators.forEach(operator => {
                if (operator.sewLine) {
                    sewLines.add(operator.sewLine);
                }
            });
            
            performanceData.forEach(record => {
                if (record.lineNo) {
                    sewLines.add(record.lineNo);
                }
            });
            
            // Add options
            sewLines.forEach(line => {
                const option1 = document.createElement('option');
                option1.value = line;
                option1.textContent = line;
                lineFilter.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = line;
                option2.textContent = line;
                perfLineFilter.appendChild(option2);
            });
        }

        // Render operators table
        function renderOperatorsTable(filteredData = operators) {
            elements.operatorsBody.innerHTML = '';
            
            if (filteredData.length === 0) {
                elements.operatorsBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px;">
                            <i class="fas fa-users" style="font-size: 3rem; color: var(--text-secondary); margin-bottom: 15px; display: block;"></i>
                            <h3 style="color: var(--text-secondary); margin-bottom: 10px;">No Operators Found</h3>
                            <p style="color: var(--text-secondary);">Add your first operator to get started</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            filteredData.forEach(operator => {
                // Calculate skill level based on performance
                const skillLevel = calculateSkillLevel(operator.operatorId);
                const skillClass = `skill-group-${skillLevel.charAt(skillLevel.length - 1).toLowerCase()}`;
                
                // Calculate skill score if exists
                let skillScore = 0;
                if (operator.skills) {
                    const scores = Object.values(operator.skills).filter(s => s !== null && s !== undefined);
                    if (scores.length > 0) {
                        skillScore = scores.reduce((a, b) => a + b, 0) / scores.length;
                    }
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="operator-id">${operator.operatorId || ''}</td>
                    <td>${operator.name || ''}</td>
                    <td>${operator.sewLine || '-'}</td>
                    <td>
                        ${skillLevel ?
                            `<span class="skill-level ${skillClass}">${skillLevel}</span>` :
                            '-'
                        }
                    </td>
                    <td>${skillScore > 0 ? skillScore.toFixed(2) : '-'}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-icon edit-operator" data-id="${operator.operatorId}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-icon delete-operator" data-id="${operator.operatorId}">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button class="btn-icon view-details" data-id="${operator.operatorId}">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </td>
                `;
                elements.operatorsBody.appendChild(row);
            });
            
            // Add event listeners for action buttons
            document.querySelectorAll('.edit-operator').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const operatorId = e.target.closest('button').getAttribute('data-id');
                    openEditModal(operatorId);
                });
            });
            
            document.querySelectorAll('.delete-operator').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const operatorId = e.target.closest('button').getAttribute('data-id');
                    deleteOperator(operatorId);
                });
            });
            
            document.querySelectorAll('.view-details').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const operatorId = e.target.closest('button').getAttribute('data-id');
                    viewOperatorDetails(operatorId);
                });
            });
        }

        // Calculate skill level based on performance
        function calculateSkillLevel(operatorId) {
            const operatorPerformances = performanceData.filter(p => p.operatorId === operatorId);
            if (operatorPerformances.length === 0) return 'Group C';
            
            let highEfficiencyCount = 0;
            let totalEfficiency = 0;
            
            operatorPerformances.forEach(perf => {
                if (perf.efficiency >= 85) {
                    highEfficiencyCount++;
                }
                totalEfficiency += perf.efficiency || 0;
            });
            
            const avgEfficiency = totalEfficiency / operatorPerformances.length;
            
            if (avgEfficiency >= 85 || highEfficiencyCount >= 3) {
                return 'Group A';
            } else if (avgEfficiency >= 70 || highEfficiencyCount >= 2) {
                return 'Group B';
            } else {
                return 'Group C';
            }
        }

        // UPDATED: Update statistics with group counts
        function updateStats() {
            const totalOps = operators.length;
            let totalScore = 0;
            let scoreCount = 0;
            
            // Count operators by group
            let groupACount = 0;
            let groupBCount = 0;
            let groupCCount = 0;
            
            operators.forEach(operator => {
                const skillLevel = calculateSkillLevel(operator.operatorId);
                
                if (skillLevel === 'Group A') groupACount++;
                else if (skillLevel === 'Group B') groupBCount++;
                else if (skillLevel === 'Group C') groupCCount++;
                
                if (operator.skillScore) {
                    totalScore += operator.skillScore;
                    scoreCount++;
                }
            });
            
            elements.totalOperators.textContent = totalOps;
            elements.avgSkillScore.textContent = scoreCount > 0 ? (totalScore / scoreCount).toFixed(2) : '0.00';
            elements.totalSkills.textContent = scoreCount;
            
            // Update group counts
            elements.groupACount.textContent = groupACount;
            elements.groupBCount.textContent = groupBCount;
            elements.groupCCount.textContent = groupCCount;
        }

        // UPDATED: Render performance table with clickable Working SMV
        function renderPerformanceTable(filteredData = performanceData) {
            elements.performanceBody.innerHTML = '';
            
            filteredData.forEach(record => {
                const formattedDate = record.timestamp ? record.timestamp.toLocaleString() : 'N/A';
                const efficiency = record.efficiency || 0;
                const efficiencyClass = efficiency >= 85 ? 'efficiency-high' :
                                      efficiency >= 70 ? 'efficiency-medium' : 'efficiency-low';
                
                // Get machine name
                let machineName = record.machineName || '-';
                if (record.machineName === 'Others' && record.customMachineName) {
                    machineName = record.customMachineName;
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formattedDate}</td>
                    <td>${record.lineNo || '-'}</td>
                    <td>${record.styleNo || '-'}</td>
                    <td>${record.productDesc || '-'}</td>
                    <td>${record.operatorId || '-'}</td>
                    <td>${record.operatorName || '-'}</td>
                    <td>${record.operation || '-'}</td>
                    <td>${machineName}</td>
                    <td>${record.standardSMV ? record.standardSMV.toFixed(2) : '-'}</td>
                    <td class="working-smv-cell">
                        <button class="working-smv-btn" data-id="${record.id}">
                            ${record.workingSMV ? record.workingSMV.toFixed(2) : '0.00'}
                        </button>
                    </td>
                    <td class="${efficiencyClass}">${efficiency ? efficiency.toFixed(1) + '%' : '-'}</td>
                    <td>
                        <button class="btn-icon view-image-btn" data-image="${record.imageUrl || ''}">
                            <i class="fas fa-image"></i>
                        </button>
                        <button class="btn-icon delete-perf-btn" data-id="${record.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                elements.performanceBody.appendChild(row);
            });
            
            // Add event listeners for Working SMV buttons
            document.querySelectorAll('.working-smv-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const recordId = e.target.closest('button').getAttribute('data-id');
                    showCycleTimesDetail(recordId);
                });
            });
            
            // Add event listeners for view image and delete buttons
            document.querySelectorAll('.view-image-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const imageUrl = e.target.closest('button').getAttribute('data-image');
                    if (imageUrl) {
                        window.open(imageUrl, '_blank');
                    }
                });
            });
            
            document.querySelectorAll('.delete-perf-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const id = e.target.closest('button').getAttribute('data-id');
                    if (confirm('Are you sure you want to delete this performance record?')) {
                        await deletePerformanceRecord(id);
                    }
                });
            });
        }

        // Update performance statistics
        function updatePerformanceStats() {
            const totalOps = performanceData.length;
            if (totalOps === 0) {
                elements.avgEfficiency.textContent = '0%';
                elements.avgSMV.textContent = '0.00';
                elements.avgWorkingSMV.textContent = '0.00';
                elements.totalOperations.textContent = '0';
                return;
            }
            
            const totalEfficiency = performanceData.reduce((sum, record) => sum + (record.efficiency || 0), 0);
            const totalStdSMV = performanceData.reduce((sum, record) => sum + (record.standardSMV || 0), 0);
            const totalWorkingSMV = performanceData.reduce((sum, record) => sum + (record.workingSMV || 0), 0);
            
            elements.avgEfficiency.textContent = (totalEfficiency / totalOps).toFixed(1) + '%';
            elements.avgSMV.textContent = (totalStdSMV / totalOps).toFixed(2);
            elements.avgWorkingSMV.textContent = (totalWorkingSMV / totalOps).toFixed(2);
            elements.totalOperations.textContent = totalOps;
        }

        // Open edit modal
        function openEditModal(operatorId) {
            const operator = operators.find(op => op.operatorId === operatorId);
            if (!operator) {
                showToast('Operator not found!', 'error');
                return;
            }
            
            selectedOperatorId = operatorId;
            document.getElementById('editOperatorId').textContent = operatorId;
            document.getElementById('editOperatorName').textContent = operator.name || '';
            document.getElementById('editSewLine').value = operator.sewLine || '';
            
            // Calculate skill level based on efficiency
            const skillLevel = calculateSkillLevel(operatorId);
            document.getElementById('editSkillLevel').value = skillLevel;
            
            // Set skill score if exists
            let skillScore = 0;
            if (operator.skills) {
                const scores = Object.values(operator.skills).filter(s => s !== null && s !== undefined);
                if (scores.length > 0) {
                    skillScore = scores.reduce((a, b) => a + b, 0) / scores.length;
                }
            }
            
            document.getElementById('editSkillScore').value = skillScore.toFixed(2);
            document.getElementById('scoreSlider').value = Math.round(skillScore * 100);
            
            document.getElementById('editCellModal').classList.add('active');
        }

        // View operator details
        function viewOperatorDetails(operatorId) {
            const operator = operators.find(op => op.operatorId === operatorId);
            if (!operator) {
                showToast('Operator not found!', 'error');
                return;
            }
            
            // Show a toast with details
            showToast(`Operator: ${operator.name} (ID: ${operatorId}) | Line: ${operator.sewLine || 'N/A'} | Skill Level: ${calculateSkillLevel(operatorId)}`);
        }

        // Filter operators
        function filterOperators() {
            let filtered = operators;
            const searchTerm = elements.searchInput.value.toLowerCase();
            
            if (searchTerm) {
                filtered = filtered.filter(operator =>
                    (operator.operatorId && operator.operatorId.toLowerCase().includes(searchTerm)) ||
                    (operator.name && operator.name.toLowerCase().includes(searchTerm)) ||
                    (operator.sewLine && operator.sewLine.toLowerCase().includes(searchTerm))
                );
            }
            
            const skillLevel = elements.skillFilter.value;
            if (skillLevel) {
                filtered = filtered.filter(operator => {
                    const calculatedSkillLevel = calculateSkillLevel(operator.operatorId);
                    return calculatedSkillLevel === skillLevel;
                });
            }
            
            const sewLine = elements.lineFilter.value;
            if (sewLine) {
                filtered = filtered.filter(operator =>
                    operator.sewLine && operator.sewLine.toLowerCase().includes(sewLine.toLowerCase())
                );
            }
            
            renderOperatorsTable(filtered);
        }

        // Filter performance data
        function filterPerformanceData() {
            const searchTerm = document.getElementById('searchPerformance').value.toLowerCase();
            const lineFilter = document.getElementById('perfLineFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;
            
            let filtered = performanceData;
            
            if (searchTerm) {
                filtered = filtered.filter(record =>
                    (record.operatorId && record.operatorId.toLowerCase().includes(searchTerm)) ||
                    (record.operatorName && record.operatorName.toLowerCase().includes(searchTerm)) ||
                    (record.styleNo && record.styleNo.toLowerCase().includes(searchTerm)) ||
                    (record.productDesc && record.productDesc.toLowerCase().includes(searchTerm))
                );
            }
            
            if (lineFilter) {
                filtered = filtered.filter(record => record.lineNo === lineFilter);
            }
            
            if (dateFilter) {
                const now = new Date();
                filtered = filtered.filter(record => {
                    const recordDate = new Date(record.timestamp);
                    switch (dateFilter) {
                        case 'today':
                            return recordDate.toDateString() === now.toDateString();
                        case 'week':
                            const weekStart = new Date(now.setDate(now.getDate() - now.getDay()));
                            return recordDate >= weekStart;
                        case 'month':
                            return recordDate.getMonth() === now.getMonth() &&
                                   recordDate.getFullYear() === now.getFullYear();
                        default:
                            return true;
                    }
                });
            }
            
            renderPerformanceTable(filtered);
        }

        // Save operator
        async function saveOperator(operatorData, isEdit = false) {
            try {
                let result;
                
                if (isEdit) {
                    // Find the operator document
                    const operator = operators.find(op => op.operatorId === selectedOperatorId);
                    if (!operator) {
                        throw new Error('Operator not found');
                    }
                    
                    const operatorRef = doc(db, 'operators', operator.id);
                    
                    // Calculate average skill score from existing skills
                    let skillScore = parseFloat(operatorData.skillScore) || 0;
                    if (skillScore > 0 && skillScore <= 1) {
                        const skills = operator.skills || {};
                        Object.keys(skills).forEach(skill => {
                            skills[skill] = skillScore;
                        });
                        
                        result = await updateDoc(operatorRef, {
                            sewLine: operatorData.sewLine,
                            skillLevel: operatorData.skillLevel,
                            skills: skills,
                            lastUpdated: serverTimestamp()
                        });
                    } else {
                        result = await updateDoc(operatorRef, {
                            sewLine: operatorData.sewLine,
                            skillLevel: operatorData.skillLevel,
                            lastUpdated: serverTimestamp()
                        });
                    }
                    
                    showToast('Operator updated successfully!');
                } else {
                    // Check if operator ID already exists
                    const existingOperator = operators.find(op => op.operatorId === operatorData.operatorId);
                    if (existingOperator) {
                        throw new Error('Operator ID already exists!');
                    }
                    
                    const docRef = doc(collection(db, 'operators'));
                    result = await setDoc(docRef, {
                        operatorId: operatorData.operatorId,
                        name: operatorData.name,
                        sewLine: operatorData.sewLine || null,
                        skillLevel: operatorData.skillLevel || null,
                        skills: {},
                        createdAt: serverTimestamp(),
                        lastUpdated: serverTimestamp()
                    });
                    
                    showToast('Operator added successfully!');
                }
                
                return true;
            } catch (error) {
                console.error('Error saving operator:', error);
                showToast('Error: ' + error.message, 'error');
                return false;
            }
        }

        // Delete operator
        async function deleteOperator(operatorId) {
            if (!confirm(`Are you sure you want to delete operator ${operatorId}?`)) {
                return;
            }
            
            try {
                const operator = operators.find(op => op.operatorId === operatorId);
                if (!operator) {
                    throw new Error('Operator not found');
                }
                
                await deleteDoc(doc(db, 'operators', operator.id));
                showToast('Operator deleted successfully!');
            } catch (error) {
                console.error('Error deleting operator:', error);
                showToast('Error deleting operator: ' + error.message, 'error');
            }
        }

        // Save performance data from time study
        async function saveTimeStudyData() {
            try {
                const operatorId = document.getElementById('studyOperatorId').value;
                const operator = operators.find(op => op.operatorId === operatorId);
                if (!operator) {
                    showToast('Please select a valid operator', 'error');
                    return false;
                }
                
                if (lapTimes.length === 0) {
                    showToast('Please record at least one cycle time', 'error');
                    return false;
                }
                
                const avgTime = lapTimes.reduce((a, b) => a + b, 0) / lapTimes.length;
                const workingSMV = avgTime / 60;
                const standardSMV = parseFloat(document.getElementById('standardSMV').value);
                
                if (!standardSMV || standardSMV <= 0) {
                    showToast('Please enter a valid Standard SMV', 'error');
                    return false;
                }
                
                const efficiency = (standardSMV / workingSMV) * 100;
                
                // Get machine name
                let machineName = document.getElementById('studyMachine').value;
                let customMachineName = '';
                if (machineName === 'Others') {
                    customMachineName = document.getElementById('customMachineName').value.trim();
                    if (!customMachineName) {
                        showToast('Please enter a custom machine name', 'error');
                        return false;
                    }
                }
                
                // Upload image if exists
                let imageUrl = '';
                if (currentImageFile) {
                    const storageRef = ref(storage, `product_images/${Date.now()}_${currentImageFile.name}`);
                    await uploadBytes(storageRef, currentImageFile);
                    imageUrl = await getDownloadURL(storageRef);
                }
                
                // Save performance record
                const docRef = doc(collection(db, 'performance'));
                await setDoc(docRef, {
                    timestamp: serverTimestamp(),
                    lineNo: document.getElementById('studyLineNo').value,
                    styleNo: document.getElementById('studyStyleNo').value,
                    productDesc: document.getElementById('studyProductDesc').value,
                    operatorId: operatorId,
                    operatorName: operator.name,
                    operation: document.getElementById('studyOperation').value,
                    machineName: machineName,
                    customMachineName: customMachineName,
                    standardSMV: standardSMV,
                    workingSMV: workingSMV,
                    efficiency: efficiency,
                    otherMachines: document.getElementById('studyOtherMachines').value,
                    imageUrl: imageUrl,
                    cycleTimes: lapTimes,
                    avgCycleTime: avgTime
                });
                
                showToast('Performance data saved successfully!');
                resetTimeStudyForm();
                return true;
            } catch (error) {
                console.error('Error saving performance data:', error);
                showToast('Error saving data: ' + error.message, 'error');
                return false;
            }
        }

        // Save manual performance data
        async function saveManualPerformanceData(formData) {
            try {
                const operatorId = formData.operatorId;
                const operator = operators.find(op => op.operatorId === operatorId);
                if (!operator) {
                    showToast('Please select a valid operator', 'error');
                    return false;
                }
                
                // Get cycle times from manual entries
                const cycleTimes = [];
                document.querySelectorAll('.manual-cycle-time').forEach(input => {
                    const value = parseFloat(input.value);
                    if (!isNaN(value)) {
                        cycleTimes.push(value);
                    }
                });
                
                if (cycleTimes.length === 0) {
                    showToast('Please add at least one cycle time', 'error');
                    return false;
                }
                
                const avgTime = cycleTimes.reduce((a, b) => a + b, 0) / cycleTimes.length;
                const workingSMV = avgTime / 60;
                
                // Get machine name
                let machineName = document.getElementById('perfMachine').value;
                let customMachineName = '';
                if (machineName === 'Others') {
                    customMachineName = document.getElementById('perfCustomMachineName').value.trim();
                    if (!customMachineName) {
                        showToast('Please enter a custom machine name', 'error');
                        return false;
                    }
                }
                
                // Upload image if exists
                let imageUrl = '';
                if (currentPerfImageFile) {
                    const storageRef = ref(storage, `product_images/${Date.now()}_${currentPerfImageFile.name}`);
                    await uploadBytes(storageRef, currentPerfImageFile);
                    imageUrl = await getDownloadURL(storageRef);
                }
                
                // Calculate efficiency
                const efficiency = formData.standardSMV > 0 ?
                    (formData.standardSMV / workingSMV) * 100 : 0;
                
                // Save performance record
                const docRef = doc(collection(db, 'performance'));
                await setDoc(docRef, {
                    timestamp: serverTimestamp(),
                    lineNo: formData.lineNo,
                    styleNo: formData.styleNo,
                    productDesc: formData.productDesc,
                    operatorId: operatorId,
                    operatorName: operator.name,
                    operation: formData.operation,
                    machineName: machineName,
                    customMachineName: customMachineName,
                    standardSMV: formData.standardSMV,
                    workingSMV: workingSMV,
                    efficiency: efficiency,
                    otherMachines: formData.otherMachines,
                    imageUrl: imageUrl,
                    cycleTimes: cycleTimes,
                    avgCycleTime: avgTime
                });
                
                showToast('Performance data saved successfully!');
                return true;
            } catch (error) {
                console.error('Error saving performance data:', error);
                showToast('Error saving data: ' + error.message, 'error');
                return false;
            }
        }

        // Delete performance record
        async function deletePerformanceRecord(id) {
            try {
                await deleteDoc(doc(db, 'performance', id));
                showToast('Performance record deleted successfully!');
            } catch (error) {
                console.error('Error deleting record:', error);
                showToast('Error deleting record: ' + error.message, 'error');
            }
        }

        // Export to Excel
        function exportToExcel(type = 'operators') {
            try {
                let data = [];
                let filename = '';
                
                if (type === 'operators') {
                    operators.forEach(operator => {
                        // Calculate skill score if exists
                        let skillScore = 0;
                        if (operator.skills) {
                            const scores = Object.values(operator.skills).filter(s => s !== null && s !== undefined);
                            if (scores.length > 0) {
                                skillScore = scores.reduce((a, b) => a + b, 0) / scores.length;
                            }
                        }
                        
                        const skillLevel = calculateSkillLevel(operator.operatorId);
                        
                        data.push({
                            'Operator ID': operator.operatorId,
                            'Operator Name': operator.name,
                            'Current Sew Line': operator.sewLine || '',
                            'Skill Level': skillLevel,
                            'Average Skill Score': skillScore > 0 ? skillScore.toFixed(2) : ''
                        });
                    });
                    
                    filename = `Operators_List_${new Date().toISOString().split('T')[0]}.xlsx`;
                } else {
                    performanceData.forEach(record => {
                        // Get machine name
                        let machineName = record.machineName || '-';
                        if (record.machineName === 'Others' && record.customMachineName) {
                            machineName = record.customMachineName;
                        }
                        
                        // Format cycle times
                        let cycleTimesStr = '';
                        if (record.cycleTimes && Array.isArray(record.cycleTimes)) {
                            cycleTimesStr = record.cycleTimes.map((time, i) => `Cycle ${i+1}: ${time.toFixed(3)} sec`).join('; ');
                        }
                        
                        const row = {
                            'Timestamp': record.timestamp.toLocaleString(),
                            'Line No': record.lineNo || '',
                            'Style No': record.styleNo || '',
                            'Product Description': record.productDesc || '',
                            'Operator ID': record.operatorId || '',
                            'Operator Name': record.operatorName || '',
                            'Operation': record.operation || '',
                            'Machine Name': machineName,
                            'Standard SMV': record.standardSMV || '',
                            'Working SMV': record.workingSMV || '',
                            'Cycle Times': cycleTimesStr,
                            'Efficiency': record.efficiency ? record.efficiency.toFixed(1) + '%' : '',
                            'Other Machines': record.otherMachines || ''
                        };
                        data.push(row);
                    });
                    
                    filename = `Performance_Data_${new Date().toISOString().split('T')[0]}.xlsx`;
                }
                
                const worksheet = XLSX.utils.json_to_sheet(data);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, type === 'operators' ? 'Operators' : 'Performance');
                
                // Auto-size columns
                const maxWidth = data.reduce((w, r) => Math.max(w, r['Operator ID']?.length || 0), 10);
                worksheet['!cols'] = [{ wch: maxWidth }];
                
                XLSX.writeFile(workbook, filename);
                showToast('Excel file exported successfully!');
            } catch (error) {
                console.error('Error exporting Excel:', error);
                showToast('Error exporting Excel: ' + error.message, 'error');
            }
        }

        // Reset time study form
        function resetTimeStudyForm() {
            document.getElementById('studyOperatorId').value = '';
            document.getElementById('studyLineNo').value = '';
            document.getElementById('studyStyleNo').value = '';
            document.getElementById('studyProductDesc').value = '';
            document.getElementById('studyOperation').value = '';
            document.getElementById('studyMachine').value = '';
            document.getElementById('customMachineName').value = '';
            document.getElementById('customMachineRow').style.display = 'none';
            document.getElementById('standardSMV').value = '';
            document.getElementById('studyOtherMachines').value = '';
            
            // Reset image
            currentImageFile = null;
            const imagePreview = document.getElementById('imagePreview');
            const previewImage = document.getElementById('previewImage');
            imagePreview.classList.remove('has-image');
            previewImage.style.display = 'none';
            
            // Reset stopwatch
            resetStopwatch();
        }

        // Update last updated time
        function updateLastUpdated() {
            const now = new Date();
            elements.lastUpdated.textContent = now.toLocaleDateString('en-US', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            elements.toastMessage.textContent = message;
            const toast = elements.notificationToast;
            const icon = toast.querySelector('i');
            
            toast.className = 'toast';
            if (type === 'error') {
                toast.classList.add('toast-error');
                icon.className = 'fas fa-exclamation-circle';
            } else {
                toast.classList.add('toast-success');
                icon.className = 'fas fa-check-circle';
            }
            
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 4000);
        }

        // NEW: Show cycle times detail modal
        function showCycleTimesDetail(recordId) {
            const record = performanceData.find(r => r.id === recordId);
            if (!record) return;
            
            // Populate modal with data
            document.getElementById('detailOperatorName').textContent = record.operatorName || 'Unknown';
            document.getElementById('detailOperation').textContent = record.operation || 'Unknown';
            document.getElementById('detailStdSMV').textContent = record.standardSMV ? record.standardSMV.toFixed(2) + ' min' : '0.00 min';
            document.getElementById('detailWorkingSMV').textContent = record.workingSMV ? record.workingSMV.toFixed(2) + ' min' : '0.00 min';
            document.getElementById('detailEfficiency').textContent = record.efficiency ? record.efficiency.toFixed(1) + '%' : '0%';
            
            // Populate cycle times list
            const cycleTimesList = document.getElementById('cycleTimesList');
            cycleTimesList.innerHTML = '';
            
            if (record.cycleTimes && record.cycleTimes.length > 0) {
                let total = 0;
                record.cycleTimes.forEach((time, index) => {
                    total += time;
                    const row = document.createElement('div');
                    row.className = 'cycle-time-row';
                    row.innerHTML = `
                        <span>Cycle ${index + 1}:</span>
                        <span>${time.toFixed(3)} seconds</span>
                    `;
                    cycleTimesList.appendChild(row);
                });
                
                // Show calculations
                const avgTime = total / record.cycleTimes.length;
                const workingSMV = avgTime / 60;
                const efficiency = record.standardSMV > 0 ? (record.standardSMV / workingSMV) * 100 : 0;
                
                document.getElementById('avgCycleTimeFormula').textContent = 
                    `${total.toFixed(3)}  ${record.cycleTimes.length} = ${avgTime.toFixed(3)} seconds`;
                
                document.getElementById('avgCycleTimeCalc').innerHTML = 
                    `<strong>${avgTime.toFixed(3)} seconds</strong>`;
                
                document.getElementById('workingSMVCalc').innerHTML = 
                    `<strong>${avgTime.toFixed(3)}  60 = ${workingSMV.toFixed(3)} minutes</strong>`;
                
                document.getElementById('efficiencyCalc').innerHTML = 
                    `<strong>(${record.standardSMV.toFixed(2)}  ${workingSMV.toFixed(3)})  100 = ${efficiency.toFixed(1)}%</strong>`;
            }
            
            // Show modal
            document.getElementById('cycleDetailModal').classList.add('active');
        }

        // NEW: Analyze Performance
        function analyzePerformance() {
            if (performanceData.length === 0) {
                showToast('No performance data available for analysis', 'error');
                return;
            }
            
            // Calculate overall statistics
            const totalEfficiency = performanceData.reduce((sum, record) => sum + (record.efficiency || 0), 0);
            const avgEfficiency = totalEfficiency / performanceData.length;
            
            document.getElementById('analysisOverallEfficiency').textContent = avgEfficiency.toFixed(1) + '%';
            document.getElementById('totalOutput').textContent = performanceData.length;
            
            // Find best performing line
            const linePerformance = {};
            performanceData.forEach(record => {
                if (record.lineNo) {
                    if (!linePerformance[record.lineNo]) {
                        linePerformance[record.lineNo] = { total: 0, count: 0 };
                    }
                    linePerformance[record.lineNo].total += record.efficiency || 0;
                    linePerformance[record.lineNo].count++;
                }
            });
            
            let bestLine = '';
            let bestLineEfficiency = 0;
            for (const [line, data] of Object.entries(linePerformance)) {
                const avg = data.total / data.count;
                if (avg > bestLineEfficiency) {
                    bestLine = line;
                    bestLineEfficiency = avg;
                }
            }
            
            document.getElementById('bestLine').textContent = bestLine || '-';
            document.getElementById('bestLineEfficiency').textContent = `Efficiency: ${bestLineEfficiency.toFixed(1)}%`;
            
            // Find most efficient operator
            const operatorPerformance = {};
            performanceData.forEach(record => {
                if (record.operatorId) {
                    if (!operatorPerformance[record.operatorId]) {
                        operatorPerformance[record.operatorId] = {
                            name: record.operatorName || record.operatorId,
                            total: 0,
                            count: 0
                        };
                    }
                    operatorPerformance[record.operatorId].total += record.efficiency || 0;
                    operatorPerformance[record.operatorId].count++;
                }
            });
            
            let bestOperator = '';
            let bestOperatorEfficiency = 0;
            for (const [operatorId, data] of Object.entries(operatorPerformance)) {
                const avg = data.total / data.count;
                if (avg > bestOperatorEfficiency) {
                    bestOperator = data.name;
                    bestOperatorEfficiency = avg;
                }
            }
            
            document.getElementById('bestOperator').textContent = bestOperator || '-';
            document.getElementById('bestOperatorEfficiency').textContent = `Avg: ${bestOperatorEfficiency.toFixed(1)}%`;
            
            // Create charts
            createAnalysisCharts();
            
            // Show analysis modal
            document.getElementById('analysisModal').classList.add('active');
        }

        // NEW: Create analysis charts
        function createAnalysisCharts() {
            // Destroy existing charts if they exist
            if (efficiencyDistributionChart) efficiencyDistributionChart.destroy();
            if (weeklyTrendChart) weeklyTrendChart.destroy();
            if (topOperatorsChart) topOperatorsChart.destroy();
            if (machinePerformanceChart) machinePerformanceChart.destroy();
            if (efficiencyByMachineChart) efficiencyByMachineChart.destroy();
            if (dailyEfficiencyChart) dailyEfficiencyChart.destroy();
            if (operatorRankingsChart) operatorRankingsChart.destroy();
            if (linePerformanceChart) linePerformanceChart.destroy();
            
            // 1. Efficiency Distribution Chart
            const efficiencyRanges = {
                'Below 70%': 0,
                '70-85%': 0,
                'Above 85%': 0
            };
            
            performanceData.forEach(record => {
                const efficiency = record.efficiency || 0;
                if (efficiency < 70) efficiencyRanges['Below 70%']++;
                else if (efficiency < 85) efficiencyRanges['70-85%']++;
                else efficiencyRanges['Above 85%']++;
            });
            
            const efficiencyCtx = document.getElementById('efficiencyDistributionChart').getContext('2d');
            efficiencyDistributionChart = new Chart(efficiencyCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(efficiencyRanges),
                    datasets: [{
                        data: Object.values(efficiencyRanges),
                        backgroundColor: [
                            'rgba(248, 150, 30, 0.8)',
                            'rgba(67, 97, 238, 0.8)',
                            'rgba(76, 201, 240, 0.8)'
                        ],
                        borderColor: [
                            'rgba(248, 150, 30, 1)',
                            'rgba(67, 97, 238, 1)',
                            'rgba(76, 201, 240, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: {
                                color: 'white'
                            }
                        }
                    }
                }
            });
            
            // 2. Weekly Trend Chart
            const weeklyData = getWeeklyTrendData();
            const trendCtx = document.getElementById('weeklyTrendChart').getContext('2d');
            weeklyTrendChart = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: weeklyData.labels,
                    datasets: [{
                        label: 'Average Efficiency',
                        data: weeklyData.values,
                        borderColor: 'rgba(67, 97, 238, 1)',
                        backgroundColor: 'rgba(67, 97, 238, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 50,
                            max: 100,
                            ticks: {
                                color: 'white'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: 'white'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: 'white'
                            }
                        }
                    }
                }
            });
            
            // 3. Top Operators Chart
            const topOperatorsData = getTopOperatorsData(10);
            const topOpsCtx = document.getElementById('topOperatorsChart').getContext('2d');
            topOperatorsChart = new Chart(topOpsCtx, {
                type: 'bar',
                data: {
                    labels: topOperatorsData.names,
                    datasets: [{
                        label: 'Efficiency %',
                        data: topOperatorsData.efficiencies,
                        backgroundColor: 'rgba(76, 201, 240, 0.8)',
                        borderColor: 'rgba(76, 201, 240, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                color: 'white'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            ticks: {
                                color: 'white'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: 'white'
                            }
                        }
                    }
                }
            });
            
            // 4. Machine Performance Chart
            const machineData = getMachinePerformanceData();
            const machineCtx = document.getElementById('machinePerformanceChart').getContext('2d');
            machinePerformanceChart = new Chart(machineCtx, {
                type: 'bar',
                data: {
                    labels: machineData.names.slice(0, 10),
                    datasets: [{
                        label: 'Avg Efficiency',
                        data: machineData.efficiencies.slice(0, 10),
                        backgroundColor: 'rgba(248, 37, 133, 0.8)',
                        borderColor: 'rgba(248, 37, 133, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                color: 'white'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: 'white',
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: 'white'
                            }
                        }
                    }
                }
            });
            
            // Create additional charts for other tabs
            createAdditionalCharts();
        }

        // Create additional analysis charts
        function createAdditionalCharts() {
            // Efficiency by Machine Type Chart
            const efficiencyByMachineCtx = document.getElementById('efficiencyByMachineChart').getContext('2d');
            efficiencyByMachineChart = new Chart(efficiencyByMachineCtx, {
                type: 'radar',
                data: getEfficiencyByMachineData(),
                options: {
                    responsive: true,
                    scales: {
                        r: {
                            angleLines: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            pointLabels: {
                                color: 'white'
                            },
                            ticks: {
                                color: 'white',
                                backdropColor: 'transparent'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: 'white'
                            }
                        }
                    }
                }
            });
        }

        // Helper functions for analysis
        function getWeeklyTrendData() {
            const last7Days = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                last7Days.push(date.toISOString().split('T')[0]);
            }
            
            const dailyAverages = {};
            last7Days.forEach(day => {
                dailyAverages[day] = { total: 0, count: 0 };
            });
            
            performanceData.forEach(record => {
                if (record.timestamp) {
                    const recordDate = record.timestamp.toISOString().split('T')[0];
                    if (dailyAverages[recordDate]) {
                        dailyAverages[recordDate].total += record.efficiency || 0;
                        dailyAverages[recordDate].count++;
                    }
                }
            });
            
            const labels = last7Days.map(date => {
                const d = new Date(date);
                return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            });
            
            const values = last7Days.map(date => {
                const data = dailyAverages[date];
                return data.count > 0 ? (data.total / data.count) : 0;
            });
            
            return { labels, values };
        }

        function getTopOperatorsData(limit = 10) {
            const operatorPerformance = {};
            
            performanceData.forEach(record => {
                if (record.operatorId && record.efficiency) {
                    if (!operatorPerformance[record.operatorId]) {
                        operatorPerformance[record.operatorId] = {
                            name: record.operatorName || record.operatorId,
                            total: 0,
                            count: 0
                        };
                    }
                    operatorPerformance[record.operatorId].total += record.efficiency;
                    operatorPerformance[record.operatorId].count++;
                }
            });
            
            const operatorsArray = Object.entries(operatorPerformance).map(([id, data]) => ({
                id,
                name: data.name,
                avgEfficiency: data.total / data.count
            }));
            
            operatorsArray.sort((a, b) => b.avgEfficiency - a.avgEfficiency);
            const topOperators = operatorsArray.slice(0, limit);
            
            return {
                names: topOperators.map(op => op.name.length > 15 ? op.name.substring(0, 12) + '...' : op.name),
                efficiencies: topOperators.map(op => op.avgEfficiency)
            };
        }

        function getMachinePerformanceData() {
            const machinePerformance = {};
            
            performanceData.forEach(record => {
                let machineName = record.machineName;
                if (record.machineName === 'Others' && record.customMachineName) {
                    machineName = record.customMachineName;
                }
                
                if (machineName && record.efficiency) {
                    if (!machinePerformance[machineName]) {
                        machinePerformance[machineName] = { total: 0, count: 0 };
                    }
                    machinePerformance[machineName].total += record.efficiency;
                    machinePerformance[machineName].count++;
                }
            });
            
            const machinesArray = Object.entries(machinePerformance).map(([name, data]) => ({
                name,
                avgEfficiency: data.total / data.count
            }));
            
            machinesArray.sort((a, b) => b.avgEfficiency - a.avgEfficiency);
            
            return {
                names: machinesArray.map(m => m.name),
                efficiencies: machinesArray.map(m => m.avgEfficiency)
            };
        }

        function getEfficiencyByMachineData() {
            const commonMachines = ['BARTACK', 'OVERLOCK', 'BUTTONHOLE', 'SNLS', 'DNLS'];
            const machineEfficiency = {};
            
            commonMachines.forEach(machine => {
                machineEfficiency[machine] = { total: 0, count: 0 };
            });
            
            performanceData.forEach(record => {
                const machine = record.machineName;
                if (commonMachines.includes(machine) && record.efficiency) {
                    machineEfficiency[machine].total += record.efficiency;
                    machineEfficiency[machine].count++;
                }
            });
            
            const averages = commonMachines.map(machine => {
                const data = machineEfficiency[machine];
                return data.count > 0 ? (data.total / data.count) : 0;
            });
            
            return {
                labels: commonMachines,
                datasets: [{
                    label: 'Average Efficiency',
                    data: averages,
                    backgroundColor: 'rgba(67, 97, 238, 0.2)',
                    borderColor: 'rgba(67, 97, 238, 1)',
                    pointBackgroundColor: 'rgba(67, 97, 238, 1)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgba(67, 97, 238, 1)'
                }]
            };
        }

        // Modal close functions
        function closeAnalysisModal() {
            document.getElementById('analysisModal').classList.remove('active');
        }

        function closeCycleDetailModal() {
            document.getElementById('cycleDetailModal').classList.remove('active');
        }

        // Setup event listeners
        function setupEventListeners() {
            // Operators Tab
            elements.searchInput.addEventListener('input', filterOperators);
            elements.skillFilter.addEventListener('change', filterOperators);
            elements.lineFilter.addEventListener('change', filterOperators);
            
            // Performance Tab
            document.getElementById('searchPerformance').addEventListener('input', filterPerformanceData);
            document.getElementById('perfLineFilter').addEventListener('change', filterPerformanceData);
            document.getElementById('dateFilter').addEventListener('change', filterPerformanceData);
            
            // Action buttons
            document.getElementById('addOperatorBtn').addEventListener('click', () => {
                document.getElementById('addOperatorModal').classList.add('active');
                document.getElementById('newOperatorId').focus();
            });
            
            document.getElementById('exportBtn').addEventListener('click', () => exportToExcel('operators'));
            document.getElementById('exportPerformanceBtn').addEventListener('click', () => exportToExcel('performance'));
            
            document.getElementById('saveBtn').addEventListener('click', async () => {
                showToast('All changes saved to cloud!');
            });
            
            document.getElementById('refreshBtn').addEventListener('click', () => {
                loadData();
                showToast('Refreshing data...');
            });
            
            document.getElementById('addPerformanceBtn').addEventListener('click', () => {
                document.getElementById('addPerformanceModal').classList.add('active');
                document.getElementById('perfOperatorId').focus();
            });
            
            // NEW: Analyze Performance button
            document.getElementById('analyzeBtn').addEventListener('click', analyzePerformance);
            
            // UPDATED: Stopwatch event listeners
            document.getElementById('startBtn').addEventListener('click', startStopwatch);
            document.getElementById('stopBtn').addEventListener('click', stopStopwatch);
            document.getElementById('lapBtn').addEventListener('click', recordLap);
            document.getElementById('resetBtn').addEventListener('click', resetStopwatch);
            
            document.getElementById('savePerformanceData').addEventListener('click', async () => {
                await saveTimeStudyData();
            });
            
            document.getElementById('resetStopwatch').addEventListener('click', () => {
                resetStopwatch();
                // Reset form
                document.getElementById('lapsList').innerHTML = '';
                document.getElementById('avgCycleTime').textContent = '0.00';
                document.getElementById('totalCycleTime').textContent = '0.00';
                document.getElementById('workingSMVResult').textContent = '0.00';
                document.getElementById('efficiencyResult').textContent = '0%';
            });
            
            // Cycle count selection
            document.querySelectorAll('input[name="cycleCount"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    cycleCount = parseInt(e.target.value);
                    if (lapCounter > 0) {
                        if (confirm('Changing cycle count will reset the current measurements. Continue?')) {
                            resetStopwatch();
                        } else {
                            // Revert to previous selection
                            const previousValue = lapCounter >= 3 ? '3' : '5';
                            document.querySelector(`input[name="cycleCount"][value="${previousValue}"]`).checked = true;
                        }
                    }
                });
            });
            
            // Machine dropdown with custom option
            document.getElementById('studyMachine').addEventListener('change', (e) => {
                if (e.target.value === 'Others') {
                    document.getElementById('customMachineRow').style.display = 'block';
                } else {
                    document.getElementById('customMachineRow').style.display = 'none';
                    document.getElementById('customMachineName').value = '';
                }
            });
            
            document.getElementById('perfMachine').addEventListener('change', (e) => {
                if (e.target.value === 'Others') {
                    document.getElementById('perfCustomMachineRow').style.display = 'block';
                } else {
                    document.getElementById('perfCustomMachineRow').style.display = 'none';
                    document.getElementById('perfCustomMachineName').value = '';
                }
            });
            
            // Manual cycle times in performance modal
            document.getElementById('addCycleTimeBtn').addEventListener('click', () => {
                const container = document.getElementById('manualCycleTimes');
                const cycleNum = container.querySelectorAll('.manual-cycle-time').length + 1;
                const cycleDiv = document.createElement('div');
                cycleDiv.className = 'form-row';
                cycleDiv.innerHTML = `
                    <div class="form-group" style="margin-bottom: 10px;">
                        <label for="cycleTime${cycleNum}">Cycle ${cycleNum} Time (seconds)</label>
                        <input type="number" id="cycleTime${cycleNum}" class="manual-cycle-time" step="0.001" placeholder="e.g., 25.345">
                    </div>
                `;
                container.appendChild(cycleDiv);
            });
            
            // Modal close buttons
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.getElementById('addOperatorModal').classList.remove('active');
                    document.getElementById('editCellModal').classList.remove('active');
                    document.getElementById('addPerformanceModal').classList.remove('active');
                });
            });
            
            // Add operator form
            document.getElementById('addOperatorForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const operatorData = {
                    operatorId: document.getElementById('newOperatorId').value.trim(),
                    name: document.getElementById('newOperatorName').value.trim(),
                    sewLine: document.getElementById('newSewLine').value.trim() || null,
                    skillLevel: document.getElementById('newSkillLevel').value || null
                };
                
                if (await saveOperator(operatorData, false)) {
                    document.getElementById('addOperatorForm').reset();
                    document.getElementById('addOperatorModal').classList.remove('active');
                    populateOperatorDropdowns();
                    populateLineFilter();
                }
            });
            
            // Edit operator form
            document.getElementById('editCellForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const operatorData = {
                    sewLine: document.getElementById('editSewLine').value.trim() || null,
                    skillLevel: document.getElementById('editSkillLevel').value || null,
                    skillScore: document.getElementById('editSkillScore').value || null
                };
                
                if (await saveOperator(operatorData, true)) {
                    document.getElementById('editCellModal').classList.remove('active');
                }
            });
            
            // Score slider sync
            const editSkillScoreInput = document.getElementById('editSkillScore');
            const scoreSlider = document.getElementById('scoreSlider');
            
            scoreSlider.addEventListener('input', (e) => {
                editSkillScoreInput.value = (e.target.value / 100).toFixed(2);
            });
            
            editSkillScoreInput.addEventListener('input', (e) => {
                const value = Math.min(1, Math.max(0, parseFloat(e.target.value) || 0));
                scoreSlider.value = Math.round(value * 100);
                editSkillScoreInput.value = value.toFixed(2);
            });
            
            // Add performance form
            document.getElementById('addPerformanceForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = {
                    operatorId: document.getElementById('perfOperatorId').value,
                    lineNo: document.getElementById('perfLineNo').value,
                    styleNo: document.getElementById('perfStyleNo').value,
                    productDesc: document.getElementById('perfProductDesc').value,
                    operation: document.getElementById('perfOperation').value,
                    machineName: document.getElementById('perfMachine').value,
                    standardSMV: parseFloat(document.getElementById('perfStdSMV').value),
                    workingSMV: parseFloat(document.getElementById('perfWorkingSMV').value),
                    otherMachines: document.getElementById('perfOtherMachines').value
                };
                
                if (await saveManualPerformanceData(formData)) {
                    document.getElementById('addPerformanceForm').reset();
                    currentPerfImageFile = null;
                    const imagePreview = document.getElementById('perfImagePreview');
                    const previewImage = document.getElementById('perfPreviewImage');
                    imagePreview.classList.remove('has-image');
                    previewImage.style.display = 'none';
                    
                    // Reset manual cycle times
                    document.getElementById('manualCycleTimes').innerHTML = '';
                    document.getElementById('addPerformanceModal').classList.remove('active');
                }
            });
            
            // Image upload for time study
            document.getElementById('productImage').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    currentImageFile = file;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const previewImage = document.getElementById('previewImage');
                        const imagePreview = document.getElementById('imagePreview');
                        previewImage.src = e.target.result;
                        previewImage.style.display = 'block';
                        imagePreview.classList.add('has-image');
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Image upload for performance form
            document.getElementById('perfProductImage').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    currentPerfImageFile = file;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const previewImage = document.getElementById('perfPreviewImage');
                        const imagePreview = document.getElementById('perfImagePreview');
                        previewImage.src = e.target.result;
                        previewImage.style.display = 'block';
                        imagePreview.classList.add('has-image');
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Close modals on outside click
            window.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    e.target.classList.remove('active');
                }
            });
        }
    </script>
</body>
</html>
