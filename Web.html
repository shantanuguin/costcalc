<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Style Wise Plan Calculator - B4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
        }
        .container {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            width: 100%;
            max-width: 900px;
        }
        .form-input-container {
            position: relative;
        }
        .form-input, .form-select {
            border: 1px solid #ced4da;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        .form-input:focus, .form-select:focus {
            border-color: #4285F4;
            box-shadow: 0 0 0 0.2rem rgba(66, 133, 244, 0.25);
            outline: none;
        }
        .clear-input-btn {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
            cursor: pointer;
            transition: color 0.2s;
        }
        .clear-input-btn:hover {
            color: #374151;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .btn-primary { background-color: #4285F4; color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #3367D6; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15); }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-secondary:hover:not(:disabled) { background-color: #5a6268; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15); }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-danger:hover:not(:disabled) { background-color: #c82333; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15); }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        .alert { padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; font-weight: 500; }
        .alert-danger { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        
        .result-card-header {
            padding: 0.75rem 1.5rem; cursor: pointer; display: flex;
            justify-content: space-between; align-items: center; font-weight: 600;
            color: #1a73e8; background-color: #e9f0ff;
        }
        .result-card-header:hover { background-color: #dbe7ff; }
        .result-card-content { display: none; padding: 1.5rem; border-top: 1px solid #e0e0e0; }
        .result-card-content.active { display: block; }
        .toggle-icon { transition: transform 0.3s ease; }
        .toggle-icon.rotated { transform: rotate(180deg); }
        
        .color-tabs-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #ddd;
        }
        .color-tab {
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            background-color: #e9ecef;
            color: #495057;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            display: flex;
            align-items: center;
        }
        .color-tab:hover {
            background-color: #dbe7ff;
            color: #3367D6;
        }
        .color-tab.active {
            background-color: #4285F4;
            color: white;
            font-weight: 600;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); display: flex;
            justify-content: center; align-items: center; z-index: 1000;
            transition: opacity 0.3s ease;
        }
        .modal-content {
            background-color: #ffffff; padding: 2rem; border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2); width: 90%;
            max-width: 600px; transform: scale(0.95); transition: transform 0.3s ease;
        }
        .modal-overlay:not(.hidden) .modal-content { transform: scale(1); }
        .modal-input {
            border: 1px solid #ced4da; border-radius: 8px; padding: 0.75rem 1rem;
            font-size: 1rem; width: 100%; margin-top: 1rem;
        }
        .modal-error { color: #dc3545; font-size: 0.875rem; margin-top: 0.5rem; min-height: 1.25rem; }

        .selection-mode .result-card-header { background-color: #fff3cd; color: #856404; }
        .selection-mode .result-card-header:hover { background-color: #ffeeba; }
        .checkbox-container { display: none; }
        .selection-mode .checkbox-container { display: block; }
        .selection-mode .color-checkbox { display: inline-block; }
        .color-checkbox { display: none; }


        .report-modal-content { max-width: 800px; text-align: left; max-height: 85vh; overflow-y: auto; }
        .report-summary-item { display: flex; justify-content: space-between; padding: 0.4rem 0; border-bottom: 1px dashed #e9ecef; }
        .report-section-title { font-size: 1.25rem; font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.75rem; color: #343a40; border-bottom: 2px solid #e0e0e0; padding-bottom: 0.5rem; }

        .manage-actions-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem; text-align: center;
        }
        .action-card {
            background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 12px;
            padding: 1.5rem 1rem; cursor: pointer; transition: all 0.2s ease;
        }
        .action-card:hover {
            transform: translateY(-5px); box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-color: #4285F4;
        }
        .action-card i { font-size: 2rem; margin-bottom: 0.75rem; color: #4285F4; }
        .action-card.danger i { color: #dc3545; }
        .action-card.danger:hover { border-color: #dc3545; }
        .action-card p { font-weight: 600; color: #343a40; }
        .action-card.disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; border-color: #e9ecef; }
        .action-card.disabled i { color: #6c757d; }

        .header-logo { max-height: 50px; width: auto; }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }
        .detail-section { background-color: #f8f9fa; padding: 1rem; border-radius: 8px; }
        .detail-section h4 { font-weight: 700; color: #343a40; margin-bottom: 0.75rem; }
        .detail-item { display: flex; justify-content: space-between; font-size: 0.875rem; padding: 0.25rem 0; }
        .detail-item span:first-child { color: #495057; }
        .detail-item span:last-child { font-weight: 600; color: #212529; }
        
        #calculationDetailsContent h4 { font-size: 1.1rem; font-weight: 700; margin-top: 1rem; margin-bottom: 0.5rem; border-bottom: 1px solid #ddd; padding-bottom: 0.25rem;}
        #calculationDetailsContent p { font-family: 'Courier New', Courier, monospace; font-size: 0.9rem; margin-bottom: 0.25rem; }

        .racetrack-modal .modal-content { max-width: 800px; }
        .racetrack { position: relative; width: 100%; height: 50px; background-color: #e9ecef; border-radius: 25px; margin-bottom: 1rem; overflow: hidden; }
        .racetrack-cursor {
            position: absolute; top: 50%; left: 0; transform: translateY(-50%); width: 40px; height: 40px;
            background: linear-gradient(145deg, #ffffff, #e6e6e6); border-radius: 50%; display: flex;
            align-items: center; justify-content: center; font-size: 1.2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); color: #333;
        }
        .racetrack-progress {
            position: absolute; left: 0; top: 0; height: 100%; width: 100%;
            background: linear-gradient(90deg, #a8d08d, #5a9bd5); transform: translateX(-100%);
        }

        .sort-dropdown {
            position: absolute;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            z-index: 10;
            width: 200px;
            overflow: hidden;
            margin-top: 0.5rem;
            right: 0;
        }
        .sort-option {
            padding: 0.75rem 1rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .sort-option:hover {
            background-color: #f1f3f4;
        }
        .sort-option.active {
            background-color: #e9f0ff;
            font-weight: 600;
            color: #1a73e8;
        }

        @media (max-width: 768px) {
            .result-card-header { flex-wrap: wrap; gap: 0.5rem; }
            #searchSortContainer { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>
<body class="flex justify-center items-start min-h-screen p-4 sm:p-8">

    <div class="container p-6 sm:p-10">
        <div class="flex flex-col items-center mb-8">
            <img src="./CLogo.png" alt="Company Logo" class="header-logo mb-4" onerror="this.onerror=null;this.src='https://https://vamanioverseas.com/';">
            <h1 class="text-2xl sm:text-3xl font-bold text-center">Style Wise Plan Calculator</h1>
            <p class="text-center text-gray-600 text-sm sm:text-base">Plant B4 - Sector 63, Noida</p>
        </div>

        <div id="messages" class="hidden"></div>

        <form id="costForm" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="form-group">
                    <label for="style_no" class="block text-sm mb-1 font-medium text-gray-700">Style Number:</label>
                    <div class="form-input-container">
                        <input type="text" id="style_no" class="form-input w-full pr-8" required>
                        <span class="clear-input-btn hidden"><i class="fas fa-times-circle"></i></span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="color_input" class="block text-sm mb-1 font-medium text-gray-700">Color:</label>
                    <div class="form-input-container">
                        <input type="text" id="color_input" list="color_list" class="form-input w-full pr-8" required>
                        <datalist id="color_list"></datalist>
                        <span class="clear-input-btn hidden"><i class="fas fa-times-circle"></i></span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="order_qty" class="block text-sm mb-1 font-medium text-gray-700">Order Quantity:</label>
                    <div class="form-input-container">
                        <input type="number" id="order_qty" class="form-input w-full pr-8" min="0" required placeholder="e.g., 1500">
                        <span class="clear-input-btn hidden"><i class="fas fa-times-circle"></i></span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="sam_stitching" class="block text-sm mb-1 font-medium text-gray-700">Stitching SAM:</label>
                    <div class="form-input-container">
                        <input type="number" id="sam_stitching" class="form-input w-full pr-8" step="0.01" min="0" required placeholder="e.g., 25.5">
                        <span class="clear-input-btn hidden"><i class="fas fa-times-circle"></i></span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="sam_cutting" class="block text-sm mb-1 font-medium text-gray-700">Cutting SAM:</label>
                    <div class="form-input-container">
                        <input type="number" id="sam_cutting" class="form-input w-full pr-8" step="0.01" min="0" required placeholder="e.g., 2.5">
                        <span class="clear-input-btn hidden"><i class="fas fa-times-circle"></i></span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="sam_finishing" class="block text-sm mb-1 font-medium text-gray-700">Finishing SAM:</label>
                    <div class="form-input-container">
                        <input type="number" id="sam_finishing" class="form-input w-full pr-8" step="0.01" min="0" required placeholder="e.g., 3.0">
                        <span class="clear-input-btn hidden"><i class="fas fa-times-circle"></i></span>
                    </div>
                </div>
                 <div class="form-group md:col-span-2">
                    <label for="process_selected_values" class="block text-sm mb-1 font-medium text-gray-700">Process:</label>
                    <div class="form-input-container">
                        <select id="process_selected_values" class="form-select w-full bg-white pr-8">
                            <option value="N/A">None</option>
                            <option value="Embroidery">Embroidery</option>
                            <option value="Washing">Washing</option>
                            <option value="Adda Work">Adda Work</option>
                            <option value="Printing">Printing</option>
                            <option value="Embroidery + Washing">Embroidery + Washing</option>
                            <option value="All">All Processes</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="flex justify-center mt-8 space-x-4">
                <button type="submit" class="btn btn-primary"><i class="fas fa-calculator"></i>Calculate</button>
                <button type="button" id="clearInputBtn" class="btn btn-secondary bg-gray-300 hover:bg-gray-400 text-gray-800"><i class="fas fa-eraser"></i>Clear All</button>
            </div>
        </form>

        <hr class="my-8 border-t border-gray-200">

        <div id="actionsContainer" class="space-y-4">
            <h2 class="text-xl font-semibold text-center text-gray-700 mb-6">Manage Saved Styles</h2>
            <div id="mainActionButtons" class="manage-actions-grid">
                <div id="importStylesBtn" class="action-card">
                    <i class="fas fa-file-excel"></i>
                    <p>Import Styles</p>
                </div>
                <div id="generateReportBtn" class="action-card">
                    <i class="fas fa-file-alt"></i>
                    <p>Generate Report</p>
                </div>
                <div id="deleteStylesBtn" class="action-card danger">
                    <i class="fas fa-trash-alt"></i>
                    <p>Delete Styles</p>
                </div>
            </div>
            <input type="file" id="importFile" class="hidden" accept=".xlsx, .xls, .csv">
            <div id="selectionModeButtons" class="hidden flex justify-center items-center flex-wrap gap-4"></div>
        </div>
        
        <div id="searchSortContainer" class="flex flex-wrap gap-4 items-center justify-between mt-8 mb-4 p-4 bg-gray-50 rounded-lg">
            <div class="flex-grow flex items-center border border-gray-300 rounded-lg overflow-hidden">
                <input type="text" id="searchInput" class="form-input w-full border-none focus:ring-0" placeholder="Search Style No...">
                <button id="searchBtn" class="btn btn-primary rounded-l-none px-4"><i class="fas fa-search"></i></button>
            </div>
            <div class="relative">
                <button id="sortBtn" class="btn btn-secondary bg-gray-200 hover:bg-gray-300 text-gray-800">
                    <i class="fas fa-sort-amount-down"></i>
                    <span>Sort By</span>
                </button>
                <div id="sortDropdown" class="sort-dropdown hidden">
                    <div class="sort-option" data-sort="time"><span>Creation Time</span><i class="fas"></i></div>
                    <div class="sort-option" data-sort="alpha"><span>Style Number</span><i class="fas"></i></div>
                    <div class="sort-option" data-sort="qty"><span>Total Quantity</span><i class="fas"></i></div>
                </div>
            </div>
        </div>

        <div id="allResultsContainer" class="mt-4 space-y-4"></div>
    </div>

    <!-- Modals -->
    <div id="racetrackModal" class="modal-overlay hidden racetrack-modal">
        <div class="modal-content">
            <h3 class="text-2xl font-bold mb-6 text-center">Production Flow Speed</h3>
            <div class="space-y-6">
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-semibold">Cutting</span>
                        <span id="cuttingTime" class="text-sm font-mono"></span>
                    </div>
                    <div class="racetrack">
                        <div id="cuttingProgress" class="racetrack-progress"></div>
                        <div id="cuttingCursor" class="racetrack-cursor"><i class="fas fa-cut"></i></div>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-semibold">Stitching</span>
                        <span id="stitchingTime" class="text-sm font-mono"></span>
                    </div>
                    <div class="racetrack">
                        <div id="stitchingProgress" class="racetrack-progress"></div>
                        <div id="stitchingCursor" class="racetrack-cursor"><i class="fas fa-tshirt"></i></div>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-semibold">Finishing</span>
                        <span id="finishingTime" class="text-sm font-mono"></span>
                    </div>
                    <div class="racetrack">
                        <div id="finishingProgress" class="racetrack-progress"></div>
                        <div id="finishingCursor" class="racetrack-cursor"><i class="fas fa-check-circle"></i></div>
                    </div>
                </div>
            </div>
             <div class="flex justify-center mt-8">
                <button class="btn btn-secondary" id="closeRaceModalBtn">Close</button>
            </div>
        </div>
    </div>

    <div id="calculationDetailsModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div id="calculationDetailsContent"></div>
            <div class="flex gap-3 mt-6 justify-end">
                <button id="downloadCalcPdfBtn" class="btn btn-primary"><i class="fas fa-file-pdf"></i> Download PDF</button>
                <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').classList.add('hidden')">Close</button>
            </div>
        </div>
    </div>

    <div id="existingStyleModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">Style Already Exists</h3>
            <p id="modalMessage" class="mb-6"></p>
            <div class="flex flex-col sm:flex-row gap-3">
                <button type="button" id="modalAppendQty" class="btn btn-primary w-full">Append Quantity</button>
                <button type="button" id="modalGoToExisting" class="btn btn-secondary w-full">Go to Existing</button>
                <button type="button" class="btn btn-danger w-full" onclick="this.closest('.modal-overlay').classList.add('hidden')">Cancel</button>
            </div>
        </div>
    </div>

    <div id="editStyleModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">Edit Style Color</h3>
            <form id="editForm" class="space-y-4">
                <input type="hidden" id="edit_style_no">
                <input type="hidden" id="edit_original_color">
                <div>
                    <label for="edit_color_name" class="block text-sm font-medium text-gray-700">Color:</label>
                    <input type="text" id="edit_color_name" list="color_list" class="form-input w-full mt-1" required>
                </div>
                <div>
                    <label for="edit_order_qty" class="block text-sm font-medium text-gray-700">Order Quantity:</label>
                    <input type="number" id="edit_order_qty" class="form-input w-full mt-1" min="0" required>
                </div>
                <div>
                    <label for="edit_sam_stitching" class="block text-sm font-medium text-gray-700">Stitching SAM:</label>
                    <input type="number" id="edit_sam_stitching" class="form-input w-full mt-1" step="0.01" min="0" required>
                </div>
                <div>
                    <label for="edit_sam_cutting" class="block text-sm font-medium text-gray-700">Cutting SAM:</label>
                    <input type="number" id="edit_sam_cutting" class="form-input w-full mt-1" step="0.01" min="0" required>
                </div>
                <div>
                    <label for="edit_sam_finishing" class="block text-sm font-medium text-gray-700">Finishing SAM:</label>
                    <input type="number" id="edit_sam_finishing" class="form-input w-full mt-1" step="0.01" min="0" required>
                </div>
                <div>
                    <label for="edit_process_selected_values" class="block text-sm font-medium text-gray-700">Process:</label>
                    <select id="edit_process_selected_values" class="form-select w-full bg-white mt-1">
                        <option value="N/A">None</option>
                        <option value="Embroidery">Embroidery</option>
                        <option value="Washing">Washing</option>
                        <option value="Adda Work">Adda Work</option>
                        <option value="Printing">Printing</option>
                        <option value="Embroidery + Washing">Embroidery + Washing</option>
                        <option value="All">All Processes</option>
                    </select>
                </div>
                <div class="flex gap-3 mt-6 justify-end">
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                    <button type="button" class="btn btn-secondary" onclick="this.closest('.modal-overlay').classList.add('hidden')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div id="deleteConfirmModal" class="modal-overlay hidden">
        <div class="modal-content text-center">
            <h3 class="text-xl font-bold mb-4 text-red-600">Secure Delete</h3>
            <p id="deleteConfirmMessage" class="mb-4"></p>
            <label for="deletePassword" class="font-medium">Enter password to confirm:</label>
            <input type="password" id="deletePassword" class="modal-input" placeholder="Password: DELETE">
            <p id="deleteError" class="modal-error"></p>
            <div class="flex gap-3 mt-6">
                <button type="button" id="confirmDeleteBtn" class="btn btn-danger w-full">Confirm Delete</button>
                <button type="button" class="btn btn-secondary w-full" onclick="this.closest('.modal-overlay').classList.add('hidden')">Cancel</button>
            </div>
        </div>
    </div>
    
    <div id="reportTypeModal" class="modal-overlay hidden">
        <div class="modal-content text-center">
            <h3 class="text-xl font-bold mb-4">Generate Report</h3>
            <p class="mb-6">Include the "Aggregated Summary" sheet in the report?</p>
            <div class="flex gap-3">
                <button id="reportWithSummary" class="btn btn-primary w-full">Yes, Include</button>
                <button id="reportWithoutSummary" class="btn btn-secondary w-full">No, Detailed Only</button>
            </div>
        </div>
    </div>

    <div id="reportPreviewModal" class="modal-overlay hidden">
        <div class="modal-content report-modal-content">
            <div id="reportPreviewContent"></div>
            <div class="flex gap-3 mt-6 justify-end">
                <button id="downloadReportBtn" class="btn btn-primary"><i class="fas fa-download"></i>Download Excel</button>
                <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').classList.add('hidden')">Close</button>
            </div>
        </div>
    </div>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const EFFICIENCY_SLABS = [
            [0, 199, 0.20], [200, 299, 0.25], [300, 999, 0.30],
            [1000, 1999, 0.35], [2000, 2999, 0.40], [3000, 3999, 0.45],
            [4000, 4999, 0.50], [5000, Infinity, 0.55]
        ];
        const DELETE_PASSWORD = "DELETE";
        let allCalculations = {}; // { styleNo: { color: {calculationData} } }
        let colorList = new Set();
        let sortState = { by: 'time', order: 'desc' }; // Default sort

        const costForm = document.getElementById('costForm');
        const allResultsContainer = document.getElementById('allResultsContainer');
        const actionsContainer = document.getElementById('actionsContainer');
        const importFileInput = document.getElementById('importFile');
        const colorInput = document.getElementById('color_input');
        const colorDataList = document.getElementById('color_list');
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const sortBtn = document.getElementById('sortBtn');
        const sortDropdown = document.getElementById('sortDropdown');

        function initializeColors() {
            const commonColors = [
                "Black", "White", "Gray", "Navy", "Blue", "Red", "Green", "Beige", "Brown", "Khaki",
                "Olive", "Maroon", "Charcoal", "Ivory", "Cream", "Pink", "Purple", "Yellow", "Orange",
                "Teal", "Burgundy", "Silver", "Gold", "Tan", "Mustard", "Coral", "Mint", "Lavender",
                "Rose", "Sky Blue"
            ];
            commonColors.forEach(c => colorList.add(c));
            updateColorDatalist();
        }

        function updateColorDatalist() {
            colorDataList.innerHTML = '';
            [...colorList].sort().forEach(color => {
                const option = document.createElement('option');
                option.value = color;
                colorDataList.appendChild(option);
            });
        }

        function calculate(style, order_qty, sam_stitch, sam_cut, sam_fin, processes) {
            const slabInfo = EFFICIENCY_SLABS.find(([lo, hi]) => order_qty >= lo && order_qty <= hi) || [5000, Infinity, 0.55];
            const slabLabel = (slabInfo[1] === Infinity) ? `${slabInfo[0]}+` : `${slabInfo[0]}-${slabInfo[1]}`;
            const eff = slabInfo[2];
            
            const safeEff = eff > 0 ? eff : 0;
            const plan_sam = order_qty * sam_stitch;
            const stitch_rate = safeEff > 0 ? (sam_stitch * 1.2) / safeEff : Infinity;
            const stitch_budget = stitch_rate * order_qty;
            const cut_rate = safeEff > 0 ? sam_cut / safeEff : Infinity;
            const cut_budget = cut_rate * order_qty;
            const finish_rate = safeEff > 0 ? sam_fin / safeEff : Infinity;
            const finish_budget = finish_rate * order_qty;
            const overhead_p1 = order_qty * sam_stitch * 1.5;
            const overhead_p2 = order_qty * sam_stitch * 1.0;
            const total_budget = stitch_budget + cut_budget + finish_budget + overhead_p1 + overhead_p2;
            const cpm = (plan_sam > 0) ? total_budget / plan_sam : Infinity;
            const per_piece_cost = (order_qty > 0) ? total_budget / order_qty : Infinity;

            return {
                "Style No.": style, "Order Qty": order_qty, "Process": processes || 'N/A',
                "Efficiency Slab": slabLabel, "Efficiency %": eff * 100,
                "Stitching SAM": sam_stitch, "Plan SAM": plan_sam, "Stitching Rate": stitch_rate, "Stitching Budget": stitch_budget,
                "Cutting SAM": sam_cut, "Cutting Rate": cut_rate, "Cutting Budget": cut_budget,
                "Finishing SAM": sam_fin, "Finishing Rate": finish_rate, "Finishing Budget": finish_budget,
                "Overhead Part-1": overhead_p1, "Overhead Part-2": overhead_p2,
                "Total Budget": total_budget, "CPM": cpm, "Per-Piece Cost": per_piece_cost
            };
        }

        function formatNumber(value, decimals = 2, prefix = '', suffix = '') {
            if (value === Infinity || value === -Infinity || isNaN(value)) {
                return `<span class="text-red-500 font-bold">N/A</span>`;
            }
            return prefix + value.toLocaleString('en-IN', {
                minimumFractionDigits: decimals, maximumFractionDigits: decimals
            }) + suffix;
        }

        function renderAllStyleGroups(isSelectionMode = false) {
            allResultsContainer.innerHTML = '';
            let sortedStyleNos = Object.keys(allCalculations);

            // Sorting logic
            if (sortState.by === 'alpha') {
                sortedStyleNos.sort((a, b) => a.localeCompare(b));
            } else if (sortState.by === 'time') {
                sortedStyleNos.sort((a, b) => {
                    const timeA = Math.min(...Object.values(allCalculations[a]).map(c => new Date(c.timestamp).getTime()));
                    const timeB = Math.min(...Object.values(allCalculations[b]).map(c => new Date(c.timestamp).getTime()));
                    return timeA - timeB;
                });
            } else if (sortState.by === 'qty') {
                 sortedStyleNos.sort((a, b) => {
                    const qtyA = Object.values(allCalculations[a]).reduce((sum, c) => sum + c['Order Qty'], 0);
                    const qtyB = Object.values(allCalculations[b]).reduce((sum, c) => sum + c['Order Qty'], 0);
                    return qtyA - qtyB;
                });
            }

            if (sortState.order === 'desc') {
                sortedStyleNos.reverse();
            }

            sortedStyleNos.forEach((styleNo, index) => renderStyleGroupCard(styleNo, index + 1, isSelectionMode));
            updateActionButtonsState();
        }

        function renderStyleGroupCard(styleNo, serialNo, isSelectionMode = false) {
            const styleData = allCalculations[styleNo];
            const colors = Object.keys(styleData).sort();
            const totalQty = colors.reduce((sum, color) => sum + styleData[color]['Order Qty'], 0);
            const avgCost = colors.reduce((sum, color) => sum + styleData[color]['Per-Piece Cost'], 0) / colors.length;

            const cardId = `result-group-${serialNo}`;
            const cardHtml = `
                <div id="${cardId}" class="result-card overflow-hidden rounded-lg border border-gray-200" data-style-no="${styleNo}">
                    <div class="result-card-header">
                        <div class="flex items-center gap-4 flex-grow">
                           <div class="checkbox-container">
                                <input type="checkbox" class="h-5 w-5 text-blue-600 focus:ring-blue-500 border-gray-300 rounded style-checkbox" data-style-no="${styleNo}">
                            </div>
                            <span class="font-bold">${serialNo}. ${styleNo}</span>
                        </div>
                        <div class="flex items-center gap-4">
                            <span class="text-sm font-semibold text-gray-600 bg-gray-200 px-3 py-1 rounded-full whitespace-nowrap" title="Total Order Quantity">
                                <i class="fas fa-box-open mr-1"></i> ${formatNumber(totalQty, 0)}
                            </span>
                            <span class="text-sm font-semibold text-gray-600 bg-gray-200 px-3 py-1 rounded-full whitespace-nowrap" title="Number of Colors">
                                <i class="fas fa-palette mr-1"></i> ${colors.length}
                            </span>
                            <span class="text-sm font-bold text-green-700 bg-green-100 px-3 py-1 rounded-full whitespace-nowrap">
                                Avg Cost: ${formatNumber(avgCost, 2, '₹')}
                            </span>
                            <svg class="toggle-icon w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                    </div>
                    <div class="result-card-content bg-white">
                        <div class="color-tabs-container">
                            ${colors.map((color, index) => `
                                <div class="color-tab ${index === 0 ? 'active' : ''}" data-color="${color}">
                                    <input type="checkbox" class="color-checkbox mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" data-style-no="${styleNo}" data-color="${color}">
                                    <span>${color}</span>
                                </div>`).join('')}
                        </div>
                        <div class="color-details-content"></div>
                    </div>
                </div>`;
            allResultsContainer.insertAdjacentHTML('beforeend', cardHtml);
            const newCard = document.getElementById(cardId);
            if (colors.length > 0) {
                renderColorDetails(newCard, styleNo, colors[0]);
            }
        }
        
        function renderColorDetails(cardElement, styleNo, color) {
            const result = allCalculations[styleNo][color];
            const detailsContainer = cardElement.querySelector('.color-details-content');
            
            const detailsHtml = `
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                    <div class="bg-gray-50 p-3 rounded-lg"><span class="font-medium text-gray-600">Order Quantity:</span><span class="block font-bold text-lg">${formatNumber(result['Order Qty'], 0, '', ' Pcs')}</span></div>
                    <div class="bg-gray-50 p-3 rounded-lg"><span class="font-medium text-gray-600">Process:</span><span class="block font-bold text-lg">${result['Process']}</span></div>
                    <div class="bg-gray-50 p-3 rounded-lg"><span class="font-medium text-gray-600">Efficiency:</span><span class="block font-bold text-lg">${result['Efficiency Slab']} (${formatNumber(result['Efficiency %'], 0, '', '%')})</span></div>
                    <div class="bg-gray-50 p-3 rounded-lg"><span class="font-medium text-gray-600">CPM:</span><span class="block font-bold text-lg">${formatNumber(result['CPM'], 6)}</span></div>
                </div>
                <div class="details-grid">
                    <div class="detail-section">
                        <h4>Stitching</h4>
                        <div class="detail-item"><span>Stitching SAM:</span> <span>${formatNumber(result['Stitching SAM'], 2, '', ' Min')}</span></div>
                        <div class="detail-item"><span>Plan SAM:</span> <span>${formatNumber(result['Plan SAM'], 2, '', ' Min')}</span></div>
                        <div class="detail-item"><span>Rate / piece:</span> <span>${formatNumber(result['Stitching Rate'], 2, '₹')}</span></div>
                        <div class="detail-item font-bold border-t mt-1 pt-1"><span>Budget:</span> <span>${formatNumber(result['Stitching Budget'], 2, '₹')}</span></div>
                    </div>
                     <div class="detail-section">
                        <h4>Cutting</h4>
                        <div class="detail-item"><span>SAM:</span> <span>${formatNumber(result['Cutting SAM'], 2, '', ' Min')}</span></div>
                        <div class="detail-item"><span>Rate / piece:</span> <span>${formatNumber(result['Cutting Rate'], 2, '₹')}</span></div>
                        <div class="detail-item font-bold border-t mt-1 pt-1"><span>Budget:</span> <span>${formatNumber(result['Cutting Budget'], 2, '₹')}</span></div>
                    </div>
                     <div class="detail-section">
                        <h4>Finishing</h4>
                        <div class="detail-item"><span>SAM:</span> <span>${formatNumber(result['Finishing SAM'], 2, '', ' Min')}</span></div>
                        <div class="detail-item"><span>Rate / piece:</span> <span>${formatNumber(result['Finishing Rate'], 2, '₹')}</span></div>
                        <div class="detail-item font-bold border-t mt-1 pt-1"><span>Budget:</span> <span>${formatNumber(result['Finishing Budget'], 2, '₹')}</span></div>
                    </div>
                    <div class="detail-section">
                        <h4>Overheads</h4>
                        <div class="detail-item"><span>Part-1 (1.5x):</span> <span>${formatNumber(result['Overhead Part-1'], 2, '₹')}</span></div>
                        <div class="detail-item"><span>Part-2 (1.0x):</span> <span>${formatNumber(result['Overhead Part-2'], 2, '₹')}</span></div>
                    </div>
                </div>
                <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <div class="flex justify-between items-center mb-2">
                         <h4 class="font-bold text-lg text-blue-800">Totals for ${color}</h4>
                         <div class="flex items-center gap-2">
                             <button data-action="edit-color" class="text-gray-500 hover:text-green-600 p-2 rounded-full hover:bg-green-100 transition-colors" title="Edit Color Details"><i class="fas fa-edit"></i></button>
                             <button data-action="delete-color" class="text-gray-500 hover:text-red-600 p-2 rounded-full hover:bg-red-100 transition-colors" title="Delete Color"><i class="fas fa-trash-alt"></i></button>
                             <button data-action="show-race" class="text-gray-500 hover:text-blue-600 p-2 rounded-full hover:bg-blue-100 transition-colors" title="Show Production Flow"><i class="fas fa-tachometer-alt"></i></button>
                             <button data-action="show-details" class="text-gray-500 hover:text-blue-600 p-2 rounded-full hover:bg-blue-100 transition-colors" title="Show Calculation Details"><i class="fas fa-calculator"></i></button>
                         </div>
                    </div>
                    <div class="space-y-2">
                        <div class="flex justify-between items-center"><span class="font-medium text-gray-700">Total Budget:</span><span class="font-extrabold text-xl text-blue-900">${formatNumber(result['Total Budget'], 2, '₹')}</span></div>
                        <div class="flex justify-between items-center"><span class="font-medium text-gray-700">Per-Piece Cost:</span><span class="font-extrabold text-xl text-blue-900">${formatNumber(result['Per-Piece Cost'], 2, '₹')}</span></div>
                    </div>
                </div>
            `;
            detailsContainer.innerHTML = detailsHtml;
        }
        
        function showMessage(text, type = 'success') {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.textContent = text;
            messagesDiv.className = `alert ${type === 'success' ? 'alert-success' : 'alert-danger'}`;
            messagesDiv.classList.remove('hidden');
            setTimeout(() => messagesDiv.classList.add('hidden'), 5000);
        }

        function processCalculation(style, color, order_qty, sam_stitch, sam_cut, sam_fin, processes) {
            const results = calculate(style, order_qty, sam_stitch, sam_cut, sam_fin, processes);
            results.timestamp = new Date().toISOString();
            results.color = color;

            if (!allCalculations[style]) {
                allCalculations[style] = {};
            }
            allCalculations[style][color] = results;

            if (!colorList.has(color)) {
                colorList.add(color);
                updateColorDatalist();
            }

            renderAllStyleGroups();
            saveState();
            costForm.reset();
            costForm.querySelectorAll('input, select').forEach(el => el.dispatchEvent(new Event('input')));
            showMessage(`Style ${style} - ${color} calculated and saved.`);
        }
        
        function updateActionButtonsState() {
            const hasEntries = Object.keys(allCalculations).length > 0;
            const generateReportBtn = document.getElementById('generateReportBtn');
            const deleteStylesBtn = document.getElementById('deleteStylesBtn');
            if (generateReportBtn) generateReportBtn.classList.toggle('disabled', !hasEntries);
            if (deleteStylesBtn) deleteStylesBtn.classList.toggle('disabled', !hasEntries);
        }

        function saveState() {
            localStorage.setItem('allCalcsB5', JSON.stringify(allCalculations));
            localStorage.setItem('colorListB5', JSON.stringify([...colorList]));
        }

        function loadState() {
            const savedCalcs = localStorage.getItem('allCalcsB5');
            const savedColors = localStorage.getItem('colorListB5');
            
            initializeColors();

            if (savedColors) {
                try {
                    const parsedColors = JSON.parse(savedColors);
                    if (Array.isArray(parsedColors)) {
                        parsedColors.forEach(c => colorList.add(c));
                        updateColorDatalist();
                    }
                } catch (e) {
                    console.error("Failed to load colors from localStorage", e);
                    localStorage.removeItem('colorListB5');
                }
            }
            if (savedCalcs) {
                 try {
                    const parsedCalcs = JSON.parse(savedCalcs);
                    if (typeof parsedCalcs === 'object' && parsedCalcs !== null) {
                        allCalculations = parsedCalcs;
                        renderAllStyleGroups();
                    }
                } catch (e) {
                    console.error("Failed to load calculations from localStorage", e);
                    localStorage.removeItem('allCalcsB5');
                }
            }
        }
        
        costForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const style = document.getElementById('style_no').value.trim();
            const color = document.getElementById('color_input').value.trim();
            const order_qty = parseInt(document.getElementById('order_qty').value);
            const sam_stitching = parseFloat(document.getElementById('sam_stitching').value);
            const sam_cutting = parseFloat(document.getElementById('sam_cutting').value);
            const sam_finishing = parseFloat(document.getElementById('sam_finishing').value);
            const processes = document.getElementById('process_selected_values').value;
            
            if (!style || !color || isNaN(order_qty) || isNaN(sam_stitching) || isNaN(sam_cutting) || isNaN(sam_finishing)) {
                showMessage('Please fill all fields with valid values.', 'danger');
                return;
            }
            
            if (allCalculations[style] && allCalculations[style][color]) {
                const modal = document.getElementById('existingStyleModal');
                modal.querySelector('#modalMessage').textContent = `Style "${style}" with color "${color}" already exists. What would you like to do?`;
                modal.classList.remove('hidden');
                modal.dataset.formData = JSON.stringify({ style, color, order_qty, sam_stitching, sam_cutting, sam_finishing, processes });
            } else {
                processCalculation(style, color, order_qty, sam_stitching, sam_cutting, sam_finishing, processes);
            }
        });

        document.getElementById('modalAppendQty').addEventListener('click', () => {
            const modal = document.getElementById('existingStyleModal');
            const data = JSON.parse(modal.dataset.formData);
            const existingCalc = allCalculations[data.style][data.color];
            
            const newQty = existingCalc['Order Qty'] + data.order_qty;
            
            const newResults = calculate(data.style, newQty, existingCalc['Stitching SAM'], existingCalc['Cutting SAM'], existingCalc['Finishing SAM'], existingCalc['Process']);
            newResults.timestamp = new Date().toISOString();
            newResults.color = data.color;

            allCalculations[data.style][data.color] = newResults;
            
            renderAllStyleGroups();
            saveState();
            showMessage(`Appended ${data.order_qty} to Style ${data.style} - ${data.color}. New Qty: ${newQty}.`);
            modal.classList.add('hidden');
        });

        document.getElementById('modalGoToExisting').addEventListener('click', () => {
            const modal = document.getElementById('existingStyleModal');
            const data = JSON.parse(modal.dataset.formData);
            const sortedStyleNos = Object.keys(allCalculations).sort();
            const serialIndex = sortedStyleNos.indexOf(data.style) + 1;
            const cardId = `result-group-${serialIndex}`;
            const targetElement = document.getElementById(cardId);

            if (targetElement) {
                targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                const content = targetElement.querySelector('.result-card-content');
                if (!content.classList.contains('active')) {
                    targetElement.querySelector('.result-card-header').click();
                }
                setTimeout(() => {
                    const colorTab = targetElement.querySelector(`.color-tab[data-color="${data.color}"]`);
                    if (colorTab) {
                        colorTab.click();
                    }
                }, 300);
            }
            modal.classList.add('hidden');
        });

        document.getElementById('clearInputBtn').addEventListener('click', () => {
             costForm.reset();
             costForm.querySelectorAll('.clear-input-btn').forEach(btn => btn.classList.add('hidden'));
        });

        document.querySelectorAll('.form-input-container').forEach(container => {
            const input = container.querySelector('input');
            const clearBtn = container.querySelector('.clear-input-btn');
            if(input && clearBtn) {
                input.addEventListener('input', () => {
                    clearBtn.classList.toggle('hidden', !input.value);
                });
                clearBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    input.value = '';
                    input.dispatchEvent(new Event('input'));
                    input.focus();
                });
            }
        });

        allResultsContainer.addEventListener('click', (e) => {
            const header = e.target.closest('.result-card-header');
            const card = e.target.closest('.result-card');
            const styleNo = card ? card.dataset.styleNo : null;
            const colorTab = e.target.closest('.color-tab');
            const actionButton = e.target.closest('button[data-action]');

            if (header && !e.target.closest('.checkbox-container')) {
                const content = header.nextElementSibling;
                const icon = header.querySelector('.toggle-icon');
                content.classList.toggle('active');
                icon.classList.toggle('rotated');
            }

            if (colorTab && !e.target.matches('.color-checkbox')) {
                 e.preventDefault();
                const color = colorTab.dataset.color;
                card.querySelectorAll('.color-tab').forEach(tab => tab.classList.remove('active'));
                colorTab.classList.add('active');
                renderColorDetails(card, styleNo, color);
            }

            if(actionButton && styleNo) {
                e.stopPropagation();
                const action = actionButton.dataset.action;
                const activeColor = card.querySelector('.color-tab.active').dataset.color;
                const result = allCalculations[styleNo][activeColor];
                if (action === 'show-race') {
                    startInfiniteRaceAnimation(result);
                } else if (action === 'show-details') {
                    showCalculationBreakdown(result);
                } else if (action === 'edit-color') {
                    openEditModal(styleNo, activeColor);
                } else if (action === 'delete-color') {
                    handleDeleteColor(styleNo, activeColor);
                }
            }
        });
        
        allResultsContainer.addEventListener('change', (e) => {
            const target = e.target;
            if (!allResultsContainer.classList.contains('selection-mode')) return;

            if (target.matches('.style-checkbox')) {
                const card = target.closest('.result-card');
                const isChecked = target.checked;
                card.querySelectorAll('.color-checkbox').forEach(cb => cb.checked = isChecked);
            }
            
            if (target.matches('.color-checkbox')) {
                 const card = target.closest('.result-card');
                 const allColorCheckboxes = card.querySelectorAll('.color-checkbox');
                 const checkedColors = card.querySelectorAll('.color-checkbox:checked');
                 const styleCheckbox = card.querySelector('.style-checkbox');
                 
                 if(checkedColors.length === allColorCheckboxes.length) {
                    styleCheckbox.checked = true;
                    styleCheckbox.indeterminate = false;
                 } else if (checkedColors.length > 0) {
                    styleCheckbox.indeterminate = true;
                 } else {
                    styleCheckbox.checked = false;
                    styleCheckbox.indeterminate = false;
                 }
            }
            updateActionBtnState();
        });


        function openEditModal(styleNo, color) {
            const data = allCalculations[styleNo][color];
            const modal = document.getElementById('editStyleModal');

            document.getElementById('edit_style_no').value = styleNo;
            document.getElementById('edit_original_color').value = color;
            document.getElementById('edit_color_name').value = color;
            document.getElementById('edit_order_qty').value = data['Order Qty'];
            document.getElementById('edit_sam_stitching').value = data['Stitching SAM'];
            document.getElementById('edit_sam_cutting').value = data['Cutting SAM'];
            document.getElementById('edit_sam_finishing').value = data['Finishing SAM'];
            document.getElementById('edit_process_selected_values').value = data['Process'];

            modal.classList.remove('hidden');
        }

        document.getElementById('editForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const modal = document.getElementById('editStyleModal');
            
            const styleNo = document.getElementById('edit_style_no').value;
            const originalColor = document.getElementById('edit_original_color').value;
            const newColor = document.getElementById('edit_color_name').value.trim();
            
            const order_qty = parseInt(document.getElementById('edit_order_qty').value);
            const sam_stitching = parseFloat(document.getElementById('edit_sam_stitching').value);
            const sam_cutting = parseFloat(document.getElementById('edit_sam_cutting').value);
            const sam_finishing = parseFloat(document.getElementById('edit_sam_finishing').value);
            const processes = document.getElementById('edit_process_selected_values').value;
            
            if (!newColor) {
                showMessage('Color name cannot be empty.', 'danger');
                return;
            }

            if (newColor !== originalColor && allCalculations[styleNo][newColor]) {
                showMessage(`Color "${newColor}" already exists for style "${styleNo}". Please choose a different name.`, 'danger');
                return;
            }

            const originalTimestamp = allCalculations[styleNo][originalColor].timestamp;
            const newResults = calculate(styleNo, order_qty, sam_stitching, sam_cutting, sam_finishing, processes);
            newResults.timestamp = originalTimestamp;
            newResults.color = newColor;

            if (newColor !== originalColor) {
                delete allCalculations[styleNo][originalColor];
            }
            
            allCalculations[styleNo][newColor] = newResults;

            if (!colorList.has(newColor)) {
                colorList.add(newColor);
                updateColorDatalist();
            }
            
            saveState();
            renderAllStyleGroups();
            modal.classList.add('hidden');
            showMessage(`Style ${styleNo} - ${newColor} updated successfully.`);
        });

        function handleDeleteColor(styleNo, color) {
            if (confirm(`Are you sure you want to delete the color "${color}" from style "${styleNo}"? This cannot be undone.`)) {
                delete allCalculations[styleNo][color];

                if (Object.keys(allCalculations[styleNo]).length === 0) {
                    delete allCalculations[styleNo];
                     showMessage(`Color ${color} deleted. Style ${styleNo} was removed as it had no other colors.`, 'success');
                } else {
                    showMessage(`Color ${color} from style ${styleNo} has been deleted.`);
                }

                saveState();
                renderAllStyleGroups();
            }
        }

        function startInfiniteRaceAnimation(result) {
            const modal = document.getElementById('racetrackModal');
            modal.classList.remove('hidden');

            const { 'Cutting SAM': sam_cut, 'Stitching SAM': sam_stitch, 'Finishing SAM': sam_fin } = result;
            const maxSam = Math.max(sam_cut, sam_stitch, sam_fin, 1);
            const baseLoopDuration = 5;

            const durationCut = (sam_cut / maxSam) * baseLoopDuration;
            const durationStitch = (sam_stitch / maxSam) * baseLoopDuration;
            const durationFin = (sam_fin / maxSam) * baseLoopDuration;

            const elements = {
                cutting: { cursor: document.getElementById('cuttingCursor'), progress: document.getElementById('cuttingProgress'), time: document.getElementById('cuttingTime'), sam: sam_cut, duration: durationCut },
                stitching: { cursor: document.getElementById('stitchingCursor'), progress: document.getElementById('stitchingProgress'), time: document.getElementById('stitchingTime'), sam: sam_stitch, duration: durationStitch },
                finishing: { cursor: document.getElementById('finishingCursor'), progress: document.getElementById('finishingProgress'), time: document.getElementById('finishingTime'), sam: sam_fin, duration: durationFin }
            };

            function runAnimation() {
                for (const key in elements) {
                    const el = elements[key];
                    el.time.textContent = `${el.sam.toFixed(2)} SAM`;
                    el.cursor.style.transition = 'none';
                    el.progress.style.transition = 'none';
                    el.cursor.style.left = '0%';
                    el.progress.style.transform = 'translateX(-100%)';

                    setTimeout(() => {
                        el.cursor.style.transition = `left ${el.duration}s linear`;
                        el.progress.style.transition = `transform ${el.duration}s linear`;
                        el.cursor.style.left = 'calc(100% - 40px)';
                        el.progress.style.transform = 'translateX(0%)';
                    }, 50);
                }
            }
            
            runAnimation();
            raceInterval = setInterval(runAnimation, baseLoopDuration * 1000 + 200);
        }

        document.getElementById('closeRaceModalBtn').addEventListener('click', () => {
            clearInterval(raceInterval);
            document.getElementById('racetrackModal').classList.add('hidden');
        });

        function showCalculationBreakdown(r) {
            const eff = r['Efficiency %'] / 100;
            const breakdownHtml = `
                <h3 class="text-xl font-bold mb-4 text-center">Calculation for ${r['Style No.']} - ${r.color}</h3>
                <h4>Rates per Piece</h4>
                <p><b>Stitching:</b> (${r['Stitching SAM']} Min × 1.2) / ${eff} Eff = ${formatNumber(r['Stitching Rate'], 4, '₹')}</p>
                <p><b>Cutting:</b> ${r['Cutting SAM']} Min / ${eff} Eff = ${formatNumber(r['Cutting Rate'], 4, '₹')}</p>
                <p><b>Finishing:</b> ${r['Finishing SAM']} Min / ${eff} Eff = ${formatNumber(r['Finishing Rate'], 4, '₹')}</p>
                <h4>Budgets</h4>
                <p><b>Stitching:</b> ${formatNumber(r['Stitching Rate'], 4, '₹')} × ${r['Order Qty']} Pcs = ${formatNumber(r['Stitching Budget'], 2, '₹')}</p>
                <p><b>Cutting:</b> ${formatNumber(r['Cutting Rate'], 4, '₹')} × ${r['Order Qty']} Pcs = ${formatNumber(r['Cutting Budget'], 2, '₹')}</p>
                <p><b>Finishing:</b> ${formatNumber(r['Finishing Rate'], 4, '₹')} × ${r['Order Qty']} Pcs = ${formatNumber(r['Finishing Budget'], 2, '₹')}</p>
                <h4>Overheads</h4>
                <p><b>Part-1:</b> ${r['Stitching SAM']} Min × ${r['Order Qty']} Pcs × 1.5 = ${formatNumber(r['Overhead Part-1'], 2, '₹')}</p>
                <p><b>Part-2:</b> ${r['Stitching SAM']} Min × ${r['Order Qty']} Pcs × 1.0 = ${formatNumber(r['Overhead Part-2'], 2, '₹')}</p>
                <h4>Final Costs</h4>
                <p><b>Total Budget:</b> Sum of all budgets = ${formatNumber(r['Total Budget'], 2, '₹')}</p>
                <p><b>Per-Piece Cost:</b> ${formatNumber(r['Total Budget'], 2, '₹')} / ${r['Order Qty']} Pcs = ${formatNumber(r['Per-Piece Cost'], 2, '₹')}</p>
                <p><b>CPM:</b> ${formatNumber(r['Total Budget'], 2, '₹')} / ${formatNumber(r['Plan SAM'], 2)} Min = ${formatNumber(r['CPM'], 6)}</p>
            `;
            
            const modal = document.getElementById('calculationDetailsModal');
            const contentDiv = document.getElementById('calculationDetailsContent');
            contentDiv.innerHTML = breakdownHtml;
            modal.classList.remove('hidden');

            document.getElementById('downloadCalcPdfBtn').onclick = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                html2canvas(contentDiv).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const imgProps= doc.getImageProperties(imgData);
                    const pdfWidth = doc.internal.pageSize.getWidth() - 20;
                    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                    doc.addImage(imgData, 'PNG', 10, 10, pdfWidth, pdfHeight);
                    doc.save(`Calculation_Details_${r['Style No.'].replace(/[/\\?%*:|"<>]/g, '-')}_${r.color}.pdf`);
                });
            };
        }
        
        actionsContainer.addEventListener('click', (event) => {
            const target = event.target;
            const importBtn = target.closest('#importStylesBtn');
            const generateBtn = target.closest('#generateReportBtn');
            const deleteBtn = target.closest('#deleteStylesBtn');

            if (importBtn && !importBtn.classList.contains('disabled')) {
                importFileInput.click();
            } else if (generateBtn && !generateBtn.classList.contains('disabled')) {
                const modal = document.getElementById('reportTypeModal');
                modal.classList.remove('hidden');
                document.getElementById('reportWithSummary').onclick = () => {
                    modal.classList.add('hidden');
                    enterSelectionMode('report', true);
                };
                document.getElementById('reportWithoutSummary').onclick = () => {
                    modal.classList.add('hidden');
                    enterSelectionMode('report', false);
                };
            } else if (deleteBtn && !deleteBtn.classList.contains('disabled')) {
                enterSelectionMode('delete');
            }
        });

        function enterSelectionMode(mode, includeAggregated) {
            allResultsContainer.classList.add('selection-mode');
            document.getElementById('mainActionButtons').classList.add('hidden');
            const selectionContainer = document.getElementById('selectionModeButtons');
            selectionContainer.classList.remove('hidden');
            selectionContainer.innerHTML = `
                <button id="selectAllBtn" class="btn btn-secondary"><i class="fas fa-check-double"></i>Select All</button>
                <button id="actionBtn" class="btn ${mode === 'delete' ? 'btn-danger' : 'btn-primary'}" disabled>${mode === 'delete' ? '<i class="fas fa-trash-alt"></i>Delete Selected' : '<i class="fas fa-file-alt"></i>Generate Report'}</button>
                <button id="cancelSelectionBtn" class="btn btn-secondary"><i class="fas fa-times"></i>Cancel</button>
            `;
            
            renderAllStyleGroups(true);

            document.getElementById('cancelSelectionBtn').addEventListener('click', exitSelectionMode);
            document.getElementById('selectAllBtn').addEventListener('click', () => {
                const allChecked = Array.from(allResultsContainer.querySelectorAll('.style-checkbox')).every(cb => cb.checked);
                allResultsContainer.querySelectorAll('.style-checkbox, .color-checkbox').forEach(cb => cb.checked = !allChecked);
                updateActionBtnState();
            });
            document.getElementById('actionBtn').addEventListener('click', () => {
                if (mode === 'delete') handleDeleteSelected();
                if (mode === 'report') handleReportGeneration(includeAggregated);
            });
            updateActionBtnState();
        }

        function updateActionBtnState() {
            const anyChecked = getSelectedColors().length > 0;
            const actionBtn = document.getElementById('actionBtn');
            if (actionBtn) {
               actionBtn.disabled = !anyChecked;
            }
        }
        
        function exitSelectionMode() {
            allResultsContainer.classList.remove('selection-mode');
            document.getElementById('mainActionButtons').classList.remove('hidden');
            document.getElementById('selectionModeButtons').classList.add('hidden');
            renderAllStyleGroups(false);
        }
        
        function getSelectedColors() {
             return Array.from(allResultsContainer.querySelectorAll('.color-checkbox:checked'))
                .map(cb => ({ styleNo: cb.dataset.styleNo, color: cb.dataset.color }));
        }
        
        function handleDeleteSelected() {
            const colorsToDelete = getSelectedColors();
            const modal = document.getElementById('deleteConfirmModal');
            modal.querySelector('#deleteConfirmMessage').textContent = `This will permanently delete ${colorsToDelete.length} selected color(s).`;
            modal.classList.remove('hidden');
            
            document.getElementById('confirmDeleteBtn').onclick = () => {
                const passwordInput = document.getElementById('deletePassword');
                if (passwordInput.value === DELETE_PASSWORD) {
                    colorsToDelete.forEach(({ styleNo, color }) => {
                        if (allCalculations[styleNo] && allCalculations[styleNo][color]) {
                            delete allCalculations[styleNo][color];
                            if (Object.keys(allCalculations[styleNo]).length === 0) {
                                delete allCalculations[styleNo];
                            }
                        }
                    });

                    saveState();
                    exitSelectionMode();
                    showMessage(`${colorsToDelete.length} color(s) deleted.`, 'success');
                    modal.classList.add('hidden');
                    passwordInput.value = '';
                    document.getElementById('deleteError').textContent = '';
                } else {
                    document.getElementById('deleteError').textContent = 'Incorrect password.';
                }
            };
        }
        
        function handleReportGeneration(includeAggregated) {
            const selectedColors = getSelectedColors();
            const resultsForReport = selectedColors.map(({styleNo, color}) => allCalculations[styleNo][color]);
            showReportPreview(resultsForReport, includeAggregated);
        }

        function showReportPreview(results, includeAggregated) {
            const aggregated = aggregateReportData(results);
            let previewHtml = `<h3 class="text-xl font-bold mb-4 text-center">Report Preview (${results.length} style-colors)</h3>`;
            if(includeAggregated) {
                previewHtml += `<h4 class="report-section-title">Aggregated Summary</h4>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-8 gap-y-2 text-sm">`;
                Object.entries(aggregated).forEach(([key, value]) => {
                     previewHtml += `<div class="report-summary-item"><span>${key}:</span><span class="font-semibold">${value}</span></div>`;
                });
                previewHtml += `</div>`;
            }
            previewHtml += `<h4 class="report-section-title">Detailed Breakdown</h4>
            <div class="overflow-x-auto"><table class="w-full text-sm text-left">
                <thead class="bg-gray-100"><tr>
                    <th class="p-2">Style</th><th class="p-2">Color</th><th class="p-2">Qty</th><th class="p-2">Total Budget</th><th class="p-2">P.P. Cost</th><th class="p-2">Timestamp</th>
                </tr></thead><tbody>`;
            results.forEach(r => {
                previewHtml += `<tr class="border-b">
                    <td class="p-2">${r['Style No.']}</td>
                    <td class="p-2">${r.color}</td>
                    <td class="p-2">${formatNumber(r['Order Qty'], 0)}</td>
                    <td class="p-2">${formatNumber(r['Total Budget'], 2, '₹')}</td>
                    <td class="p-2">${formatNumber(r['Per-Piece Cost'], 2, '₹')}</td>
                    <td class="p-2">${new Date(r.timestamp).toLocaleString()}</td>
                </tr>`;
            });
            previewHtml += `</tbody></table></div>`;

            const previewModal = document.getElementById('reportPreviewModal');
            document.getElementById('reportPreviewContent').innerHTML = previewHtml;
            previewModal.querySelector('#downloadReportBtn').classList.remove('hidden');
            previewModal.classList.remove('hidden');

            document.getElementById('downloadReportBtn').onclick = () => {
                generateExcelReport(results, includeAggregated);
                previewModal.classList.add('hidden');
                exitSelectionMode();
            };
        }

        function aggregateReportData(results) {
            const total = (key) => results.reduce((sum, r) => sum + (isFinite(r[key]) ? r[key] : 0), 0);
            const count = (key) => results.filter(r => isFinite(r[key])).length || 0;
            const avg = (key) => total(key) / (count(key) || 1);
            
            const avgStitchingSAM = avg('Stitching SAM');
            const avgCuttingSAM = avg('Cutting SAM');
            const avgFinishingSAM = avg('Finishing SAM');
            
            return {
                "Total Order Quantity": formatNumber(total('Order Qty'), 0),
                "Average Efficiency": formatNumber(avg('Efficiency %'), 1, '', '%'),
                "Total Stitching SAM": formatNumber(total('Stitching SAM'), 2),
                "Average Stitching SAM": formatNumber(avgStitchingSAM, 2),
                "Average Cutting SAM": formatNumber(avgCuttingSAM, 2),
                "Average Finishing SAM": formatNumber(avgFinishingSAM, 2),
                "Average Combined SAM": formatNumber(avgStitchingSAM + avgCuttingSAM + avgFinishingSAM, 2),
                "Total Planned SAM (Stitching)": formatNumber(total('Plan SAM'), 2),
                "Total Stitching Budget": formatNumber(total('Stitching Budget'), 2, '₹'),
                "Total Cutting Budget": formatNumber(total('Cutting Budget'), 2, '₹'),
                "Total Finishing Budget": formatNumber(total('Finishing Budget'), 2, '₹'),
                "Total Overhead Part-1": formatNumber(total('Overhead Part-1'), 2, '₹'),
                "Total Overhead Part-2": formatNumber(total('Overhead Part-2'), 2, '₹'),
                "Grand Total Budget": formatNumber(total('Total Budget'), 2, '₹'),
                "Average Per-Piece Cost": formatNumber(avg('Per-Piece Cost'), 2, '₹'),
            };
        }

        function generateExcelReport(results, includeAggregated) {
            const wb = XLSX.utils.book_new();
            
            if(includeAggregated) {
                const aggregatedData = aggregateReportData(results);
                const summaryData = Object.entries(aggregatedData).map(([key, value]) => [key, value.replace(/<[^>]*>/g, '')]); // Strip HTML for Excel
                const wsSummary = XLSX.utils.aoa_to_sheet([["Metric", "Value"], ...summaryData]);
                wsSummary['!cols'] = [{ wch: 30 }, { wch: 20 }];
                XLSX.utils.book_append_sheet(wb, wsSummary, "Aggregated Summary");
            }

            const headerRow2 = [
                "Style No.", "Color", "Process", "Order Qty", "Slab", "Eff%",
                "Stitching Sam", "Plan Sam", "Stitching Rate", "Stitching Budget", 
                "Cutting Sam", "Cutting Rate", "Cutting Budget", 
                "Finishing Sam", "Finishing Rate", "Finishing Budget",
                "Overhead Part-1", "Overhead Part-2", "CPM", "Per Pc Cost", "Timestamp"
            ];
            const detailedData = results.map(r => [
                r['Style No.'], r.color, r['Process'], r['Order Qty'], r['Efficiency Slab'], r['Efficiency %'],
                r['Stitching SAM'], r['Plan SAM'], r['Stitching Rate'], r['Stitching Budget'],
                r['Cutting SAM'], r['Cutting Rate'], r['Cutting Budget'],
                r['Finishing SAM'], r['Finishing Rate'], r['Finishing Budget'],
                r['Overhead Part-1'], r['Overhead Part-2'], r['CPM'], r['Per-Piece Cost'],
                new Date(r.timestamp).toLocaleString()
            ].map(cell => (typeof cell === 'number' && !isFinite(cell)) ? 'N/A' : cell));
            
            const wsDetailed = XLSX.utils.aoa_to_sheet([headerRow2, ...detailedData]);
            wsDetailed['!cols'] = headerRow2.map(h => ({wch: h.length + 5}));
            XLSX.utils.book_append_sheet(wb, wsDetailed, "Detailed Data");
            
            XLSX.writeFile(wb, `Garment_Report_${new Date().toISOString().slice(0,10)}.xlsx`);
        }
        
        importFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);

                    let importedCount = 0, skippedCount = 0;
                    jsonData.forEach(row => {
                        const style = row["Style No."];
                        const color = row["Color"];
                        const order_qty = parseInt(row["Order Qty"]);
                        const sam_stitching = parseFloat(row["Stitching Sam"]);
                        const sam_cutting = parseFloat(row["Cutting Sam"]);
                        const sam_finishing = parseFloat(row["Finishing Sam"]);
                        const processes = row["Process"] || "N/A";

                        if (!style || !color || isNaN(order_qty) || isNaN(sam_stitching) || isNaN(sam_cutting) || isNaN(sam_finishing)) {
                            skippedCount++;
                            return;
                        }

                        if (allCalculations[style] && allCalculations[style][color]) {
                            skippedCount++;
                            return;
                        }
                        
                        processCalculation(style, color, order_qty, sam_stitching, sam_cutting, sam_finishing, processes);
                        importedCount++;
                    });
                    showMessage(`Imported ${importedCount} styles. Skipped ${skippedCount} duplicate or invalid rows.`);
                } catch (error) {
                    console.error("Import Error:", error);
                    showMessage(error.message || "Failed to import file. Check format and headers.", "danger");
                } finally {
                    importFileInput.value = '';
                }
            };
            reader.readAsArrayBuffer(file);
        });

        // Search and Sort Logic
        searchBtn.addEventListener('click', () => {
            const searchTerm = searchInput.value.trim();
            if (!searchTerm) return;
            
            const foundCard = Array.from(allResultsContainer.children).find(card => card.dataset.styleNo === searchTerm);

            if (foundCard) {
                foundCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                const content = foundCard.querySelector('.result-card-content');
                if (!content.classList.contains('active')) {
                    foundCard.querySelector('.result-card-header').click();
                }
                foundCard.style.transition = 'all 0.3s ease';
                foundCard.style.boxShadow = '0 0 0 3px #4285F4';
                setTimeout(() => {
                    foundCard.style.boxShadow = '';
                }, 2000);
            } else {
                showMessage(`Style "${searchTerm}" not found.`, 'danger');
            }
        });

        sortBtn.addEventListener('click', () => {
            sortDropdown.classList.toggle('hidden');
        });

        document.addEventListener('click', (e) => {
            if (!sortBtn.contains(e.target) && !sortDropdown.contains(e.target)) {
                sortDropdown.classList.add('hidden');
            }
        });

        sortDropdown.addEventListener('click', (e) => {
            const option = e.target.closest('.sort-option');
            if (!option) return;

            const newSortBy = option.dataset.sort;
            if (sortState.by === newSortBy) {
                sortState.order = sortState.order === 'asc' ? 'desc' : 'asc';
            } else {
                sortState.by = newSortBy;
                sortState.order = 'asc';
            }
            
            updateSortUI();
            renderAllStyleGroups();
            sortDropdown.classList.add('hidden');
        });

        function updateSortUI() {
            sortDropdown.querySelectorAll('.sort-option').forEach(opt => {
                const icon = opt.querySelector('i');
                if (opt.dataset.sort === sortState.by) {
                    opt.classList.add('active');
                    icon.className = `fas ${sortState.order === 'asc' ? 'fa-sort-up' : 'fa-sort-down'}`;
                } else {
                    opt.classList.remove('active');
                    icon.className = 'fas';
                }
            });
        }

        loadState();
        updateSortUI();
    });
    </script>
</body>
</html>
